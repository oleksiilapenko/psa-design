<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHS PSA Monitoring — Prototype v2</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@knadh/oat/oat.min.css">
  <style>
    /* v2 theme: slight off-black primary */
    :root {
      --primary: #1c1c1e;
      --primary-foreground: #fafafa;
      --ring: #1c1c1e;
      /* Variance: above threshold = red, below = green (list, board, details) */
      --v2-above: #b91c1c;
      --v2-below: #15803d;
      --v2-current: #1565c0;
      --v2-current-bg: #e3f2fd;
    }

    /* v2 overrides and layout */
    .hidden { display: none !important; }
    .v2-header { position: sticky; top: 0; z-index: 30; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 1rem; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); background: var(--card); }
    .v2-header h1 { margin: 0; font-size: 1.25rem; font-weight: 600; }
    .v2-nav { display: flex; align-items: center; gap: 0.75rem; }
    .v2-view-switch { display: inline-flex; border: 1px solid var(--border); border-radius: var(--radius-medium); overflow: hidden; }
    .v2-view-switch button { margin: 0; border: none; border-radius: 0; padding: 0.35rem 0.875rem; font-size: 0.8125rem; font-weight: 600; cursor: pointer; background: var(--card); color: var(--muted-foreground); border-right: 1px solid var(--border); }
    .v2-view-switch button:last-child { border-right: none; }
    .v2-view-switch button.active { background: var(--primary); color: var(--primary-foreground); }
    .v2-view-switch button:hover:not(.active) { background: var(--muted); color: var(--foreground); }
    .v2-main { padding: 1.5rem; width: 100%; max-width: none; margin: 0; box-sizing: border-box; }
    #v2-view-list .v2-list-toolbar-row { display: flex; align-items: center; justify-content: flex-start; gap: 0.75rem; flex-wrap: wrap; margin-bottom: 0.75rem; }
    #v2-view-list #v2-list-table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-medium); }
    .v2-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; overflow-y: auto; }
    .v2-detail-backdrop .v2-detail-close-btn { position: fixed; top: 1rem; right: 1rem; z-index: 102; min-width: 2.5rem; min-height: 2.5rem; font-size: 1.5rem; font-weight: 600; line-height: 1; padding: 0.5rem; background: rgba(255,255,255,0.15); color: #fff; border: 1px solid rgba(255,255,255,0.3); border-radius: var(--radius-medium); cursor: pointer; }
    .v2-detail-backdrop .v2-detail-close-btn:hover { background: rgba(255,255,255,0.25); }
    .v2-modal { background: var(--card); border-radius: var(--radius-large); box-shadow: var(--shadow-large); max-width: 32rem; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; z-index: 101; }
    .v2-modal header { padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
    .v2-modal header h2 { margin: 0; font-size: 1.125rem; }
    .v2-modal-close-btn { min-width: 2.5rem; min-height: 2.5rem; font-size: 1.5rem; font-weight: 600; line-height: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius-medium); background: var(--card); color: var(--foreground); cursor: pointer; display: inline-flex; align-items: center; justify-content: center; }
    .v2-modal-close-btn:hover { background: var(--muted); }
    .v2-modal .v2-modal-body { padding: 1.5rem; overflow-y: auto; flex: 1; }
    .v2-modal footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 0.5rem; }
    .v2-detail-modal { max-width: 56rem; width: 100%; max-height: calc(100vh - 2rem); margin: auto; flex-shrink: 0; }
    .v2-detail-layout { display: flex; min-height: 0; flex: 1; overflow: hidden; }
    .v2-detail-sidebar { width: 18rem; flex-shrink: 0; background: var(--muted); border-right: 1px solid var(--border); padding: 1rem 1.25rem; overflow: hidden; font-size: 0.8125rem; }
    .v2-detail-sidebar-fields { display: block; }
    @media (max-width: 720px) {
      .v2-modal-backdrop { padding: 0.5rem; }
      .v2-detail-modal { max-width: 100%; max-height: calc(100vh - 1rem); }
      .v2-detail-layout { flex-direction: column; }
      .v2-detail-sidebar { width: 100%; max-height: none; border-right: none; border-bottom: 1px solid var(--border); padding: 0.875rem 1rem; }
      .v2-detail-sidebar-heading { font-size: 1rem; margin-bottom: 0.5rem; }
      .v2-detail-sidebar-fields { display: grid; grid-template-columns: 1fr 1fr; gap: 0 1rem; }
      .v2-detail-sidebar-row { grid-template-columns: 3.5rem 1fr; gap: 0.4rem; margin-bottom: 0.3rem; }
      .v2-detail-main { padding: 0.5rem 1rem; }
    }
    @media (max-width: 420px) {
      .v2-detail-sidebar-row { grid-template-columns: 3.25rem 1fr; gap: 0.35rem; }
      .v2-detail-sidebar-label { font-size: 0.65rem; }
    }
    .v2-detail-sidebar-heading { font-weight: 700; font-size: 1.125rem; line-height: 1.25; margin-bottom: 0.75rem; word-break: break-word; }
    .v2-detail-sidebar-row { display: grid; grid-template-columns: 3.75rem 1fr; gap: 0.35rem; align-items: baseline; margin-bottom: 0.35rem; line-height: 1.3; }
    .v2-detail-sidebar-row.v2-detail-sidebar-row-nhs { align-items: center; }
    .v2-detail-sidebar-row:last-child { margin-bottom: 0; }
    .v2-detail-sidebar-label { text-align: right; font-size: 0.6875rem; color: var(--muted-foreground); white-space: nowrap; }
    .v2-detail-sidebar-value { font-size: 0.8125rem; word-break: break-word; min-width: 0; }
    .v2-detail-sidebar-value-wrap { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; min-width: 0; }
    .v2-detail-sidebar-value-wrap .v2-detail-sidebar-value { flex: 1; min-width: 0; }
    .v2-detail-sidebar-copy { flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; width: 1.5rem; height: 1.5rem; padding: 0; border: 1px solid var(--border); border-radius: var(--radius-small); background: var(--card); cursor: pointer; color: var(--muted-foreground); }
    .v2-detail-sidebar-copy:hover { color: var(--foreground); }
    .v2-detail-sidebar-copy svg { width: 0.875rem; height: 0.875rem; }
    .v2-detail-main { flex: 1; min-width: 0; overflow-y: auto; padding: 0 1.25rem 0.75rem 1.25rem; }
    .v2-detail-header { position: sticky; top: 0; z-index: 2; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin: 0 -1.25rem 0.75rem -1.25rem; padding: 0.75rem 1.25rem; background: var(--card); border-bottom: 1px solid var(--border); }
    .v2-detail-next-banner { padding: 0.6rem 1rem; background: var(--v2-current-bg); border-left: 4px solid var(--v2-current); border-radius: var(--radius-small); margin: var(--space-4) 0; font-size: var(--text-7); }
    .v2-detail-schedule-view { width: 100%; font-size: var(--text-7); border-collapse: collapse; }
    .v2-detail-schedule-view th, .v2-detail-schedule-view td { padding: 0.5rem 0.75rem; text-align: left; border: 1px solid var(--border); }
    .v2-detail-schedule-view th { font-weight: 600; color: var(--muted-foreground); }
    .v2-detail-schedule-view th:nth-child(3), .v2-detail-schedule-view th:nth-child(4), .v2-detail-schedule-view td:nth-child(3), .v2-detail-schedule-view td:nth-child(4) { text-align: center; }
    .v2-detail-schedule-row-current { background: var(--v2-current-bg); border-left: 4px solid var(--v2-current); }
    .v2-detail-section-head { display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; flex-wrap: wrap; }
    .v2-detail-threshold-unit { font-size: var(--text-7); color: var(--muted-foreground); margin-left: 0.25rem; }
    .v2-detail-psa-spark { margin-bottom: 0.75rem; }
    .v2-detail-psa-chart { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-medium); padding: 0.5rem 0.75rem; margin-bottom: 0.75rem; max-width: 320px; min-width: 120px; overflow: hidden; }
    .v2-detail-psa-chart svg { display: block; width: 100%; height: auto; max-height: 96px; }
    .v2-detail-psa-chart .v2-psa-bar { fill: #bbdefb; }
    .v2-detail-psa-chart .v2-psa-bar-top { stroke: #1565c0; stroke-width: 2; }
    .v2-detail-psa-chart .v2-psa-threshold-line { stroke: #b91c1c; stroke-width: 2; }
    .v2-detail-psa-chart .v2-psa-threshold-text { fill: #b91c1c; font-size: var(--text-8); font-weight: 600; text-anchor: start; }
    .v2-detail-psa-chart .v2-psa-value-label { fill: var(--foreground); font-size: var(--text-8); font-weight: 600; text-anchor: middle; }
    .v2-card-psa-mini-chart { display: inline-block; line-height: 0; }
    .v2-card-psa-mini-chart .v2-card-mini-bar { fill: var(--primary); }
    .v2-card-psa-mini-chart .v2-card-mini-threshold { stroke: var(--v2-above); stroke-width: 2; fill: none; }
    .v2-detail-psa-table { font-size: var(--text-8); }
    .v2-detail-psa-table th, .v2-detail-psa-table td { padding: 0.35rem 0.5rem; vertical-align: middle; }
    .v2-detail-psa-table .v2-cell-num { text-align: right; font-variant-numeric: tabular-nums; }
    .v2-detail-psa-table .v2-detail-psa-edit-latest { font-size: var(--text-8); padding: 0.25rem 0.5rem; }
    .v2-detail-psa-add-form-row { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0.5rem 0.75rem; }
    .v2-detail-psa-add-form-row .v2-form-group { margin-bottom: 0; flex: 0 0 auto; min-width: 0; }
    .v2-detail-psa-add-form-row .v2-form-group label { margin-bottom: 0.2rem; }
    .v2-detail-psa-edit-row-cell { padding: 0.35rem 0.5rem; background: var(--muted); }
    .v2-detail-psa-edit-row-form { display: flex; flex-wrap: wrap; align-items: center; gap: 0.5rem 0.75rem; }
    .v2-detail-psa-edit-row-form .v2-form-group { margin-bottom: 0; flex: 0 0 auto; }
    .v2-detail-psa-edit-row-form .v2-form-group label { margin-bottom: 0.2rem; font-size: var(--text-8); }
    .v2-detail-psa-analysis { font-size: var(--text-7); }
    /* Variance colours (above=red, below=green) shared by list, board, detail */
    .v2-variance-above { color: var(--v2-above); font-weight: 700; }
    .v2-variance-below { color: var(--v2-below); font-weight: 700; }
    .v2-embedded-form { background: var(--muted); border-radius: var(--radius-medium); }
    .v2-detail-footer-actions { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .v2-detail-footer-actions button { display: inline-flex; align-items: center; gap: 0.35rem; }
    .v2-more-menu { position: relative; }
    .v2-more-dropdown { position: absolute; right: 0; bottom: 100%; margin-bottom: 0.25rem; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-small); box-shadow: var(--shadow-medium); padding: 0.25rem; min-width: 10rem; z-index: 10; color: var(--foreground); }
    .v2-more-dropdown button { display: block; width: 100%; text-align: left; padding: 0.4rem 0.5rem; border: none; background: none; cursor: pointer; font-size: var(--text-7); border-radius: var(--radius-small); color: var(--foreground); }
    .v2-more-dropdown button:hover { background: var(--muted); color: var(--foreground); }
    .v2-step { display: none; }
    .v2-step.active { display: block; }
    .v2-banner-success { padding: 0.75rem 1rem; background: color-mix(in srgb, var(--success) 15%, white); border-left: 4px solid var(--success); border-radius: var(--radius-small); margin-bottom: 1rem; font-size: var(--text-7); }
    .v2-patient-card { padding: 1rem; background: var(--muted); border-radius: var(--radius-medium); margin: 1rem 0; position: relative; }
    .v2-patient-card .v2-clear { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.875rem; }
    .v2-year-badge { display: inline-block; padding: 0.25rem 0.5rem; background: var(--v2-current-bg); color: var(--v2-current); border-radius: var(--radius-small); font-size: var(--text-8); font-weight: 600; }
    .v2-schedule-table { width: 100%; font-size: var(--text-7); }
    .v2-schedule-table th, .v2-schedule-table td { padding: 0.5rem 0.75rem; text-align: left; }
    .v2-schedule-table th { font-weight: 600; color: var(--muted-foreground); }
    /* Shared schedule-edit table: dense rows, borderless selects (draft + details inline edit) */
    .v2-schedule-edit-table { font-size: 1rem; width: 100%; border-collapse: collapse; }
    .v2-schedule-edit-table th, .v2-schedule-edit-table td { padding: 0.35rem 0.5rem; vertical-align: middle; line-height: 1.3; }
    .v2-schedule-edit-table th { padding: 0.35rem 0.5rem; font-weight: 600; color: var(--muted-foreground); text-align: left; }
    .v2-schedule-edit-table th:nth-child(3), .v2-schedule-edit-table th:nth-child(4) { text-align: center; }
    .v2-schedule-edit-table td:nth-child(3), .v2-schedule-edit-table td:nth-child(4) { text-align: center; }
    .v2-schedule-edit-table td:nth-child(5) { text-align: right; width: 1%; white-space: nowrap; }
    .v2-schedule-edit-table .v2-schedule-delete-btn { font-size: var(--text-8); padding: 0.2rem 0.4rem; }
    .v2-schedule-edit-table select { width: 100%; max-width: 9rem; padding: 0.35rem 0.4rem; padding-right: 1.5rem; margin: 0; height: 2rem; line-height: 1.25; font-size: inherit; border: none; background: transparent url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E") right 0.25rem center no-repeat; border-radius: 0; box-shadow: none; appearance: none; }
    .v2-schedule-edit-table select:hover, .v2-schedule-edit-table select:focus { background: var(--muted); outline: none; }
    .v2-draft-schedule-row-current { background: var(--v2-current-bg); }
    .v2-draft-schedule-row-current td:first-child { border-left: 4px solid var(--v2-current); box-sizing: border-box; }
    .v2-schedule-table select { width: 100%; max-width: 10rem; padding: 0.35rem 0.5rem; }
    /* Standard schedule action buttons (draft + details edit) */
    .v2-schedule-actions { display: flex; gap: var(--space-3); align-items: center; flex-wrap: wrap; margin-top: var(--space-2); }
    .v2-schedule-edit-footer { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--border); }
    .v2-discharge-banner { padding: 0.75rem 1rem; background: color-mix(in srgb, var(--warning) 18%, white); border-radius: var(--radius-medium); margin-top: 0.75rem; font-size: var(--text-7); }
    .v2-toaster { position: fixed; bottom: 1.5rem; left: 50%; transform: translateX(-50%); padding: 0.75rem 1.25rem; background: var(--success); color: white; border-radius: var(--radius-medium); font-weight: 500; box-shadow: var(--shadow-large); z-index: 1000; opacity: 0; transition: opacity 0.2s; pointer-events: none; }
    .v2-toaster.show { opacity: 1; }
    .v2-form-group { margin-bottom: 1.25rem; }
    .v2-form-group label { display: block; font-weight: 500; margin-bottom: 0.35rem; font-size: var(--text-7); }
    .v2-form-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end; }
    .v2-form-row .v2-form-group { margin-bottom: 0; flex: 1; min-width: 0; }
    .v2-link { color: var(--primary); text-decoration: underline; cursor: pointer; font-size: var(--text-7); }
    .v2-board { display: flex; gap: 0.75rem; width: 100%; min-width: 0; overflow-x: hidden; min-height: 400px; padding-bottom: 0.5rem; box-sizing: border-box; }
    .v2-column { flex: 1 1 0%; min-width: 0; background: var(--muted); border-radius: var(--radius-medium); display: flex; flex-direction: column; }
    .v2-column.v2-column-alert { background: #f5e6e9; }
    .v2-column.v2-column-alert .v2-column-header { color: #7d3c47; }
    .v2-column.v2-column-completed { background: #e8f5e9; }
    .v2-column.v2-column-completed .v2-column-header { color: #1b5e20; }
    .v2-column-header { padding: 0.5rem 0.75rem; font-weight: 700; font-size: 0.8125rem; }
    .v2-column-note { font-size: 11px; color: var(--muted-foreground); line-height: 1.45; padding: 6px 10px 8px; min-height: 2.5rem; flex-shrink: 0; }
    .v2-column-cards { padding: 0.5rem; flex: 1; min-height: 0; overflow: visible; }
    .v2-card { background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-medium); padding: 0.75rem; margin-bottom: 0.5rem; cursor: pointer; }
    .v2-card:hover { border-color: var(--primary); }
    .v2-card-nhs { font-size: var(--text-8); color: var(--muted-foreground); margin-bottom: 0.2rem; }
    .v2-card-name { font-weight: 600; margin-bottom: 0.25rem; }
    .v2-card-name .v2-card-age { color: var(--muted-foreground); font-weight: 400; font-size: 0.8125rem; }
    .v2-card-meta { font-size: var(--text-8); color: var(--muted-foreground); }
    .v2-card-pathway-row { margin-bottom: 0.35rem; padding-bottom: 0.35rem; border-bottom: 1px solid var(--border); font-size: var(--text-8); color: var(--muted-foreground); }
    .v2-card-pathway-row .v2-owner-badge { margin-right: 0.35rem; }
    .v2-card-psa-row { margin-top: 0.35rem; margin-bottom: 0.2rem; }
    .v2-card-last-updated { font-size: 0.6875rem; color: var(--muted-foreground); text-align: right; }
    .v2-card { position: relative; }
    .v2-card-actions-btn { position: absolute; top: 0.5rem; right: 0.5rem; width: 1.5rem; height: 1.5rem; padding: 0; border: none; background: none; cursor: pointer; border-radius: var(--radius-small); color: var(--muted-foreground); display: inline-flex; align-items: center; justify-content: center; }
    .v2-card-actions-btn:hover { background: var(--muted); color: var(--foreground); }
    .v2-card-actions-dropdown { position: fixed; z-index: 100; background: var(--card); border: 1px solid var(--border); border-radius: var(--radius-small); box-shadow: var(--shadow-medium); min-width: 10rem; display: none; padding: 0.25rem; color: var(--foreground); }
    .v2-card-actions-dropdown.show { display: block; }
    .v2-card-actions-dropdown button { display: block; width: 100%; text-align: left; padding: 0.4rem 0.5rem; border: none; background: none; cursor: pointer; font-size: var(--text-7); border-radius: var(--radius-small); color: var(--foreground); }
    .v2-card-actions-dropdown button:hover { background: var(--muted); color: var(--foreground); }
    .v2-card-actions-dropdown .v2-dropdown-title { padding: 0.35rem 0.5rem; font-size: 0.6875rem; font-weight: 700; color: var(--muted-foreground); text-transform: uppercase; letter-spacing: 0.04em; }
    .v2-empty { text-align: center; padding: 2rem; color: var(--muted-foreground); }

    /* Section spacing and headings */
    .v2-section { margin-top: var(--space-6); }
    .v2-section:first-of-type { margin-top: 0; }
    .v2-section-title { margin: 0 0 var(--space-2); font-size: var(--text-6); font-weight: 600; }
    .v2-section-desc { margin: 0 0 var(--space-3); font-size: var(--text-7); color: var(--muted-foreground); line-height: 1.4; }
    .v2-draft-content-wrap { padding: var(--space-4) 0 var(--space-5) 0; }
    .v2-draft-page-title { margin: 0 0 var(--space-2); font-size: 1.5rem; font-weight: 700; line-height: 1.25; }
    .v2-draft-page-desc { margin: 0 0 var(--space-5); font-size: var(--text-7); color: var(--muted-foreground); line-height: 1.4; }
    .v2-draft-footer { margin-top: var(--space-5); padding-top: var(--space-3); border-top: 1px solid var(--border); }
    .v2-draft-footer-caption { font-size: var(--text-7); color: var(--muted-foreground); margin-bottom: var(--space-2); }
    .v2-draft-add-btn { padding: 0.5rem 1.25rem; font-size: 1rem; font-weight: 600; }
    /* List view: compact, dense, one-line rows */
    .v2-list-tabs-row { display: flex; align-items: center; }
    .v2-list-bar { display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
    .v2-list-toolbar-group { display: inline-flex; align-items: center; gap: 0.35rem; }
    .v2-list-toolbar-group label { font-size: 0.75rem; color: var(--muted-foreground); white-space: nowrap; }
    .v2-list-tabs { display: flex; flex-wrap: wrap; gap: 0.35rem; align-items: center; }
    .v2-list-tab-gap { width: 1rem; flex-shrink: 0; }
    .v2-list-tabs button { padding: 0.35rem 0.75rem; border-radius: 999px; border: 1px solid var(--border); background: var(--card); color: var(--foreground); font-size: 0.8125rem; font-weight: 700; cursor: pointer; white-space: nowrap; transition: background 0.15s, border-color 0.15s, color 0.15s; display: inline-flex; align-items: center; gap: 0.35rem; }
    .v2-list-tabs button:hover { background: var(--muted); border-color: var(--border); }
    .v2-list-tabs button.active { background: var(--primary); color: var(--primary-foreground); border-color: var(--primary); }
    .v2-list-tabs button.active .v2-list-tab-count { color: rgba(255,255,255,0.9); }
    .v2-list-tab-count { font-weight: 400; color: var(--muted-foreground); font-size: 0.8125rem; }
    .v2-list-search { width: 12rem; min-width: 8rem; padding: 0.28rem 0.6rem; border-radius: 999px; border: 1px solid var(--border); font-size: 0.8125rem; }
    .v2-list-protocol-select, .v2-list-sort-select { padding: 0.28rem 0.5rem; padding-right: 2rem; border-radius: var(--radius-medium); border: 1px solid var(--border); font-size: 0.8125rem; background: var(--card); appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.4rem center; background-size: 1rem; }
    .v2-detail-main select, #v2-detail-draft-content select, .v2-modal select { appearance: none; padding-right: 2rem; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1rem; background-color: var(--card); }
    .v2-list-table-wrap { overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-medium); }
    .v2-list-table { width: 100%; min-width: 960px; font-size: 0.8125rem; line-height: 1.35; border-collapse: collapse; table-layout: auto; }
    .v2-list-table thead { background: var(--muted); }
    .v2-list-table th, .v2-list-table td { padding: 0.35rem 0.5rem; border-bottom: 1px solid var(--border); vertical-align: middle; white-space: nowrap; }
    .v2-list-table th { font-weight: 600; color: var(--muted-foreground); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.02em; }
    .v2-list-table tbody tr:last-child td { border-bottom: none; }
    .v2-list-table tbody tr:hover { background: color-mix(in srgb, var(--muted) 40%, transparent); }
    .v2-list-table .v2-cell-right { text-align: right; font-variant-numeric: tabular-nums; }
    .v2-list-table .v2-cell-num { font-variant-numeric: tabular-nums; text-align: right; }
    .v2-sparkline { width: 48px; height: 24px; display: inline-block; vertical-align: middle; }
    .v2-owner-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; line-height: 1.2; }
    .v2-owner-gp { background: #2563eb; color: white; }
    .v2-owner-uro { background: #ea580c; color: white; }
    .v2-list-group-header { border: none; background: transparent; vertical-align: middle; cursor: pointer; }
    .v2-list-group-header:hover { background: color-mix(in srgb, var(--muted) 50%, transparent); }
    .v2-list-group-header td { border-bottom: 1px solid var(--border); padding: 0.75rem 0.5rem 0.4rem; vertical-align: bottom; }
    .v2-list-group-header .v2-status-pill { display: inline-block; }
    .v2-list-group-toggle { display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.8125rem; }
    .v2-list-group-toggle input { position: absolute; opacity: 0; width: 0; height: 0; }
    .v2-list-group-toggle .v2-toggle-track { display: inline-flex; align-items: center; width: 2.25rem; height: 1.25rem; padding: 0.125rem; border-radius: 999px; background: var(--muted); border: 1px solid var(--border); cursor: pointer; transition: background 0.15s, border-color 0.15s; }
    .v2-list-group-toggle .v2-toggle-thumb { width: 1rem; height: 1rem; border-radius: 50%; background: var(--card); border: 1px solid var(--border); transition: transform 0.15s; }
    .v2-list-group-toggle input:checked + .v2-toggle-track { background: var(--primary); border-color: var(--primary); }
    .v2-list-group-toggle input:checked + .v2-toggle-track .v2-toggle-thumb { transform: translateX(1rem); background: var(--primary-foreground); border-color: var(--primary-foreground); }
    .v2-list-group-toggle input:focus-visible + .v2-toggle-track { outline: 2px solid var(--ring); outline-offset: 2px; }
    .v2-list-group-toggle label { cursor: pointer; user-select: none; color: var(--foreground); }
    /* Status pills: Recall (light blue), Upcoming (blue), Awaiting (blue), Completed (green), Review (red), Follow-up (amber), Discharged (dark grey) */
    .v2-status-pill { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; }
    .v2-status-recall { background: #bbdefb; color: #0d47a1; }
    .v2-status-upcoming { background: #e3f2fd; color: #1565c0; }
    .v2-status-awaiting { background: #e3f2fd; color: #1565c0; }
    .v2-status-completed { background: #c8e6c9; color: #1b5e20; }
    .v2-status-action { background: #fecaca; color: #b91c1c; }
    .v2-status-action_required { background: #ffe0b2; color: #e65100; }
    .v2-status-discharged { background: #e0e0e0; color: #424242; }
    .v2-card-psa-row { display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .v2-card-psa-value { font-weight: 400; font-size: 1.0625rem; color: var(--foreground); line-height: 1.2; }
    .v2-card-psa-value.v2-card-psa-value-current { font-weight: 700; }
    .v2-card-psa-value.v2-psa-above { color: var(--v2-above); }
    .v2-card-psa-threshold { font-size: var(--text-7); color: var(--muted-foreground); font-weight: 400; }
    .v2-card-psa-variance-line { font-size: var(--text-8); font-weight: 700; margin-bottom: 0.15rem; }
    .v2-card-psa-spark { flex-shrink: 0; }
    .v2-card-owner { margin-bottom: 0.25rem; }
    .v2-card-variance { font-weight: 700; margin-top: 0.25rem; }
    .v2-due-overdue { font-size: var(--text-8); font-weight: 700; color: var(--v2-above); }
    .v2-card-context { font-size: var(--text-8); margin-top: 0.25rem; color: var(--muted-foreground); }
    .v2-card-context.v2-context-alert { font-size: var(--text-8); font-weight: 700; color: var(--v2-above); }
  </style>
</head>
<body>
  <header class="v2-header">
    <h1>PSA Monitoring</h1>
    <nav class="v2-nav">
      <div class="v2-view-switch" role="group" aria-label="View">
        <button type="button" data-view="board" class="active" aria-pressed="true">Board</button>
        <button type="button" data-view="list" aria-pressed="false">List</button>
      </div>
      <button type="button" id="v2-add-patient-btn">+ Add patient</button>
    </nav>
  </header>

  <main class="v2-main">
    <div id="v2-view-dashboard">
      <div id="v2-view-board">
        <div class="v2-board" id="v2-board"></div>
        <div id="v2-card-actions-dropdown" class="v2-card-actions-dropdown" role="menu" aria-label="Card actions"></div>
      </div>
      <div id="v2-view-list" class="hidden">
        <div class="v2-list-toolbar-row">
          <div class="v2-list-tabs-row">
            <div class="v2-list-tabs" id="v2-list-tabs"></div>
          </div>
          <div class="v2-list-bar">
          <div class="v2-list-toolbar-group">
            <label for="v2-list-search">Search</label>
            <input type="search" id="v2-list-search" class="v2-list-search" placeholder="NHS# or name" aria-label="Search by NHS number or name">
          </div>
          <div class="v2-list-toolbar-group">
            <label for="v2-list-protocol">Protocol</label>
            <select id="v2-list-protocol" class="v2-list-protocol-select" aria-label="Filter by protocol">
              <option value="">All protocols</option>
            </select>
          </div>
          <div class="v2-list-toolbar-group">
            <label for="v2-list-sort">Sort by</label>
            <select id="v2-list-sort" class="v2-list-sort-select" aria-label="Sort list">
              <option value="status" selected>Status</option>
              <option value="last-updated">Last updated</option>
              <option value="due-date">Due date</option>
            </select>
          </div>
          <div class="v2-list-toolbar-group" id="v2-list-group-wrap">
            <label class="v2-list-group-toggle" for="v2-list-group-check">
              <input type="checkbox" id="v2-list-group-check" role="switch" aria-label="Group list by status" checked>
              <span class="v2-toggle-track"><span class="v2-toggle-thumb"></span></span>
              <span>Group</span>
            </label>
          </div>
        </div>
        </div>
        <div id="v2-list-table-wrap">
        <table class="v2-list-table" aria-label="Patients" id="v2-list-table">
          <colgroup>
            <col><col><col><col><col><col><col><col><col><col><col><col>
          </colgroup>
          <thead>
            <tr id="v2-list-thead-row">
              <th>NHS#</th><th>Patient</th><th class="v2-cell-right">DOB</th><th class="v2-cell-right">Age</th><th>Care</th><th>Pathway</th><th class="v2-cell-num">Last PSA</th><th class="v2-cell-num">Threshold</th><th class="v2-cell-num">Variance</th><th>Next Due</th><th>Freq.</th><th class="v2-cell-right">Updated</th>
            </tr>
          </thead>
          <tbody id="v2-list-tbody"></tbody>
        </table>
        </div>
        <p class="v2-empty" id="v2-list-empty" style="display:none;">No patients. Add a patient to get started.</p>
      </div>
    </div>
  </main>

  <!-- Detail modal (overlay on list/board) -->
  <div id="v2-detail-modal" class="hidden v2-modal-backdrop v2-detail-backdrop" role="dialog" aria-modal="true" aria-label="Patient details">
    <button type="button" class="v2-detail-close-btn" id="v2-detail-close" aria-label="Close">×</button>
    <div class="v2-modal v2-detail-modal">
      <div class="v2-modal-body" style="display:flex; flex-direction:column; min-height:0; padding:0;">
        <div class="v2-detail-layout">
          <aside class="v2-detail-sidebar" aria-label="Patient information">
            <div class="v2-detail-sidebar-row v2-detail-sidebar-row-nhs">
              <span class="v2-detail-sidebar-label">NHS#</span>
              <span class="v2-detail-sidebar-value-wrap">
                <span id="v2-detail-sidebar-nhs" class="v2-detail-sidebar-value">—</span>
                <button type="button" class="v2-detail-sidebar-copy" id="v2-detail-copy-nhs" aria-label="Copy NHS number" title="Copy NHS number"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
              </span>
            </div>
            <h2 id="v2-detail-sidebar-name" class="v2-detail-sidebar-heading">—</h2>
            <div class="v2-detail-sidebar-fields">
              <div class="v2-detail-sidebar-col">
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">DOB</span>
                  <span id="v2-detail-sidebar-dob" class="v2-detail-sidebar-value">—</span>
                </div>
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">Gender</span>
                  <span id="v2-detail-sidebar-gender" class="v2-detail-sidebar-value">—</span>
                </div>
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">Age</span>
                  <span id="v2-detail-sidebar-age" class="v2-detail-sidebar-value">—</span>
                </div>
              </div>
              <div class="v2-detail-sidebar-col">
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">Address</span>
                  <span id="v2-detail-sidebar-address" class="v2-detail-sidebar-value">—</span>
                </div>
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">Phone</span>
                  <span id="v2-detail-sidebar-phone" class="v2-detail-sidebar-value">—</span>
                </div>
                <div class="v2-detail-sidebar-row">
                  <span class="v2-detail-sidebar-label">Email</span>
                  <span id="v2-detail-sidebar-email" class="v2-detail-sidebar-value">—</span>
                </div>
              </div>
            </div>
          </aside>
          <div class="v2-detail-main">
        <div id="v2-detail-view-content">
        <div class="v2-detail-header">
          <span id="v2-detail-status" class="v2-status-pill">—</span>
          <span class="v2-section-desc" style="margin:0; font-size:0.8125rem;">Updated on <span id="v2-detail-updated">—</span></span>
        </div>

        <section class="v2-section" aria-labelledby="v2-detail-pathway-heading">
          <h3 id="v2-detail-pathway-heading" class="v2-section-title">Pathway</h3>
          <p class="v2-section-desc">Treatment pathway and care setting for this patient.</p>
          <div class="v2-form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="v2-form-group">
              <label for="v2-detail-pathway">Pathway</label>
              <select id="v2-detail-pathway"></select>
            </div>
            <div class="v2-form-group">
              <label for="v2-detail-diagnosis">Diagnosis</label>
              <select id="v2-detail-diagnosis">
                <option value="Localised prostate cancer">Localised prostate cancer</option>
                <option value="Localised">Localised</option>
                <option value="Locally advanced">Locally advanced</option>
                <option value="Localised, BPH">Localised, BPH</option>
                <option value="Prostate Ca">Prostate Ca</option>
                <option value="Metastatic prostate cancer">Metastatic prostate cancer</option>
                <option value="Recurrent prostate cancer">Recurrent prostate cancer</option>
                <option value="Raised PSA (no cancer)">Raised PSA (no cancer)</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="v2-form-group">
              <label for="v2-detail-ownership">Ownership</label>
              <select id="v2-detail-ownership">
                <option value="GP">General Practice</option>
                <option value="Urology">Urology</option>
              </select>
            </div>
            <div class="v2-form-group">
              <label for="v2-detail-anchor">Date of surgery or start of treatment</label>
              <div class="v2-form-row" style="align-items:center;">
                <input type="date" id="v2-detail-anchor" style="flex:1;">
                <span class="v2-year-badge" id="v2-detail-year-badge" style="display:none;">Year <span id="v2-detail-year-num">1</span></span>
              </div>
            </div>
          </div>
          <div id="v2-detail-pathway-actions" style="margin-top: 0.5rem; display: none;">
            <button type="button" id="v2-detail-pathway-save">Save</button>
            <button type="button" data-variant="secondary" id="v2-detail-pathway-cancel">Cancel</button>
          </div>
        </section>

        <section class="v2-section" aria-labelledby="v2-detail-schedule-heading">
          <div class="v2-detail-section-head">
            <h3 id="v2-detail-schedule-heading" class="v2-section-title">Monitoring schedule</h3>
            <button type="button" id="v2-detail-customise" data-variant="secondary">Customise</button>
          </div>
          <p class="v2-section-desc">PSA test frequency and other tests by phase. Use Customise to override the default.</p>
          <div id="v2-detail-schedule-table-wrap"></div>
          <div id="v2-detail-schedule-edit" class="hidden" style="padding: 0.75rem 1rem; border: 1px solid var(--border); border-radius: var(--radius-medium);">
            <p class="v2-section-desc" style="margin-bottom: var(--space-2);">Set the PSA test frequency for each year of monitoring. After the final year, the patient will move to review with a suggested discharge.</p>
            <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-medium);">
              <table class="v2-schedule-table v2-schedule-edit-table" id="v2-detail-schedule-edit-table" aria-label="Schedule by year">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Frequency</th>
                    <th title="Monitoring Other Test">MOT <span aria-hidden="true">ⓘ</span></th>
                    <th title="Liver function test: required alongside PSA for this year">LFT <span aria-hidden="true">ⓘ</span></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="v2-detail-schedule-edit-tbody"></tbody>
              </table>
            </div>
            <div class="v2-schedule-actions">
              <button type="button" id="v2-detail-schedule-edit-add-year" data-variant="secondary">+ Add year</button>
              <button type="button" id="v2-detail-schedule-edit-reset" data-variant="secondary"><span aria-hidden="true">↻</span> Reset schedule</button>
            </div>
            <div class="v2-discharge-banner" id="v2-detail-schedule-edit-discharge">Patient will be suggested for <strong>Discharge</strong> after the end of year <span id="v2-detail-schedule-edit-discharge-year">1</span>.</div>
            <div class="v2-schedule-edit-footer">
              <button type="button" id="v2-detail-schedule-edit-discard" data-variant="secondary">Discard changes</button>
              <button type="button" id="v2-detail-schedule-edit-update">Update schedule</button>
            </div>
          </div>
        </section>

        <section class="v2-section" aria-labelledby="v2-detail-threshold-heading">
          <h3 id="v2-detail-threshold-heading" class="v2-section-title">Threshold</h3>
          <p class="v2-section-desc">PSA at or above this value is flagged for review. Edit and save to update.</p>
          <div class="v2-form-row" style="align-items:center;">
            <input type="text" id="v2-detail-threshold" inputmode="decimal" style="width:5rem;">
            <span class="v2-detail-threshold-unit">ng/mL</span>
            <span id="v2-detail-threshold-actions" style="display: none; margin-left: 0.5rem;">
              <button type="button" id="v2-detail-threshold-save">Save</button>
              <button type="button" data-variant="secondary" id="v2-detail-threshold-cancel">Cancel</button>
            </span>
          </div>
        </section>

        <div id="v2-detail-next-banner" class="v2-detail-next-banner">—</div>

        <section class="v2-section" aria-labelledby="v2-detail-psa-heading">
          <h3 id="v2-detail-psa-heading" class="v2-section-title">PSA Results</h3>
          <p class="v2-section-desc">Recorded PSA results and trend. Add or edit the latest result below.</p>
          <div class="v2-detail-psa-spark" id="v2-detail-psa-spark"></div>
          <div id="v2-detail-psa-table-wrap"></div>
          <div style="margin-top: var(--space-2);">
            <button type="button" data-variant="secondary" id="v2-detail-add-psa">+ Add new result</button>
          </div>
          <div id="v2-detail-psa-add-form" class="hidden v2-embedded-form" style="margin-top: 0.5rem; padding: 0.75rem; border: 1px solid var(--border);">
            <h4 class="v2-section-title" style="margin: 0 0 0.5rem 0; font-size: var(--text-7);">Add new PSA</h4>
            <div class="v2-detail-psa-add-form-row">
              <div class="v2-form-group"><label>Date</label><input type="date" id="v2-detail-psa-add-date"></div>
              <div class="v2-form-group"><label>PSA (ng/mL)</label><input type="text" id="v2-detail-psa-add-value" inputmode="decimal" style="width:6rem;"></div>
              <button type="button" id="v2-detail-psa-add-submit">Add</button>
              <button type="button" data-variant="secondary" id="v2-detail-psa-add-cancel">Cancel</button>
            </div>
          </div>
        </section>

        <section class="v2-section v2-detail-actions-section" aria-labelledby="v2-detail-actions-heading" style="margin-top: var(--space-6); padding-top: var(--space-4); border-top: 1px solid var(--border);">
          <h3 id="v2-detail-actions-heading" class="v2-section-title">Actions</h3>
          <p class="v2-section-desc" style="margin-bottom: var(--space-2);">Move patient between pathway stages or discharge from monitoring.</p>
          <footer id="v2-detail-footer" class="v2-detail-footer-actions">
          </footer>
        </section>
        </div>
        <div id="v2-detail-draft-content" class="hidden v2-draft-content-wrap">
          <h2 class="v2-draft-page-title" id="v2-detail-draft-heading">Specify the pathway</h2>
          <p class="v2-draft-page-desc">Create a pathway-based monitoring plan to support ongoing follow-up and shared care. Complete the fields below then add the patient to the board.</p>
          <div class="v2-form-row" style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="v2-form-group">
              <label for="v2-draft-pathway">Pathway</label>
              <select id="v2-draft-pathway"></select>
            </div>
            <div class="v2-form-group">
              <label for="v2-draft-diagnosis">Diagnosis</label>
              <select id="v2-draft-diagnosis">
                <option value="Localised prostate cancer">Localised prostate cancer</option>
                <option value="Localised">Localised</option>
                <option value="Locally advanced">Locally advanced</option>
                <option value="Localised, BPH">Localised, BPH</option>
                <option value="Prostate Ca">Prostate Ca</option>
                <option value="Metastatic prostate cancer">Metastatic prostate cancer</option>
                <option value="Recurrent prostate cancer">Recurrent prostate cancer</option>
                <option value="Raised PSA (no cancer)">Raised PSA (no cancer)</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="v2-form-group">
              <label for="v2-draft-ownership">Ownership</label>
              <select id="v2-draft-ownership">
                <option value="GP">General Practice</option>
                <option value="Urology">Urology</option>
              </select>
            </div>
            <div class="v2-form-group">
              <label for="v2-draft-anchor-date">Date of surgery or start of the treatment.</label>
              <div class="v2-form-row" style="align-items:center;">
                <input type="date" id="v2-draft-anchor-date" style="flex:1;">
                <span class="v2-year-badge" id="v2-draft-year-badge" style="display:none;">Year <span id="v2-draft-year-num">1</span></span>
              </div>
            </div>
          </div>
          <section class="v2-section">
            <h3 class="v2-section-title">Monitoring schedule</h3>
            <p class="v2-section-desc" style="margin-bottom: var(--space-2);">Set PSA test frequency by year. After the final year the patient moves to review with suggested discharge.</p>
            <p style="margin:0 0 var(--space-2); font-size: var(--text-8);">Need to check local guideline? <a href="https://www.nhs.uk/" target="_blank" rel="noopener" class="v2-link">Dorset PSA Follow-up Protocol <span aria-hidden="true">↗</span></a></p>
            <div style="overflow-x: auto; border: 1px solid var(--border); border-radius: var(--radius-medium);">
              <table class="v2-schedule-table v2-schedule-edit-table" id="v2-draft-schedule-table" aria-label="Schedule by year">
                <thead>
                  <tr>
                    <th>Year</th>
                    <th>Frequency</th>
                    <th title="Monitoring Other Test">MOT <span aria-hidden="true">ⓘ</span></th>
                    <th title="Liver function test: required alongside PSA for this year">LFT <span aria-hidden="true">ⓘ</span></th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="v2-draft-schedule-tbody"></tbody>
              </table>
            </div>
            <div class="v2-schedule-actions">
              <button type="button" id="v2-draft-add-year" data-variant="secondary">+ Add year</button>
              <button type="button" id="v2-draft-reset-schedule" data-variant="secondary"><span aria-hidden="true">↻</span> Reset schedule</button>
            </div>
            <div class="v2-discharge-banner" id="v2-draft-discharge-banner">Patient will be suggested for <strong>Discharge</strong> after the end of year <span id="v2-draft-discharge-year">1</span>.</div>
          </section>
          <section class="v2-section">
            <h3 class="v2-section-title">Threshold</h3>
            <p class="v2-section-desc" style="margin-bottom: var(--space-2);">PSA at or above this value will be flagged for review.</p>
            <div class="v2-form-row" style="align-items:center;">
              <input type="text" id="v2-draft-threshold" value="0.03" inputmode="decimal" placeholder="0.03" style="width:5rem;">
              <span class="v2-detail-threshold-unit">ng/mL</span>
            </div>
          </section>
          <footer class="v2-draft-footer">
            <p class="v2-draft-footer-caption">This patient is not on the board yet. Add them to start monitoring.</p>
            <button type="button" id="v2-draft-add-patient-submit" class="v2-draft-add-btn">+ Add patient</button>
          </footer>
        </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="v2-toaster" class="v2-toaster hidden" role="status" aria-live="polite"></div>

  <!-- Add patient modal -->
  <div id="v2-add-modal" class="hidden v2-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="v2-modal-title">
    <div class="v2-modal">
      <header>
        <h2 id="v2-modal-title">Add patient</h2>
        <button type="button" class="v2-modal-close-btn" id="v2-modal-close" aria-label="Close">×</button>
      </header>
      <div class="v2-modal-body">
        <!-- Step 1: Find patient -->
        <div id="v2-step1" class="v2-step active">
          <h3 style="margin:0 0 var(--space-2); font-size: var(--text-6);">Enter NHS number</h3>
          <p style="margin:0 0 var(--space-3); font-size: var(--text-7); color: var(--muted-foreground);">Specify the patient's NHS number to add them to the monitoring registry.</p>
          <div class="v2-form-group">
            <label for="v2-nhs-input">NHS number</label>
            <div class="v2-form-row">
              <input type="text" id="v2-nhs-input" placeholder="000 000 0000" value="" inputmode="numeric" maxlength="14" style="flex:1; min-width:10rem;">
              <button type="button" id="v2-find-btn" disabled>Find</button>
              <button type="button" data-variant="secondary" id="v2-paste-btn">Paste</button>
            </div>
          </div>
          <div id="v2-step1-result" class="hidden">
            <div class="v2-banner-success" role="status" style="padding: 0.6rem 0.875rem; font-size: var(--text-8);">Patient found. Double-check details before you continue.</div>
            <div class="v2-patient-card" id="v2-patient-card">
              <button type="button" class="v2-clear ghost small" id="v2-patient-clear" aria-label="Clear selection">×</button>
              <div><strong>NHS</strong> <span id="v2-pas-nhs">—</span></div>
              <p style="margin:0.5rem 0 0; font-weight:600;" id="v2-pas-name">—</p>
              <p style="margin:0.25rem 0; font-size: var(--text-7); color: var(--muted-foreground);" id="v2-pas-demographics">—</p>
              <p style="margin:0.25rem 0; font-size: var(--text-7);" id="v2-pas-address">—</p>
              <p style="margin:0.25rem 0; font-size: var(--text-7);" id="v2-pas-contact">—</p>
            </div>
            <footer style="border:none; padding:0; margin-top: var(--space-3);">
              <button type="button" id="v2-step1-next">Confirm and continue →</button>
            </footer>
          </div>
        </div>
</div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@knadh/oat/oat.min.js"></script>
  <script>
(function() {
  'use strict';

  // ---------- v2 data model ----------
  var PATHWAY_OPTIONS = [
    { value: 'radical', label: 'Radical Prostatectomy' },
    { value: 'ebrt', label: 'EBRT (external beam radiotherapy)' },
    { value: 'brachytherapy', label: 'Brachytherapy' },
    { value: 'primary-adt', label: 'Primary ADT' },
    { value: 'intermittent-hormones', label: 'Intermittent hormones' },
    { value: 'watchful-waiting', label: 'Watchful waiting' },
    { value: 'active-surveillance', label: 'Active surveillance' },
    { value: 'general-psa-monitoring', label: 'General PSA monitoring' },
    { value: 'raised-psa-follow-up', label: 'Raised PSA follow-up' }
  ];

  var FREQUENCY_OPTIONS = [
    { value: '3-monthly', label: 'Every 3 months' },
    { value: '4-monthly', label: 'Every 4 months' },
    { value: '6-monthly', label: 'Every 6 months' },
    { value: 'annual', label: 'Annually' }
  ];

  // Protocol defaults: one row per year. Each protocol returns array of { yearFrom, yearTo, schedule, mot, lft }.
  function getProtocolScheduleRows(protocolKey) {
    var p = protocolKey || 'radical';
    var rows = [];
    if (p === 'radical') {
      rows = [ { y: 1, s: '4-monthly', mot: false, lft: false }, { y: 2, s: '6-monthly', mot: false, lft: false }, { y: 3, s: '6-monthly', mot: false, lft: false }, { y: 4, s: '6-monthly', mot: false, lft: false }, { y: 5, s: '6-monthly', mot: false, lft: false }, { y: 6, s: 'annual', mot: false, lft: false }, { y: 7, s: 'annual', mot: false, lft: false }, { y: 8, s: 'annual', mot: false, lft: false }, { y: 9, s: 'annual', mot: false, lft: false }, { y: 10, s: 'annual', mot: false, lft: false } ];
    } else if (p === 'ebrt' || p === 'brachytherapy') {
      for (var y = 1; y <= 5; y++) rows.push({ y: y, s: p === 'brachytherapy' && y === 1 ? '3-monthly' : '6-monthly', mot: false, lft: false });
      for (var y2 = 6; y2 <= 10; y2++) rows.push({ y: y2, s: 'annual', mot: false, lft: false });
    } else {
      for (var y3 = 1; y3 <= 10; y3++) rows.push({ y: y3, s: '6-monthly', mot: false, lft: false });
    }
    return rows.map(function(r) { return { yearFrom: r.y, yearTo: r.y, schedule: r.s, mot: r.mot, lft: r.lft }; });
  }

  function getProtocolThreshold(protocolKey) {
    var t = { radical: '0.03', ebrt: '2.0', brachytherapy: '2.0', 'primary-adt': '4.0', 'intermittent-hormones': '10.0', 'watchful-waiting': '30.0', 'active-surveillance': '15.0', 'general-psa-monitoring': '10.0', 'raised-psa-follow-up': '10.0' };
    return t[protocolKey] || '0.03';
  }

  var patients = []; // in-memory patient list (v2 source of truth)

  var PROTOCOL_NAME_TO_KEY = { 'Radical Prostatectomy': 'radical', 'EBRT': 'ebrt', 'Brachytherapy': 'brachytherapy', 'Primary ADT': 'primary-adt', 'Intermittent Hormones': 'intermittent-hormones', 'Watchful Waiting': 'watchful-waiting', 'Active Surveillance': 'active-surveillance' };
  function parseAnchorToISO(s) {
    if (!s) return null;
    var d = new Date(s);
    return isNaN(d.getTime()) ? null : d.toISOString().slice(0, 10);
  }
  function psaResultsFromLegacy(psaHistory, psaDate) {
    var history = psaHistory || [];
    if (history.length === 0) return [];
    function addMonths(isoDate, months) {
      var d = new Date(isoDate);
      d.setMonth(d.getMonth() + months);
      return d.toISOString().slice(0, 10);
    }
    return history.map(function(val, i) {
      var date = (i === history.length - 1 && psaDate) ? psaDate : (psaDate ? addMonths(psaDate, (i - (history.length - 1)) * 6) : '');
      return { date: date || '', value: typeof val === 'number' ? val : parseFloat(val) || 0 };
    });
  }
  function expandToYearlyRows(rows) {
    if (!rows || !rows.length) return [];
    var out = [];
    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      for (var y = r.yearFrom; y <= r.yearTo; y++) out.push({ yearFrom: y, yearTo: y, schedule: r.schedule, mot: r.mot || false, lft: r.lft || false });
    }
    return out;
  }

  (function seedFromV1() {
    var v1 = [
      { id: 'john-smith', name: 'Smith, John (68)', nhs: '123 456 7890', dob: '12 Apr 1956', lastUpdated: '28 Jan 2025', protocol: 'Radical Prostatectomy', anchor: '15 Dec 2024', psa: '0.02', threshold: '0.03', status: 'recall', psaHistory: [0.028,0.024,0.02], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'GP' },
      { id: 'alan-jones', name: 'Jones, Alan (72)', nhs: '987 654 3210', dob: '3 Jul 1952', lastUpdated: '5 Feb 2025', protocol: 'EBRT', anchor: '10 Sep 2024', psa: '1.1', threshold: '2.0', status: 'recall', psaHistory: [1.4,1.2,1.1], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'Urology' },
      { id: 'david-brown', name: 'Brown, David (65)', nhs: '555 111 2233', dob: '22 Jan 1959', lastUpdated: '2 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '22 Mar 2022', psa: '0.025', psaDate: '2025-02-02', threshold: '0.03', status: 'awaiting', psaHistory: [0.032,0.028,0.025], diagnoses: 'Localised', nextDue: 'Awaiting result', daysAwaiting: 5, ownership: 'GP' },
      { id: 'robert-wilson', name: 'Wilson, Robert (70)', nhs: '444 555 6677', dob: '8 Sep 1954', lastUpdated: '27 Jan 2025', protocol: 'EBRT', anchor: '8 Nov 2023', psa: '', threshold: '2.0', status: 'awaiting', psaHistory: [], diagnoses: 'Localised', nextDue: 'Awaiting result', daysAwaiting: 15, ownership: 'Urology' },
      { id: 'michael-clark', name: 'Clark, Michael (69)', nhs: '777 888 9900', dob: '19 Nov 1955', lastUpdated: '28 Jan 2025', protocol: 'Radical Prostatectomy', anchor: '20 Jan 2023', psa: '0.06', psaDate: '2025-01-28', threshold: '0.03', status: 'action', psaHistory: [0.02,0.035,0.06], diagnoses: 'Localised', nextDue: 'Review', reviewReason: 'PSA above threshold (0.06 > 0.03). Consider bounce vs biochemical recurrence.', scheduleRows: [{ yearFrom:1, yearTo:1, schedule:'4-monthly', mot:false, lft:false },{ yearFrom:2, yearTo:5, schedule:'6-monthly', mot:true, lft:false },{ yearFrom:6, yearTo:10, schedule:'annual', mot:false, lft:false }], ownership: 'Urology' },
      { id: 'george-walsh', name: 'Walsh, George (69)', nhs: '111 222 3344', dob: '18 Aug 1955', lastUpdated: '3 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '18 Jul 2022', psa: '0.01', threshold: '0.03', status: 'completed', psaHistory: [0.022,0.018,0.01], diagnoses: 'Localised', nextDue: '2025-09-15', ownership: 'GP' },
      { id: 'kevin-shaw', name: 'Shaw, Kevin (66)', nhs: '888 999 0011', dob: '14 May 1958', lastUpdated: '15 Jan 2025', protocol: 'Radical Prostatectomy', anchor: '14 Nov 2023', psa: '0.02', threshold: '0.03', status: 'recall', psaHistory: [0.026,0.023,0.02], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'Urology', scheduleByYear: { 1: '4-monthly', 2: '4-monthly' } },
      { id: 'ian-collins', name: 'Collins, Ian (64)', nhs: '200 300 4001', dob: '3 May 1960', lastUpdated: '4 Feb 2025', protocol: 'Primary ADT', anchor: '1 Apr 2023', psa: '2.5', threshold: '4.0', status: 'completed', psaHistory: [3.0,2.8,2.5], diagnoses: 'Locally advanced', nextDue: '2025-04-01', ownership: 'GP' },
      { id: 'frank-wright', name: 'Wright, Frank (76)', nhs: '400 500 6003', dob: '22 Jan 1948', lastUpdated: '5 Feb 2025', protocol: 'Watchful Waiting', anchor: '1 Jun 2023', psa: '18', threshold: '30.0', status: 'completed', psaHistory: [22,20,18], diagnoses: 'Localised', nextDue: '2025-06-01', ownership: 'GP', scheduleByYear: { 1: 'annual', 2: 'annual' } },
      { id: 'philip-hayes', name: 'Hayes, Philip (68)', nhs: '555 666 7788', dob: '10 Mar 1956', lastUpdated: '29 Jan 2025', protocol: 'EBRT', anchor: '10 May 2023', psa: '2.4', threshold: '2.0', status: 'action_required', psaHistory: [1.5,1.8,2.0,2.4], diagnoses: 'Localised', nextDue: 'Urgent Suspected Cancer', required_action: 'Urgent Suspected Cancer', ownership: 'Urology' },
      { id: 'james-taylor', name: 'Taylor, James (71)', nhs: '666 777 8899', dob: '30 Jun 1953', lastUpdated: '30 Jan 2025', protocol: 'Radical Prostatectomy', anchor: '30 Aug 2023', psa: '0.02', threshold: '0.03', status: 'recall', psaHistory: [0.05,0.03,0.02], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'GP' },
      { id: 'stephen-webb', name: 'Webb, Stephen (70)', nhs: '999 000 1122', dob: '25 Aug 1954', lastUpdated: '4 Feb 2025', protocol: 'Brachytherapy', anchor: '25 Jun 2024', psa: '0.4', threshold: '2.0', status: 'recall', psaHistory: [0.52,0.46,0.4], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'Urology' },
      { id: 'sandra-mills', name: 'Mills, Sandra (66)', nhs: '100 200 3001', dob: '4 Mar 1958', lastUpdated: '1 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '4 Sep 2022', psa: '0.02', threshold: '0.03', status: 'recall', psaHistory: [0.035,0.026,0.02], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'GP' },
      { id: 'raymond-fox', name: 'Fox, Raymond (73)', nhs: '101 201 3012', dob: '11 Jul 1951', lastUpdated: '5 Feb 2025', protocol: 'EBRT', anchor: '11 Jan 2022', psa: '1.6', threshold: '2.0', status: 'recall', psaHistory: [1.85,1.72,1.6], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'GP' },
      { id: 'peter-green', name: 'Green, Peter (67)', nhs: '222 333 4455', dob: '5 Feb 1957', lastUpdated: '5 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '15 May 2014', psa: '0.02', threshold: '0.03', status: 'discharged', psaHistory: [0.025,0.022,0.02], diagnoses: 'Localised', nextDue: 'Discharged' },
      { id: 'terence-bennett', name: 'Bennett, Terence (74)', nhs: '333 444 5566', dob: '2 Dec 1950', lastUpdated: '1 Feb 2025', protocol: 'EBRT', anchor: '2 Mar 2013', psa: '0.8', threshold: '2.0', status: 'discharged', psaHistory: [0.88,0.84,0.8], diagnoses: 'Localised, BPH', nextDue: 'Discharged' },
      { id: 'arthur-discharged', name: 'Smith, Arthur (72)', nhs: '600 700 8005', dob: '20 Apr 1952', lastUpdated: '1 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '20 May 2019', psa: '0.01', threshold: '0.03', status: 'discharged', psaHistory: [0.012,0.01], diagnoses: 'Localised', nextDue: 'Discharged' },
      { id: 'graham-hunt', name: 'Hunt, Graham (71)', nhs: '102 202 3023', dob: '8 Aug 1953', lastUpdated: '28 Jan 2025', protocol: 'Brachytherapy', anchor: '8 Feb 2018', psa: '0.2', threshold: '2.0', status: 'discharged', psaHistory: [0.32,0.26,0.2], diagnoses: 'Localised', nextDue: 'Discharged' },
      { id: 'maurice-cooper', name: 'Cooper, Maurice (69)', nhs: '103 203 3034', dob: '19 Nov 1955', lastUpdated: '3 Feb 2025', protocol: 'Watchful Waiting', anchor: '19 Jun 2020', psa: '35', threshold: '30.0', status: 'discharged', psaHistory: [30,33,35], diagnoses: 'Localised', nextDue: 'Discharged' },
      { id: 'derek-lewis', name: 'Lewis, Derek (70)', nhs: '106 206 3067', dob: '3 Jan 1954', lastUpdated: '30 Jan 2025', protocol: 'Radical Prostatectomy', anchor: '3 May 2020', psa: '0.05', threshold: '0.03', status: 'discharged', psaHistory: [0.04,0.048,0.05], diagnoses: 'Localised', nextDue: 'Discharged' },
      { id: 'nicholas-bell', name: 'Bell, Nicholas (67)', nhs: '111 333 5555', dob: '7 Nov 1957', lastUpdated: '6 Feb 2025', protocol: 'Brachytherapy', anchor: '7 Dec 2024', psa: '0.15', threshold: '2.0', status: 'recall', psaHistory: [0.22,0.18,0.15], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'Urology', scheduleByYear: { 1: '3-monthly' } },
      { id: 'david-patel', name: 'Patel, David (61)', nhs: '300 400 5002', dob: '12 Aug 1963', lastUpdated: '4 Feb 2025', protocol: 'Intermittent Hormones', anchor: '1 Sep 2024', psa: '6.0', threshold: '10.0', status: 'awaiting', psaHistory: [7.2,6.5,6.0], diagnoses: 'Prostate Ca', nextDue: 'Awaiting result', daysAwaiting: 3, ownership: 'GP' },
      { id: 'harry-nelson', name: 'Nelson, Harry (69)', nhs: '500 600 7004', dob: '14 Oct 1955', lastUpdated: '6 Feb 2025', protocol: 'Active Surveillance', anchor: '1 Nov 2024', psa: '8.2', threshold: '15.0', status: 'upcoming', psaHistory: [9.0,8.5,8.2], diagnoses: 'Localised', nextDue: '1 May 2025', ownership: 'GP', scheduleByYear: { 1: '3-monthly' } },
      { id: 'emma-reid', name: 'Reid, Emma (63)', nhs: '700 800 9012', dob: '19 May 1961', lastUpdated: '6 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '6 Nov 2024', psa: '0.018', threshold: '0.02', status: 'recall', psaHistory: [0.022,0.02,0.018], diagnoses: 'Localised', nextDue: 'Recall', scheduleByYear: { 1: '4-monthly' }, title: 'Ms.', gender: 'F' },
      { id: 'tom-bishop', name: 'Bishop, Tom (70)', nhs: '104 204 3045', dob: '22 Feb 1954', lastUpdated: '2 Feb 2025', protocol: 'Primary ADT', anchor: '22 Aug 2024', psa: '3.2', threshold: '4.0', status: 'upcoming', psaHistory: [4.0,3.5,3.2], diagnoses: 'Locally advanced', nextDue: '20 Feb 2025', ownership: 'Urology', scheduleByYear: { 1: '3-monthly' } },
      { id: 'oliver-ward', name: 'Ward, Oliver (68)', nhs: '105 205 3056', dob: '15 Sep 1956', lastUpdated: '4 Feb 2025', protocol: 'Radical Prostatectomy', anchor: '15 Jun 2021', psa: '0.025', threshold: '0.03', status: 'recall', psaHistory: [0.032,0.028,0.025], diagnoses: 'Localised', nextDue: 'Recall', ownership: 'GP' }
    ];
    var keyToLabel = {};
    PATHWAY_OPTIONS.forEach(function(o) { keyToLabel[o.value] = o.label; });
    patients = v1.map(function(d) {
      var protocolKey = PROTOCOL_NAME_TO_KEY[d.protocol] || 'radical';
      var anchorIso = parseAnchorToISO(d.anchor);
      var psaDate = d.psaDate || (anchorIso || '');
      var psaRes = (d.psaResults && d.psaResults.length) ? d.psaResults : psaResultsFromLegacy(d.psaHistory, psaDate);
      var sched = d.scheduleRows ? expandToYearlyRows(d.scheduleRows) : getProtocolScheduleRows(protocolKey);
      if (d.scheduleByYear) {
        sched = sched.map(function(r) {
          var over = d.scheduleByYear[r.yearFrom];
          return { yearFrom: r.yearFrom, yearTo: r.yearTo, schedule: over || r.schedule, mot: r.mot, lft: r.lft };
        });
      }
      return {
        id: d.id,
        nhs: d.nhs,
        name: d.name,
        dob: d.dob,
        title: d.title,
        gender: d.gender,
        pathway: protocolKey,
        pathwayLabel: d.protocol,
        diagnosis: d.diagnoses || '',
        ownership: d.ownership || 'GP',
        anchorDate: anchorIso,
        scheduleRows: sched,
        threshold: String(d.threshold || getProtocolThreshold(protocolKey)),
        psaResults: psaRes,
        status: d.status,
        lastUpdated: d.lastUpdated,
        nextDue: d.nextDue || '',
        daysAwaiting: d.daysAwaiting,
        reviewReason: d.reviewReason,
        required_action: d.required_action
      };
    });
  })();

  function getPhaseYearFromAnchor(anchorStr) {
    if (!anchorStr) return 1;
    var d = new Date(anchorStr);
    var now = new Date();
    var years = (now - d) / (365.25 * 24 * 60 * 60 * 1000);
    return Math.min(20, Math.max(1, Math.floor(years) + 1));
  }

  function collapseScheduleRows(rows) {
    if (!rows || !rows.length) return [];
    var out = [];
    var run = null;
    for (var i = 0; i < rows.length; i++) {
      var r = rows[i];
      var key = (r.schedule || '') + '|' + !!r.mot + '|' + !!r.lft;
      if (run && run.key === key) {
        run.yearTo = r.yearTo;
      } else {
        run = { yearFrom: r.yearFrom, yearTo: r.yearTo, schedule: r.schedule, mot: r.mot, lft: r.lft, key: key };
        out.push(run);
      }
    }
    return out.map(function(x) { return { yearFrom: x.yearFrom, yearTo: x.yearTo, schedule: x.schedule, mot: x.mot, lft: x.lft }; });
  }

  function scheduleToLabel(s) {
    var o = FREQUENCY_OPTIONS.filter(function(f) { return f.value === s; })[0];
    return o ? o.label : s;
  }

  function formatNextDueBanner(labelOrDate) {
    var s = (labelOrDate || '').trim();
    if (!s) return '—';
    var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    var d = null;
    var iso = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if (iso) d = new Date(parseInt(iso[1],10), parseInt(iso[2],10)-1, parseInt(iso[3],10));
    if (!d || isNaN(d.getTime())) {
      var match = s.match(/Next due\s+(\w+)\s+(\d{4})/i) || s.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/) || s.match(/(\w+)\s+(\d{4})/);
      if (match) {
        var mi = months.indexOf(match[2] || match[1]);
        if (match[3] && (mi >= 0) && match[1] && match[2]) d = new Date(parseInt(match[3],10), mi, parseInt(match[1],10));
        else if ((match[2] && mi >= 0) || (match[1] && (mi = months.indexOf(match[1])) >= 0)) d = new Date(parseInt(match[2] || match[1],10), mi >= 0 ? mi : 0, 1);
      }
    }
    if (!d || isNaN(d.getTime())) return s;
    var now = new Date();
    var diffMo = (d.getFullYear() - now.getFullYear()) * 12 + (d.getMonth() - now.getMonth());
    var dateFormatted = d.getDate() + ' ' + months[d.getMonth()] + ' ' + d.getFullYear();
    if (diffMo <= 0) return 'Next test due: ' + dateFormatted;
    if (diffMo === 1) return 'Next test due in 1 month — ' + dateFormatted;
    return 'Next test due in ' + diffMo + ' months — ' + dateFormatted;
  }

  function getNextTestDue(p) {
    if (!p) return { type: 'label', text: '—' };
    var label = (p.nextDue || '').trim();
    if (/awaiting|recall|review|discharged|urgent/i.test(label)) return { type: 'label', text: label || '—' };
    if (!p.psaResults || !p.psaResults.length || !p.anchorDate || !p.scheduleRows || !p.scheduleRows.length) return { type: 'label', text: formatNextDueBanner(label) || '—' };
    var currentYear = getPhaseYearFromAnchor(p.anchorDate);
    var row = (p.scheduleRows || []).filter(function(r) { return currentYear >= r.yearFrom && currentYear <= r.yearTo; })[0];
    if (!row) return { type: 'label', text: formatNextDueBanner(label) || '—' };
    var months = { '3-monthly': 3, '4-monthly': 4, '6-monthly': 6, 'annual': 12 }[row.schedule] || 6;
    var lastDate = p.psaResults[p.psaResults.length - 1].date;
    if (!lastDate) return { type: 'label', text: formatNextDueBanner(label) || '—' };
    var d = new Date(lastDate.replace(' ', 'T'));
    if (isNaN(d.getTime())) return { type: 'label', text: formatNextDueBanner(label) || '—' };
    d.setMonth(d.getMonth() + months);
    var now = new Date();
    var diffMo = (d.getFullYear() - now.getFullYear()) * 12 + (d.getMonth() - now.getMonth());
    var dateFormatted = d.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + ' ' + d.getFullYear();
    var text;
    if (diffMo <= 0) text = 'Next test due: ' + dateFormatted;
    else if (diffMo === 1) text = 'Next test due in 1 month — ' + dateFormatted;
    else text = 'Next test due in ' + diffMo + ' months — ' + dateFormatted;
    return { type: 'computed', text: text, dateFormatted: dateFormatted };
  }

  /** Returns a short date string for next due when computable, or null. Used for list Next Due column. */
  function getNextDueDate(p) {
    if (!p || !p.psaResults || !p.psaResults.length || !p.anchorDate || !p.scheduleRows || !p.scheduleRows.length) return null;
    var currentYear = getPhaseYearFromAnchor(p.anchorDate);
    var row = (p.scheduleRows || []).filter(function(r) { return currentYear >= r.yearFrom && currentYear <= r.yearTo; })[0];
    if (!row) return null;
    var months = { '3-monthly': 3, '4-monthly': 4, '6-monthly': 6, 'annual': 12 }[row.schedule] || 6;
    var lastDate = p.psaResults[p.psaResults.length - 1].date;
    if (!lastDate) return null;
    var d = new Date(lastDate.replace(' ', 'T'));
    if (isNaN(d.getTime())) return null;
    d.setMonth(d.getMonth() + months);
    return d.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + ' ' + d.getFullYear();
  }

  function getNextDueDateISO(p) {
    if (!p || !p.psaResults || !p.psaResults.length || !p.anchorDate || !p.scheduleRows || !p.scheduleRows.length) return null;
    var currentYear = getPhaseYearFromAnchor(p.anchorDate);
    var row = (p.scheduleRows || []).filter(function(r) { return currentYear >= r.yearFrom && currentYear <= r.yearTo; })[0];
    if (!row) return null;
    var months = { '3-monthly': 3, '4-monthly': 4, '6-monthly': 6, 'annual': 12 }[row.schedule] || 6;
    var lastDate = p.psaResults[p.psaResults.length - 1].date;
    if (!lastDate) return null;
    var d = new Date(lastDate.replace(' ', 'T'));
    if (isNaN(d.getTime())) return null;
    d.setMonth(d.getMonth() + months);
    return d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
  }

  function formatNextDueForList(p) {
    if (!p) return '—';
    var label = (p.nextDue || '').trim();
    if (/awaiting|discharged|review|urgent/i.test(label)) return label || '—';
    var dateStr = getNextDueDate(p);
    if (dateStr) return dateStr;
    return label || '—';
  }

  function formatNHS(num) {
    var n = (num || '').replace(/\D/g, '');
    if (n.length >= 10) return n.slice(0,3) + ' ' + n.slice(3,6) + ' ' + n.slice(6,10);
    return n || '';
  }

  // Mock lookup: one demo patient for any 10-digit NHS
  var MOCK_PATIENT = { nhs: '271 212 7328', name: 'Mrs. Johnson, Steven', gender: 'Female', age: 59, dob: '12 Nov 1967', address: '4517 Washington Ave. Manchester, Kentucky SN1 495', phone: '01823-212345', email: 'stevenjohnson23@cmail.com' };

  function getPatientDisplayInfo(p) {
    var name = (p.name || '').trim();
    var title = p.title || (/^Mrs\./i.test(name) ? 'Mrs.' : /^Ms\./i.test(name) ? 'Ms.' : 'Mr.');
    var displayName = name.replace(/^\s*(Mr\.|Mrs\.|Ms\.)\s*/i, '').replace(/\s*\(\d+\)\s*$/, '').trim() || '—';
    var g = (p.gender || '').toString().toUpperCase();
    var gender = (g === 'F' || g === 'M') ? g : (/^Mrs\.|^Ms\./i.test(name) ? 'F' : 'M');
    var genderLabel = gender === 'F' ? 'Female' : 'Male';
    var age = getAgeFromDob(p.dob);
    var dob = p.dob || '—';
    var ageStr = age ? age.replace(/y$/, '') : '—';
    return {
      title: title,
      displayName: displayName,
      gender: gender,
      genderLabel: genderLabel,
      age: ageStr,
      address: p.address || MOCK_PATIENT.address || '—',
      phone: p.phone || MOCK_PATIENT.phone || '—',
      email: p.email || MOCK_PATIENT.email || '—'
    };
  }

  function mockFindPatient(nhsDigits) {
    if ((nhsDigits || '').replace(/\D/g, '').length >= 10) return Object.assign({}, MOCK_PATIENT, { nhs: formatNHS(nhsDigits) || MOCK_PATIENT.nhs });
    return null;
  }

  // ---------- UI state ----------
  var addModal = document.getElementById('v2-add-modal');
  var step1 = document.getElementById('v2-step1');
  var nhsInput = document.getElementById('v2-nhs-input');
  var findBtn = document.getElementById('v2-find-btn');
  var pasteBtn = document.getElementById('v2-paste-btn');
  var step1Result = document.getElementById('v2-step1-result');
  var patientClear = document.getElementById('v2-patient-clear');
  var step1Next = document.getElementById('v2-step1-next');

  var foundPatient = null;
  var scheduleRows = [];

  function showToaster(message) {
    var el = document.getElementById('v2-toaster');
    if (!el) return;
    el.textContent = message;
    el.classList.remove('hidden');
    el.classList.add('show');
    clearTimeout(el._toasterTimer);
    el._toasterTimer = setTimeout(function() {
      el.classList.remove('show');
      setTimeout(function() { el.classList.add('hidden'); }, 200);
    }, 3000);
  }

  function updateFindButton() {
    var raw = (nhsInput.value || '').replace(/\D/g, '');
    findBtn.disabled = raw.length < 10;
  }

  nhsInput.addEventListener('input', updateFindButton);
  nhsInput.addEventListener('paste', updateFindButton);

  findBtn.addEventListener('click', function() {
    var raw = (nhsInput.value || '').replace(/\D/g, '');
    var p = mockFindPatient(raw);
    if (p) {
      foundPatient = p;
      document.getElementById('v2-pas-nhs').textContent = p.nhs;
      document.getElementById('v2-pas-name').textContent = p.name;
      document.getElementById('v2-pas-demographics').textContent = (p.gender || '') + ' ' + (p.age ? p.age + 'y' : '') + ' ' + (p.dob || '');
      document.getElementById('v2-pas-address').textContent = p.address || '—';
      document.getElementById('v2-pas-contact').textContent = (p.phone || '') + ' ' + (p.email || '');
      step1Result.classList.remove('hidden');
    }
  });

  pasteBtn.addEventListener('click', function() {
    if (navigator.clipboard && navigator.clipboard.readText) {
      navigator.clipboard.readText().then(function(t) { nhsInput.value = t; updateFindButton(); }).catch(function() {});
    }
  });

  patientClear.addEventListener('click', function() {
    foundPatient = null;
    step1Result.classList.add('hidden');
    nhsInput.focus();
  });

  step1Next.addEventListener('click', function() {
    if (!foundPatient) return;
    addModal.classList.add('hidden');
    openDetailModalForDraft(foundPatient);
  });

  function generateId() { return 'p-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9); }

  function openDetailModalForDraft(fp) {
    document.getElementById('v2-detail-view-content').classList.add('hidden');
    document.getElementById('v2-detail-draft-content').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('v2-detail-modal').classList.remove('hidden');
    var info = fp ? { displayName: fp.name || '—', genderLabel: fp.gender || '—', age: fp.age ? fp.age + 'y' : '—', address: fp.address || '—', phone: fp.phone || '—', email: fp.email || '—' } : {};
    document.getElementById('v2-detail-sidebar-nhs').textContent = fp && fp.nhs ? fp.nhs : '—';
    document.getElementById('v2-detail-copy-nhs').onclick = function() {
      var n = (fp && fp.nhs || '').replace(/\D/g, '');
      if (n && navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(n).catch(function() {});
    };
    document.getElementById('v2-detail-sidebar-name').textContent = info.displayName || '—';
    document.getElementById('v2-detail-sidebar-dob').textContent = fp && fp.dob ? fp.dob : '—';
    document.getElementById('v2-detail-sidebar-gender').textContent = info.genderLabel || '—';
    document.getElementById('v2-detail-sidebar-age').textContent = info.age || '—';
    document.getElementById('v2-detail-sidebar-address').textContent = info.address || '—';
    document.getElementById('v2-detail-sidebar-phone').textContent = info.phone || '—';
    document.getElementById('v2-detail-sidebar-email').textContent = info.email || '—';
    detailEscHandler = function(e) { if (e.key === 'Escape') closeDetailModal(); };
    document.addEventListener('keydown', detailEscHandler);

    var draftPathway = document.getElementById('v2-draft-pathway');
    var draftAnchor = document.getElementById('v2-draft-anchor-date');
    var draftYearBadge = document.getElementById('v2-draft-year-badge');
    var draftYearNum = document.getElementById('v2-draft-year-num');
    var draftTbody = document.getElementById('v2-draft-schedule-tbody');
    var draftDischargeYear = document.getElementById('v2-draft-discharge-year');
    var draftThreshold = document.getElementById('v2-draft-threshold');
    draftPathway.innerHTML = PATHWAY_OPTIONS.map(function(o) { return '<option value="' + o.value + '">' + o.label + '</option>'; }).join('');
    var protocol = draftPathway.value || 'radical';
    scheduleRows = getProtocolScheduleRows(protocol);
    draftThreshold.value = getProtocolThreshold(protocol);

    function updateDraftYearBadge() {
      var val = draftAnchor.value;
      if (!val) { draftYearBadge.style.display = 'none'; return; }
      draftYearNum.textContent = getPhaseYearFromAnchor(val);
      draftYearBadge.style.display = 'inline-block';
    }
    function updateDraftDischargeBanner() {
      var last = scheduleRows.length ? scheduleRows[scheduleRows.length - 1] : null;
      draftDischargeYear.textContent = last ? last.yearTo : '1';
    }
    function renderDraftScheduleTable() {
      var currentYear = draftAnchor.value ? getPhaseYearFromAnchor(draftAnchor.value) : 0;
      draftTbody.innerHTML = '';
      scheduleRows.forEach(function(row, idx) {
        var tr = document.createElement('tr');
        var isCurrent = currentYear >= row.yearFrom && currentYear <= row.yearTo;
        if (isCurrent) tr.classList.add('v2-draft-schedule-row-current');
        var freqOpts = FREQUENCY_OPTIONS.map(function(o) { return '<option value="' + o.value + '"' + (o.value === row.schedule ? ' selected' : '') + '>' + o.label + '</option>'; }).join('');
        var delCell = idx === scheduleRows.length - 1 && scheduleRows.length > 1 ? '<td><button type="button" class="v2-schedule-delete-btn" data-variant="secondary" data-delete-row="' + idx + '" aria-label="Delete year">Delete</button></td>' : '<td></td>';
        tr.innerHTML = '<td>' + row.yearFrom + '</td><td><select data-row="' + idx + '" data-field="schedule">' + freqOpts + '</select></td><td><input type="checkbox" data-row="' + idx + '" data-field="mot"' + (row.mot ? ' checked' : '') + ' aria-label="MOT"></td><td><input type="checkbox" data-row="' + idx + '" data-field="lft"' + (row.lft ? ' checked' : '') + ' aria-label="LFT"></td>' + delCell;
        draftTbody.appendChild(tr);
      });
      draftTbody.querySelectorAll('select[data-field="schedule"]').forEach(function(el) {
        el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (scheduleRows[i]) scheduleRows[i].schedule = el.value; });
      });
      draftTbody.querySelectorAll('input[data-field="mot"]').forEach(function(el) {
        el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (scheduleRows[i]) scheduleRows[i].mot = el.checked; });
      });
      draftTbody.querySelectorAll('input[data-field="lft"]').forEach(function(el) {
        el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (scheduleRows[i]) scheduleRows[i].lft = el.checked; });
      });
      draftTbody.querySelectorAll('[data-delete-row]').forEach(function(btn) {
        btn.addEventListener('click', function() { var i = parseInt(btn.getAttribute('data-delete-row'), 10); scheduleRows.splice(i, 1); renderDraftScheduleTable(); updateDraftDischargeBanner(); });
      });
    }
    renderDraftScheduleTable();
    updateDraftYearBadge();
    updateDraftDischargeBanner();

    draftPathway.onchange = function() {
      scheduleRows = getProtocolScheduleRows(draftPathway.value);
      draftThreshold.value = getProtocolThreshold(draftPathway.value);
      renderDraftScheduleTable();
      updateDraftDischargeBanner();
    };
    draftAnchor.onchange = function() { updateDraftYearBadge(); renderDraftScheduleTable(); };
    document.getElementById('v2-draft-add-year').onclick = function() {
      var last = scheduleRows.length ? scheduleRows[scheduleRows.length - 1] : null;
      var nextY = last ? last.yearTo + 1 : 1;
      var s = last ? last.schedule : '6-monthly';
      scheduleRows.push({ yearFrom: nextY, yearTo: nextY, schedule: s, mot: last ? last.mot : false, lft: last ? last.lft : false });
      renderDraftScheduleTable();
      updateDraftDischargeBanner();
    };
    document.getElementById('v2-draft-reset-schedule').onclick = function() {
      if (!confirm('Reset schedule to protocol default for the selected pathway?')) return;
      scheduleRows = getProtocolScheduleRows(draftPathway.value);
      renderDraftScheduleTable();
      updateDraftDischargeBanner();
    };
    document.getElementById('v2-draft-add-patient-submit').onclick = function() {
      if (!fp) return;
      var protocolLabel = PATHWAY_OPTIONS.filter(function(o) { return o.value === draftPathway.value; })[0];
      var newId = generateId();
      var p = {
        id: newId,
        nhs: fp.nhs,
        name: fp.name,
        dob: fp.dob,
        pathway: draftPathway.value,
        pathwayLabel: protocolLabel ? protocolLabel.label : draftPathway.value,
        diagnosis: document.getElementById('v2-draft-diagnosis').value,
        ownership: document.getElementById('v2-draft-ownership').value,
        anchorDate: draftAnchor.value || null,
        scheduleRows: scheduleRows.map(function(r) { return { yearFrom: r.yearFrom, yearTo: r.yearTo, schedule: r.schedule, mot: r.mot, lft: r.lft }; }),
        threshold: (draftThreshold.value || '').trim() || getProtocolThreshold(draftPathway.value),
        psaResults: [],
        status: 'recall',
        lastUpdated: new Date().toISOString().slice(0, 16).replace('T', ' ')
      };
      patients.push(p);
      showToaster('Patient has been added');
      closeDetailModal();
      foundPatient = null;
      nhsInput.value = '';
      step1Result.classList.add('hidden');
      renderBoard();
      renderList();
      window.location.hash = 'detail/' + encodeURIComponent(newId);
    };
  }

  document.getElementById('v2-add-patient-btn').addEventListener('click', function() {
    addModal.classList.remove('hidden');
    setAddStep(1);
    foundPatient = null;
    nhsInput.value = '';
    step1Result.classList.add('hidden');
    updateFindButton();
    nhsInput.focus();
  });

  document.getElementById('v2-modal-close').addEventListener('click', function() {
    addModal.classList.add('hidden');
  });

  addModal.addEventListener('click', function(e) {
    if (e.target === addModal) addModal.classList.add('hidden');
  });

  // ---------- Board ----------
  // List tabs and list grouping: all statuses
  var STATUS_COLUMNS = [
    { id: 'action', label: 'Review Required', icon: '\u26a0' },
    { id: 'action_required', label: 'Follow-up Required', icon: '\u2691' },
    { id: 'awaiting', label: 'Awaiting Result', icon: '\u29d7' },
    { id: 'recall', label: 'Recall', icon: '\u21bb' },
    { id: 'upcoming', label: 'Upcoming', icon: '\uD83D\uDCC5' },
    { id: 'completed', label: 'Completed', icon: '\u2713' },
    { id: 'discharged', label: 'Discharged', icon: '\u25a0' }
  ];
  // All list only: section order (Recall before Discharged)
  var LIST_ORDER_FOR_ALL = ['action', 'action_required', 'awaiting', 'upcoming', 'completed', 'recall', 'discharged'];
  // List tab order with subsections: All | Recall, Upcoming, Completed | Review, Follow-up | Discharged (Awaiting omitted from tabs)
  var LIST_TAB_ORDER = [
    ['recall', 'upcoming', 'completed'],
    ['action', 'action_required'],
    ['discharged']
  ];
  var listViewGrouped = true;
  var listProtocolFilter = '';
  var listSortKey = 'status';
  function getStatusCol(id) { return STATUS_COLUMNS.filter(function(c) { return c.id === id; })[0]; }
  // Board: column order; Recall and Discharged off-board. Notes match v1 — plain, clear, human.
  var BOARD_COLUMNS = [
    { id: 'upcoming', label: 'Upcoming', note: 'PSA due in the next 4 weeks. Prepare the patient for the test; when the sample is with the lab, move the card to Awaiting Results.', columnClass: '' },
    { id: 'awaiting', label: 'Awaiting Results', note: 'Sample with the lab. When the result comes back, the card moves to Completed if PSA is at or below threshold, or to Review Required if it is above.', columnClass: '' },
    { id: 'completed', label: 'Completed', note: 'Result normal. Cards stay here for 7 days so you can spot-check; after 7 days they reset and return to Recall until their next test is due.', columnClass: 'v2-column-completed' },
    { id: 'action', label: 'Review Required', note: 'PSA is above threshold. Review the trend and result, then either add a follow-up action and move to Follow-up Required.', columnClass: 'v2-column-alert' },
    { id: 'action_required', label: 'Follow-up Required', note: 'A follow-up action is in place. When it is done, move the card back to Recall.', columnClass: '' }
  ];
  function getStatusLabel(id) {
    var o = STATUS_COLUMNS.filter(function(c) { return c.id === id; })[0];
    return o ? o.label : id;
  }

  function getEffectiveSchedule(patient) {
    if (!patient.scheduleRows || !patient.scheduleRows.length) return '—';
    var anchor = patient.anchorDate;
    var year = getPhaseYearFromAnchor(anchor);
    var row = patient.scheduleRows.filter(function(r) { return year >= r.yearFrom && year <= r.yearTo; })[0];
    return row ? row.schedule : patient.scheduleRows[0].schedule;
  }

  function formatFreqShort(schedule) {
    if (!schedule) return '—';
    if (schedule.indexOf('3-monthly') !== -1) return '3 mo';
    if (schedule.indexOf('4-monthly') !== -1) return '4 mo';
    if (schedule.indexOf('6-monthly') !== -1) return '6 mo';
    if (schedule.indexOf('annual') !== -1) return '1 y';
    return schedule;
  }

  function getAgeFromDob(dobStr) {
    if (!dobStr) return '';
    var d = new Date(dobStr);
    if (isNaN(d.getTime())) return '';
    var now = new Date();
    var age = Math.floor((now - d) / (365.25 * 24 * 60 * 60 * 1000));
    return age >= 0 ? age + 'y' : '';
  }

  function parseDateFlexible(str) {
    if (!str) return null;
    var d = new Date(str);
    if (!isNaN(d.getTime())) return d;
    d = new Date(str.replace(' ', 'T'));
    return isNaN(d.getTime()) ? null : d;
  }
  function formatRelativeTime(isoOrDateStr) {
    if (!isoOrDateStr) return '—';
    var d = parseDateFlexible(isoOrDateStr);
    if (!d) return isoOrDateStr;
    var now = new Date();
    var diffMs = now - d;
    var diffDays = Math.floor(diffMs / (24 * 60 * 60 * 1000));
    var diffMonths = (now.getFullYear() - d.getFullYear()) * 12 + (now.getMonth() - d.getMonth());
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Yday';
    if (diffDays < 7 && diffDays > 0) return diffDays + ' d ago';
    if (diffDays < 30 && diffDays > 0) return Math.floor(diffDays / 7) + ' wk ago';
    if (diffMonths < 12 && diffMonths >= 0) return diffMonths + ' mo ago';
    if (diffMonths >= 12) return Math.floor(diffMonths / 12) + ' y ago';
    return isoOrDateStr;
  }

  function formatDateShort(isoOrDateStr) {
    if (!isoOrDateStr) return '—';
    var d = parseDateFlexible(isoOrDateStr);
    if (!d) return '—';
    var day = d.getDate(), mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()], year = d.getFullYear();
    return day + ' ' + mon + ' ' + year;
  }
  function formatUpdatedOn(isoOrDateStr) {
    var d = formatDateShort(isoOrDateStr);
    return d === '—' ? 'Updated on —' : 'Updated on ' + d;
  }

  function formatCardNameDisplay(name) {
    if (!name) return '—';
    var m = (name || '').match(/^(.+?)\s*\((\d+)\)\s*$/);
    if (m) return m[1].trim() + ' <span class="v2-card-age">(' + m[2] + ')</span>';
    return name;
  }
  function nameWithoutAge(name) {
    if (!name) return '—';
    var m = (name || '').match(/^(.+?)\s*\(\d+\)\s*$/);
    return m ? m[1].trim() : name;
  }

  function formatMonthYear(dateStr) {
    var d = parseDateFlexible(dateStr);
    if (!d) return '—';
    var mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()], year = d.getFullYear();
    return mon + ' ' + year;
  }
  function formatNextDueDate(nextDueStr) {
    if (!nextDueStr || /awaiting|recall|discharged|review|urgent/i.test(nextDueStr)) return nextDueStr || '—';
    var d = parseDateFlexible(nextDueStr);
    if (!d) return nextDueStr;
    var day = d.getDate(), mon = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()], year = d.getFullYear();
    return day + ' ' + mon + ' ' + year;
  }

  function formatNextDueRelative(nextDueStr) {
    if (!nextDueStr) return '—';
    if (/awaiting|recall|discharged|review|urgent/i.test(nextDueStr)) return nextDueStr;
    var d = new Date(nextDueStr.replace(' ', 'T'));
    if (isNaN(d.getTime())) return nextDueStr;
    var now = new Date();
    var diffMs = d - now;
    var diffDays = Math.ceil(diffMs / (24 * 60 * 60 * 1000));
    var diffMonths = (d.getFullYear() - now.getFullYear()) * 12 + (d.getMonth() - now.getMonth());
    if (diffDays <= 0) return 'Due';
    if (diffDays <= 31) return 'In ' + diffDays + ' d';
    if (diffMonths < 12) return 'In ' + diffMonths + ' mo';
    return 'In ' + Math.ceil(diffMonths / 12) + ' y';
  }

  var OVERDUE_DAYS_THRESHOLD = 14;
  function formatAwaitingCopy(days) {
    var n = parseInt(days, 10);
    if (isNaN(n) || n < 0) return 'Awaiting result';
    return n > OVERDUE_DAYS_THRESHOLD ? n + ' days overdue' : 'Waiting for ' + n + ' days';
  }
  function formatDueLineForCard(p) {
    if (!p) return { text: '—', isOverdue: false };
    if (p.status === 'awaiting' && p.daysAwaiting != null) {
      var copy = formatAwaitingCopy(p.daysAwaiting);
      var n = parseInt(p.daysAwaiting, 10);
      return { text: copy, isOverdue: !isNaN(n) && n > OVERDUE_DAYS_THRESHOLD };
    }
    return { text: formatNextDueRelative(p.nextDue), isOverdue: false };
  }

  function sparklineSVG(values, thresholdNum, width, height) {
    if (!values || values.length === 0) return '';
    var w = width || 48, h = height || 24;
    var min = Math.min.apply(null, values), max = Math.max.apply(null, values);
    if (max === min) max = min + 0.01;
    var scaleY = function(v) { return h - 2 - ((v - min) / (max - min)) * (h - 4); };
    var pts = values.map(function(v, i) { var x = 2 + (i / (values.length - 1 || 1)) * (w - 4); return x.toFixed(1) + ',' + scaleY(v).toFixed(1); }).join(' ');
    var threshY = (thresholdNum != null && thresholdNum >= min && thresholdNum <= max) ? scaleY(thresholdNum).toFixed(1) : null;
    var path = '<path fill="none" stroke="var(--primary)" stroke-width="1" d="M' + pts.replace(/\s/g,' L') + '"/>';
    var line = threshY != null ? '<line x1="2" y1="' + threshY + '" x2="' + (w - 2) + '" y2="' + threshY + '" stroke="var(--v2-above)" stroke-width="1" stroke-dasharray="2"/>' : '';
    return '<svg class="v2-sparkline" viewBox="0 0 ' + w + ' ' + h + '" width="' + w + '" height="' + h + '">' + line + path + '</svg>';
  }

  function psaMiniBarChartSVG(values, thresholdNum, width, height) {
    if (!values || values.length === 0) return '';
    var maxBars = 7;
    var slice = values.length > maxBars ? values.slice(-maxBars) : values;
    var n = slice.length;
    if (n === 0) return '';
    var w = width || 56, h = height || 24;
    var pad = { left: 2, right: 2, top: 2, bottom: 2 };
    var barW = 6, gap = 1;
    var chartW = n * barW + (n - 1) * gap;
    var chartH = h - pad.top - pad.bottom;
    var yMax = Math.max.apply(null, slice);
    if (thresholdNum != null && !isNaN(thresholdNum)) yMax = Math.max(yMax, thresholdNum);
    if (yMax <= 0) yMax = 0.01;
    yMax = yMax * 1.05;
    var scaleY = function(v) { return pad.top + chartH - (v / yMax) * chartH; };
    var bars = [];
    for (var i = 0; i < n; i++) {
      var v = slice[i];
      var x = pad.left + i * (barW + gap);
      var y = scaleY(v);
      var barH = scaleY(0) - y;
      if (barH > 0) {
        bars.push('<rect class="v2-card-mini-bar" x="' + x.toFixed(1) + '" y="' + y.toFixed(1) + '" width="' + barW + '" height="' + barH.toFixed(1) + '"/>');
      }
    }
    var threshHtml = '';
    if (thresholdNum != null && !isNaN(thresholdNum) && thresholdNum >= 0) {
      var ty = Math.max(pad.top, Math.min(pad.top + chartH, scaleY(thresholdNum)));
      threshHtml = '<line class="v2-card-mini-threshold" x1="' + pad.left + '" y1="' + ty.toFixed(1) + '" x2="' + (pad.left + chartW).toFixed(1) + '" y2="' + ty.toFixed(1) + '"/>';
    }
    return '<svg class="v2-card-psa-mini-chart" viewBox="0 0 ' + w + ' ' + h + '" width="' + w + '" height="' + h + '" aria-hidden="true">' + bars.join('') + threshHtml + '</svg>';
  }

  function formatPsaChartLabel(val) {
    var n = parseFloat(val);
    if (isNaN(n)) return '—';
    if (n >= 10 || n <= -10) return n.toFixed(1);
    if (n >= 1 || n <= -1) return n.toFixed(2);
    return n.toFixed(3);
  }

  function psaBarChartSVG(values, thresholdNum, width, height) {
    if (!values || values.length === 0) return '';
    var minBarW = 36;
    var gap = 4;
    var pad = { left: 6, right: 44, top: 14, bottom: 14 };
    var n = values.length;
    var chartW = n * minBarW + (n - 1) * gap;
    var w = pad.left + chartW + pad.right;
    var h = height || 88;
    var chartH = h - pad.top - pad.bottom;
    var barW = minBarW;
    var yMax = Math.max.apply(null, values);
    if (thresholdNum != null && !isNaN(thresholdNum)) yMax = Math.max(yMax, thresholdNum);
    if (yMax <= 0) yMax = 0.01;
    yMax = yMax * 1.12;
    var scaleY = function(v) { return pad.top + chartH - (v / yMax) * chartH; };
    var bars = [];
    var labels = [];
    for (var i = 0; i < n; i++) {
      var v = values[i];
      var x = pad.left + i * (barW + gap);
      var y = scaleY(v);
      var barH = scaleY(0) - y;
      if (barH > 0) {
        bars.push('<rect class="v2-psa-bar" x="' + x.toFixed(1) + '" y="' + y.toFixed(1) + '" width="' + barW.toFixed(1) + '" height="' + barH.toFixed(1) + '"/>');
        bars.push('<line class="v2-psa-bar-top" x1="' + x.toFixed(1) + '" y1="' + y.toFixed(1) + '" x2="' + (x + barW).toFixed(1) + '" y2="' + y.toFixed(1) + '"/>');
      }
      labels.push('<text class="v2-psa-value-label" x="' + (x + barW / 2).toFixed(1) + '" y="' + (y - 4).toFixed(1) + '">' + formatPsaChartLabel(v) + '</text>');
    }
    var threshHtml = '';
    if (thresholdNum != null && !isNaN(thresholdNum) && thresholdNum >= 0) {
      var ty = Math.max(pad.top, Math.min(pad.top + chartH, scaleY(thresholdNum)));
      threshHtml = '<line class="v2-psa-threshold-line" x1="' + pad.left + '" y1="' + ty.toFixed(1) + '" x2="' + (pad.left + chartW).toFixed(1) + '" y2="' + ty.toFixed(1) + '"/>';
      threshHtml += '<text class="v2-psa-threshold-text" x="' + (pad.left + chartW + 6).toFixed(1) + '" y="' + (ty + 3).toFixed(1) + '">' + formatPsaChartLabel(thresholdNum) + '</text>';
    }
    return '<svg viewBox="0 0 ' + w + ' ' + h + '" preserveAspectRatio="xMinYMid meet" class="v2-detail-psa-chart-svg">' + bars.join('') + labels.join('') + threshHtml + '</svg>';
  }

  var listStatusFilter = '';

  function formatPsaCell(val) {
    if (val === '?' || val === '—' || val === null || val === undefined) return val === '?' ? '?' : '—';
    var n = parseFloat(val);
    if (isNaN(n)) return '—';
    if (n >= 10 || n <= -10) return n.toFixed(1);
    if (n >= 1 || n <= -1) return n.toFixed(2);
    return n.toFixed(3);
  }

  function renderListRow(p, threshNum, showStatusColumn) {
    var lastPsaRaw = (p.psaResults && p.psaResults.length) ? p.psaResults[p.psaResults.length - 1].value : (p.status === 'awaiting' ? '?' : null);
    var lastPsa = lastPsaRaw === '?' ? '?' : formatPsaCell(lastPsaRaw);
    var lastPsaNum = (p.psaResults && p.psaResults.length) ? parseFloat(p.psaResults[p.psaResults.length - 1].value) : null;
    var thr = threshNum(p);
    var varianceHtml = '—';
    if (p.status !== 'upcoming' && p.status !== 'awaiting' && lastPsaNum != null && thr != null) {
      var diff = lastPsaNum - thr;
      if (diff !== 0) {
        var vClass = diff > 0 ? 'v2-variance-above' : 'v2-variance-below';
        varianceHtml = '<span class="' + vClass + '">' + Math.abs(diff).toFixed(3) + (diff > 0 ? ' \u2191' : ' \u2193') + '</span>';
      }
    }
    var ownerClass = (p.ownership || 'GP') === 'Urology' ? 'v2-owner-uro' : 'v2-owner-gp';
    var ownerLabel = (p.ownership || 'GP') === 'Urology' ? 'URO' : 'GP';
    var ageStr = getAgeFromDob(p.dob);
    var ageDisplay = ageStr ? ageStr.replace(/y$/, '') : '—';
    var thresholdCell = p.threshold ? formatPsaCell(p.threshold) : '—';
    var statusCell = showStatusColumn ? '<td><span class="v2-status-pill v2-status-' + (p.status || '') + '">' + getStatusLabel(p.status) + '</span></td>' : '';
    var tr = document.createElement('tr');
    tr.setAttribute('data-patient-id', p.id);
    tr.style.cursor = 'pointer';
    tr.innerHTML = '<td>' + (p.nhs || '—') + '</td>' + statusCell + '<td><strong>' + nameWithoutAge(p.name) + '</strong></td><td class="v2-cell-right">' + (p.dob || '—') + '</td><td class="v2-cell-right">' + ageDisplay + '</td><td><span class="v2-owner-badge ' + ownerClass + '">' + ownerLabel + '</span></td><td>' + (p.pathwayLabel || p.pathway) + '</td><td class="v2-cell-num">' + lastPsa + '</td><td class="v2-cell-num">' + thresholdCell + '</td><td class="v2-cell-num">' + varianceHtml + '</td><td>' + formatNextDueForList(p) + '</td><td>' + formatFreqShort(getEffectiveSchedule(p)) + '</td><td class="v2-cell-right">' + formatRelativeTime(p.lastUpdated) + '</td>';
    return tr;
  }

  function renderList() {
    var tabsEl = document.getElementById('v2-list-tabs');
    var tbody = document.getElementById('v2-list-tbody');
    var emptyEl = document.getElementById('v2-list-empty');
    var searchInput = document.getElementById('v2-list-search');
    if (!tbody) return;
    var searchRaw = (searchInput && searchInput.value) ? searchInput.value.trim() : '';
    var searchTerm = searchRaw.replace(/\D/g, '');
    var searchName = searchRaw.toLowerCase();
    if (tabsEl) {
      tabsEl.innerHTML = '';
      var allBtn = document.createElement('button');
      allBtn.innerHTML = 'All <span class="v2-list-tab-count">' + patients.length + '</span>';
      allBtn.classList.toggle('active', listStatusFilter === '');
      allBtn.addEventListener('click', function() { listStatusFilter = ''; renderList(); });
      tabsEl.appendChild(allBtn);
      function addGap() {
        var gap = document.createElement('span');
        gap.className = 'v2-list-tab-gap';
        gap.setAttribute('aria-hidden', 'true');
        tabsEl.appendChild(gap);
      }
      LIST_TAB_ORDER.forEach(function(group, idx) {
        addGap();
        group.forEach(function(statusId) {
          var col = getStatusCol(statusId);
          if (!col) return;
          var count = patients.filter(function(p) { return p.status === col.id; }).length;
          var btn = document.createElement('button');
          btn.innerHTML = col.label + ' <span class="v2-list-tab-count">' + count + '</span>';
          btn.classList.toggle('active', listStatusFilter === col.id);
          btn.addEventListener('click', function() { listStatusFilter = col.id; renderList(); });
          tabsEl.appendChild(btn);
        });
      });
    }
    tbody.innerHTML = '';
    var filtered = listStatusFilter ? patients.filter(function(p) { return p.status === listStatusFilter; }) : patients;
    if (listProtocolFilter) filtered = filtered.filter(function(p) { return p.pathway === listProtocolFilter; });
    if (searchRaw.length >= 1) filtered = filtered.filter(function(p) {
      var nhsMatch = searchTerm.length >= 1 && (p.nhs || '').replace(/\D/g, '').indexOf(searchTerm) !== -1;
      var nameMatch = (p.name || '').toLowerCase().indexOf(searchName) !== -1;
      return nhsMatch || nameMatch;
    });
    if (filtered.length === 0) {
      emptyEl.style.display = 'block';
      document.getElementById('v2-list-table-wrap').style.display = 'none';
      return;
    }
    emptyEl.style.display = 'none';
    document.getElementById('v2-list-table-wrap').style.display = 'block';
    var groupWrap = document.getElementById('v2-list-group-wrap');
    if (groupWrap) groupWrap.style.display = listStatusFilter === '' ? '' : 'none';
    var threshNum = function(p) { var t = parseFloat(p.threshold); return isNaN(t) ? null : t; };
    var showStatusColumn = listStatusFilter === '' && !listViewGrouped;
    var theadRow = document.getElementById('v2-list-thead-row');
    var colgroup = document.getElementById('v2-list-table').querySelector('colgroup');
    if (theadRow) {
      if (showStatusColumn) {
        theadRow.innerHTML = '<th>NHS#</th><th>Status</th><th>Patient</th><th class="v2-cell-right">DOB</th><th class="v2-cell-right">Age</th><th>Care</th><th>Pathway</th><th class="v2-cell-num">Last PSA</th><th class="v2-cell-num">Threshold</th><th class="v2-cell-num">Variance</th><th>Next Due</th><th>Freq.</th><th class="v2-cell-right">Updated</th>';
        if (colgroup) colgroup.innerHTML = '<col><col><col><col><col><col><col><col><col><col><col><col><col>';
      } else {
        theadRow.innerHTML = '<th>NHS#</th><th>Patient</th><th class="v2-cell-right">DOB</th><th class="v2-cell-right">Age</th><th>Care</th><th>Pathway</th><th class="v2-cell-num">Last PSA</th><th class="v2-cell-num">Threshold</th><th class="v2-cell-num">Variance</th><th>Next Due</th><th>Freq.</th><th class="v2-cell-right">Updated</th>';
        if (colgroup) colgroup.innerHTML = '<col><col><col><col><col><col><col><col><col><col><col><col>';
      }
    }
    var useGrouping = listViewGrouped && listStatusFilter === '';
    if (useGrouping) {
      LIST_ORDER_FOR_ALL.forEach(function(statusId) {
        var col = getStatusCol(statusId);
        if (!col) return;
        var inGroup = filtered.filter(function(p) { return p.status === col.id; });
        if (inGroup.length === 0) return;
        var headerRow = document.createElement('tr');
        headerRow.className = 'v2-list-group-header';
        headerRow.setAttribute('data-status-filter', col.id);
        headerRow.innerHTML = '<td colspan="' + (showStatusColumn ? 13 : 12) + '"><span class="v2-status-pill v2-status-' + col.id + '">' + col.label + '</span></td>';
        tbody.appendChild(headerRow);
        inGroup.forEach(function(p) {
          tbody.appendChild(renderListRow(p, threshNum, false));
        });
      });
    } else {
      var ordered = listStatusFilter ? filtered.slice() : LIST_ORDER_FOR_ALL.reduce(function(acc, statusId) {
        filtered.filter(function(p) { return p.status === statusId; }).forEach(function(p) { acc.push(p); });
        return acc;
      }, []);
      if (listSortKey === 'last-updated') {
        ordered.sort(function(a, b) {
          var va = (a.lastUpdated || '').replace(' ', 'T') || '9999-12-31';
          var vb = (b.lastUpdated || '').replace(' ', 'T') || '9999-12-31';
          return vb.localeCompare(va);
        });
      } else if (listSortKey === 'due-date') {
        ordered.sort(function(a, b) {
          var va = getNextDueDateISO(a) || '9999-12-31';
          var vb = getNextDueDateISO(b) || '9999-12-31';
          return va.localeCompare(vb);
        });
      }
      ordered.forEach(function(p) {
        tbody.appendChild(renderListRow(p, threshNum, showStatusColumn));
      });
    }
    tbody.querySelectorAll('tr[data-patient-id]').forEach(function(tr) {
      tr.addEventListener('click', function() {
        var id = tr.getAttribute('data-patient-id');
        if (id) window.location.hash = 'detail/' + id;
      });
    });
    tbody.querySelectorAll('.v2-list-group-header').forEach(function(tr) {
      tr.addEventListener('click', function() {
        var statusId = tr.getAttribute('data-status-filter');
        if (statusId) { listStatusFilter = statusId; renderList(); }
      });
    });
  }

  function formatFollowUpReasonDisplay(requiredAction) {
    var s = (requiredAction || '').trim();
    if (/urgent\s*suspected\s*cancer|usc/i.test(s)) return 'Urgent Suspected Cancer';
    return s || 'Follow-up required';
  }
  function buildBoardCardDynamicBlock(p, thr, lastPsaNum, lastPsaDisplay, dueLine, vals) {
    var status = p.status;
    var thresholdStr = p.threshold || '—';
    var trendHtml = vals.length ? psaMiniBarChartSVG(vals, isNaN(thr) ? null : thr, 56, 24) : '';
    var dueClass = dueLine.isOverdue ? ' v2-due-overdue' : '';
    var psaAbove = lastPsaNum != null && !isNaN(thr) && lastPsaNum > thr;
    var psaAtOrBelow = lastPsaNum != null && !isNaN(thr) && lastPsaNum <= thr;
    var boldValue = status === 'completed' || status === 'action' || status === 'action_required';
    function psaRow(highlightCurrent) {
      var tick = (status !== 'awaiting' && psaAtOrBelow) ? ' \u2713' : '';
      var sparkFirst = trendHtml ? '<span class="v2-card-psa-spark">' + trendHtml + '</span>' : '';
      var valueClass = 'v2-card-psa-value' + (highlightCurrent ? ' v2-card-psa-value-current' : '');
      return '<div class="v2-card-psa-row">' + sparkFirst + '<span class="' + valueClass + '">' + lastPsaDisplay + '</span><span class="v2-card-psa-threshold">/ ' + thresholdStr + tick + '</span></div>';
    }
    var varianceLineHtml = '';
    if (status === 'action' && lastPsaNum != null && !isNaN(thr)) {
      var d = lastPsaNum - thr;
      if (d !== 0) {
        var vClass = d > 0 ? 'v2-variance-above' : 'v2-variance-below';
        var explainer = d > 0 ? ' \u2191 above threshold' : ' \u2193 below threshold';
        varianceLineHtml = '<div class="v2-card-psa-variance-line ' + vClass + '">' + Math.abs(d).toFixed(3) + explainer + '</div>';
      }
    }
    var lastPsaDate = (p.psaResults && p.psaResults.length) ? p.psaResults[p.psaResults.length - 1].date : '';
    var lastPsaDateStr = lastPsaDate ? formatDateShort(lastPsaDate) : '—';
    var lastPsaLabel = (status === 'completed' || status === 'action') ? 'Last PSA: ' + lastPsaDateStr + ' (New)' : 'Last PSA: ' + lastPsaDateStr;
    var parts = [];
    if (status === 'upcoming') {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      parts.push(psaRow(boldValue));
      parts.push('<div class="v2-card-meta">Next due: ' + dueLine.text + '</div>');
    } else if (status === 'awaiting') {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      parts.push(psaRow(boldValue));
      var dueClass = dueLine.isOverdue ? ' v2-due-overdue' : '';
      var awaitingDueText = dueLine.isOverdue ? dueLine.text : 'Next due: ' + dueLine.text;
      parts.push('<div class="v2-card-meta' + dueClass + '">' + awaitingDueText + '</div>');
    } else if (status === 'completed') {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      parts.push(psaRow(boldValue));
      parts.push('<div class="v2-card-meta">Next due: ' + formatNextDueDate(p.nextDue) + '</div>');
    } else if (status === 'action') {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      if (varianceLineHtml) parts.push(varianceLineHtml);
      parts.push(psaRow(boldValue));
    } else if (status === 'action_required') {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      parts.push(psaRow(boldValue));
      parts.push('<div class="v2-card-context v2-context-alert"><strong>' + formatFollowUpReasonDisplay(p.required_action) + '</strong></div>');
    } else {
      parts.push('<div class="v2-card-meta">' + lastPsaLabel + '</div>');
      parts.push(psaRow(boldValue));
      parts.push('<div class="v2-card-meta">' + dueLine.text + '</div>');
    }
    return parts.join('');
  }

  function renderBoard() {
    var boardEl = document.getElementById('v2-board');
    boardEl.innerHTML = '';
    BOARD_COLUMNS.forEach(function(col) {
      var colDiv = document.createElement('div');
      colDiv.className = 'v2-column' + (col.columnClass ? ' ' + col.columnClass : '');
      var header = document.createElement('div');
      header.className = 'v2-column-header';
      header.textContent = col.label;
      colDiv.appendChild(header);
      if (col.note) {
        var note = document.createElement('div');
        note.className = 'v2-column-note';
        note.textContent = col.note;
        colDiv.appendChild(note);
      }
      var cardsDiv = document.createElement('div');
      cardsDiv.className = 'v2-column-cards';
      var inCol = patients.filter(function(p) { return p.status === col.id; });
      inCol.forEach(function(p) {
        var card = document.createElement('div');
        card.className = 'v2-card';
        card.setAttribute('data-patient-id', p.id);
        var thr = parseFloat(p.threshold);
        var lastPsaNum = (p.psaResults && p.psaResults.length) ? parseFloat(p.psaResults[p.psaResults.length - 1].value) : null;
        var lastPsaDisplay = (p.psaResults && p.psaResults.length) ? formatPsaCell(p.psaResults[p.psaResults.length - 1].value) : '—';
        if (p.status === 'awaiting') lastPsaDisplay = '?';
        var dueLine = formatDueLineForCard(p);
        var ownerClass = (p.ownership || 'GP') === 'Urology' ? 'v2-owner-uro' : 'v2-owner-gp';
        var ownerLabel = (p.ownership || 'GP') === 'Urology' ? 'URO' : 'GP';
        var freqStr = formatFreqShort(getEffectiveSchedule(p));
        var vals = (p.psaResults && p.psaResults.length) ? p.psaResults.map(function(r) { return parseFloat(r.value) || 0; }) : [];
        var dynamicBlock = buildBoardCardDynamicBlock(p, thr, lastPsaNum, lastPsaDisplay, dueLine, vals);
        var nameHtml = formatCardNameDisplay(p.name);
        var fixedTop = '<div class="v2-card-nhs">' + (p.nhs || '—') + '</div><div class="v2-card-name">' + nameHtml + '</div><div class="v2-card-meta v2-card-pathway-row"><span class="v2-owner-badge ' + ownerClass + '">' + ownerLabel + '</span> ' + (p.pathwayLabel || p.pathway) + ' ' + freqStr + '</div>';
        var fixedBottom = '<div class="v2-card-meta v2-card-last-updated">' + formatUpdatedOn(p.lastUpdated) + '</div>';
        var actionsBtn = '<button type="button" class="v2-card-actions-btn" aria-label="Actions" title="Actions">&#8942;</button>';
        card.setAttribute('data-status', p.status || '');
        card.innerHTML = fixedTop + dynamicBlock + fixedBottom + actionsBtn;
        cardsDiv.appendChild(card);
      });
      colDiv.appendChild(cardsDiv);
      boardEl.appendChild(colDiv);
    });
    boardEl.querySelectorAll('.v2-card').forEach(function(card) {
      card.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('.v2-card-actions-btn')) return;
        var id = card.getAttribute('data-patient-id');
        if (id) window.location.hash = 'detail/' + id;
      });
    });
  }

  function getActionsForStatus(status) {
    var viewDetails = { label: 'View details', actionId: 'view-patient' };
    if (status === 'upcoming') return [ viewDetails, { label: 'Move to Awaiting Results', actionId: 'test-done', targetColumnIndex: 2 }, { label: 'Send reminder', actionId: 'remind' } ];
    if (status === 'awaiting') return [ viewDetails, { label: 'Move to Completed', actionId: 'complete', targetColumnIndex: 3 }, { label: 'Move to Review Required', actionId: 'review', targetColumnIndex: 4 } ];
    if (status === 'action') return [ viewDetails, { label: 'Move to Completed', actionId: 'complete', targetColumnIndex: 3 }, { label: 'Move to Follow-up Required', actionId: 'move-action-required', targetColumnIndex: 5 }, { label: 'Move to Recall', actionId: 'move-recall-off-board' }, { label: 'Discharge', actionId: 'discharge-off-board' } ];
    if (status === 'action_required') return [ viewDetails, { label: 'Move to Recall', actionId: 'move-recall-off-board' }, { label: 'Discharge', actionId: 'discharge-off-board' } ];
    if (status === 'completed') return [ viewDetails, { label: 'Move to Recall', actionId: 'move-recall-off-board' } ];
    return [ viewDetails ];
  }

  function wireCardActionsDropdown() {
    var dropdown = document.getElementById('v2-card-actions-dropdown');
    if (!dropdown) return;
    var statusByColIndex = { 1: 'upcoming', 2: 'awaiting', 3: 'completed', 4: 'action', 5: 'action_required' };
    document.getElementById('v2-board').addEventListener('click', function(e) {
      var btn = e.target.closest('.v2-card-actions-btn');
      if (!btn) return;
      e.preventDefault();
      e.stopPropagation();
      var card = btn.closest('.v2-card');
      if (!card) return;
      var status = card.getAttribute('data-status');
      var actions = getActionsForStatus(status);
      dropdown.innerHTML = '';
      actions.forEach(function(a) {
        var b = document.createElement('button');
        b.type = 'button';
        b.textContent = a.label;
        b.setAttribute('data-action-id', a.actionId);
        if (a.targetColumnIndex != null) b.setAttribute('data-target-column', String(a.targetColumnIndex));
        b.addEventListener('click', function(ev) {
          ev.preventDefault();
          if (a.actionId === 'view-patient') {
            var id = card.getAttribute('data-patient-id');
            if (id) window.location.hash = 'detail/' + id;
          } else if ((a.actionId === 'move-recall-off-board' || a.actionId === 'discharge-off-board') && card) {
            var id = card.getAttribute('data-patient-id');
            var p = getPatientById(id);
            if (p) {
              p.status = a.actionId === 'discharge-off-board' ? 'discharged' : 'recall';
              p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
              renderBoard();
              renderList();
              showToaster(a.label);
            }
          } else if (a.targetColumnIndex != null && card) {
            var id = card.getAttribute('data-patient-id');
            var p = getPatientById(id);
            if (p) {
              var newStatus = statusByColIndex[a.targetColumnIndex] || p.status;
              p.status = newStatus;
              p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
              renderBoard();
              renderList();
              showToaster(a.label);
            }
          } else {
            showToaster(a.label);
          }
          dropdown.classList.remove('show');
        });
        dropdown.appendChild(b);
      });
      var rect = btn.getBoundingClientRect();
      dropdown.style.left = rect.left + 'px';
      dropdown.style.top = (rect.bottom + 4) + 'px';
      dropdown.classList.add('show');
    });
    document.addEventListener('click', function closeHandler(e) {
      if (dropdown.classList.contains('show') && !dropdown.contains(e.target) && !(e.target.closest && e.target.closest('.v2-card-actions-btn'))) {
        dropdown.classList.remove('show');
      }
    });
  }

  document.querySelectorAll('[data-view]').forEach(function(btn) {
    btn.addEventListener('click', function() {
      var v = btn.getAttribute('data-view');
      document.getElementById('v2-view-board').classList.toggle('hidden', v !== 'board');
      document.getElementById('v2-view-list').classList.toggle('hidden', v !== 'list');
      document.querySelectorAll('.v2-view-switch [data-view]').forEach(function(b) {
        var on = b.getAttribute('data-view') === v;
        b.classList.toggle('active', on);
        b.setAttribute('aria-pressed', on ? 'true' : 'false');
      });
      if (v === 'list') renderList();
    });
  });
  var listSearchEl = document.getElementById('v2-list-search');
  if (listSearchEl) listSearchEl.addEventListener('input', function() { renderList(); });
  var listProtocolEl = document.getElementById('v2-list-protocol');
  if (listProtocolEl) {
    if (!listProtocolEl.querySelector('option[value=""]').nextElementSibling) {
      PATHWAY_OPTIONS.forEach(function(o) {
        var opt = document.createElement('option');
        opt.value = o.value;
        opt.textContent = o.label;
        listProtocolEl.appendChild(opt);
      });
    }
    listProtocolEl.addEventListener('change', function() {
      listProtocolFilter = listProtocolEl.value || '';
      renderList();
    });
  }
  var listSortEl = document.getElementById('v2-list-sort');
  if (listSortEl) {
    listSortEl.value = listSortKey;
    listSortEl.addEventListener('change', function() {
      listSortKey = listSortEl.value || 'status';
      renderList();
    });
  }
  var listGroupCheck = document.getElementById('v2-list-group-check');
  if (listGroupCheck) {
    listGroupCheck.checked = listViewGrouped;
    listGroupCheck.addEventListener('change', function() {
      listViewGrouped = listGroupCheck.checked;
      renderList();
    });
  }

  function getPatientById(id) {
    if (id == null || id === '') return null;
    var s = String(id).trim();
    return patients.filter(function(p) { return p.id == s; })[0] || null;
  }

  var detailPatientId = null;
  var customiseRows = [];
  var detailEscHandler = null;

  function closeDetailModal() {
    if (detailEscHandler) { document.removeEventListener('keydown', detailEscHandler); detailEscHandler = null; }
    document.getElementById('v2-detail-modal').classList.add('hidden');
    document.body.style.overflow = '';
    document.getElementById('v2-detail-view-content').classList.remove('hidden');
    document.getElementById('v2-detail-draft-content').classList.add('hidden');
    if (window.location.hash) window.location.hash = '';
  }

  function renderDetailScheduleTable(p) {
    var wrap = document.getElementById('v2-detail-schedule-table-wrap');
    if (!wrap) return;
    var rows = p.scheduleRows && p.scheduleRows.length ? p.scheduleRows : getProtocolScheduleRows(p.pathway);
    var collapsed = collapseScheduleRows(rows);
    var currentYear = getPhaseYearFromAnchor(p.anchorDate);
    var thead = '<thead><tr><th>Phase</th><th>Frequency</th><th title="Monitoring Other Test">MOT <span aria-hidden="true">&#9432;</span></th><th title="Liver function test: required alongside PSA for this year">LFT <span aria-hidden="true">&#9432;</span></th></tr></thead>';
    var tbody = '<tbody>' + collapsed.map(function(r) {
      var phase = r.yearFrom === r.yearTo ? 'Year ' + r.yearFrom : 'Year ' + r.yearFrom + '-' + r.yearTo;
      var isCurrent = currentYear >= r.yearFrom && currentYear <= r.yearTo;
      var trClass = isCurrent ? ' class="v2-detail-schedule-row-current"' : '';
      return '<tr' + trClass + '><td>' + phase + '</td><td>' + scheduleToLabel(r.schedule) + '</td><td>' + (r.mot ? '&#10003;' : '—') + '</td><td>' + (r.lft ? '&#10003;' : '—') + '</td></tr>';
    }).join('') + '</tbody>';
    wrap.innerHTML = '<table class="v2-detail-schedule-view v2-schedule-table">' + thead + tbody + '</table>';
  }

  function renderDetailPSA(p) {
    var sparkWrap = document.getElementById('v2-detail-psa-spark');
    var tableWrap = document.getElementById('v2-detail-psa-table-wrap');
    if (!sparkWrap || !tableWrap) return;
    var thr = parseFloat(p.threshold);
    var vals = (p.psaResults && p.psaResults.length) ? p.psaResults.map(function(r) { return parseFloat(r.value) || 0; }) : [];
    var chartSvg = vals.length ? psaBarChartSVG(vals, isNaN(thr) ? null : thr, 0, 88) : '';
    sparkWrap.innerHTML = chartSvg ? '<div class="v2-detail-psa-chart" aria-hidden="true">' + chartSvg + '</div>' : '';
    if (!p.psaResults || !p.psaResults.length) {
      tableWrap.innerHTML = '<p class="v2-section-desc">No results added yet. Add new result to start PSA monitoring.</p>';
      return;
    }
    var lastIdx = p.psaResults.length - 1;
    var rows = p.psaResults.map(function(r, i) {
      var val = parseFloat(r.value);
      var analysis = '—';
      if (i === lastIdx && thr != null && !isNaN(thr) && !isNaN(val)) {
        if (val > thr) analysis = '<span class="v2-variance-above">&#8593; ' + (val - thr).toFixed(3) + ' above threshold</span>';
        else if (val < thr) analysis = '<span class="v2-variance-below">&#8595; ' + (thr - val).toFixed(3) + ' below threshold</span>';
      }
      var rel = formatRelativeTime(r.date);
      var editBtn = i === lastIdx ? ' <button type="button" class="v2-detail-psa-edit-latest" data-variant="secondary">Edit</button>' : '';
      return '<tr data-psa-index="' + i + '"><td>' + r.date + '</td><td>' + (rel ? rel : '—') + '</td><td class="v2-cell-num">' + r.value + editBtn + '</td><td class="v2-detail-psa-analysis">' + analysis + '</td></tr>';
    }).join('');
    tableWrap.innerHTML = '<table class="v2-schedule-table v2-detail-psa-table"><thead><tr><th>Date of result</th><th>Time since</th><th>PSA ng/mL</th><th>Variance</th></tr></thead><tbody>' + rows + '</tbody></table>';
    tableWrap.querySelectorAll('.v2-detail-psa-edit-latest').forEach(function(btn) {
      btn.onclick = function() {
        var idx = parseInt(btn.closest('tr').getAttribute('data-psa-index'), 10);
        var row = p.psaResults[idx];
        var tr = btn.closest('tr');
        var orig = '<td>' + row.date + '</td><td>' + formatRelativeTime(row.date) + '</td><td class="v2-cell-num">' + row.value + '</td>';
        tr.innerHTML = '<td colspan="4" class="v2-detail-psa-edit-row-cell"><div class="v2-detail-psa-edit-row-form"><div class="v2-form-group"><label>Date</label><input type="date" id="v2-detail-psa-edit-date" value="' + (row.date || '') + '"></div><div class="v2-form-group"><label>PSA (ng/mL)</label><input type="text" id="v2-detail-psa-edit-value" value="' + row.value + '" inputmode="decimal" style="width:5rem;"></div><button type="button" id="v2-detail-psa-edit-save">Save</button><button type="button" data-variant="secondary" id="v2-detail-psa-edit-cancel">Cancel</button></div></td>';
        document.getElementById('v2-detail-psa-edit-save').onclick = function() {
          row.date = document.getElementById('v2-detail-psa-edit-date').value || row.date;
          row.value = parseFloat(document.getElementById('v2-detail-psa-edit-value').value) || row.value;
          p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
          renderDetailPSA(p);
          renderDetailNextBanner(p);
        };
        document.getElementById('v2-detail-psa-edit-cancel').onclick = function() {
          if (confirm('Discard edit?')) renderDetailPSA(p);
        };
      };
    });
  }

  function renderDetailNextBanner(p) {
    var el = document.getElementById('v2-detail-next-banner');
    if (!el) return;
    var next = getNextTestDue(p);
    el.textContent = next.text;
  }

  function showDetail(id) {
    document.getElementById('v2-detail-view-content').classList.remove('hidden');
    document.getElementById('v2-detail-draft-content').classList.add('hidden');
    var rawId = (id != null && typeof id === 'string') ? id.replace(/^#?detail\/?/, '').trim() : '';
    if (!rawId) { closeDetailModal(); return; }
    var p = getPatientById(rawId);
    if (!p) { closeDetailModal(); return; }
    detailPatientId = p.id;
    document.body.style.overflow = 'hidden';
    document.getElementById('v2-detail-modal').classList.remove('hidden');
    var info = getPatientDisplayInfo(p);
    document.getElementById('v2-detail-sidebar-nhs').textContent = p.nhs || '—';
    document.getElementById('v2-detail-copy-nhs').onclick = function() {
      var n = (p.nhs || '').replace(/\D/g, '');
      if (n && navigator.clipboard && navigator.clipboard.writeText) navigator.clipboard.writeText(n).catch(function() {});
    };
    document.getElementById('v2-detail-sidebar-name').textContent = info.displayName;
    document.getElementById('v2-detail-sidebar-dob').textContent = p.dob || '—';
    document.getElementById('v2-detail-sidebar-gender').textContent = info.genderLabel;
    document.getElementById('v2-detail-sidebar-age').textContent = info.age;
    document.getElementById('v2-detail-sidebar-address').textContent = info.address;
    document.getElementById('v2-detail-sidebar-phone').textContent = info.phone;
    document.getElementById('v2-detail-sidebar-email').textContent = info.email;
    detailEscHandler = function(e) { if (e.key === 'Escape') closeDetailModal(); };
    document.addEventListener('keydown', detailEscHandler);
    var statusEl = document.getElementById('v2-detail-status');
    statusEl.textContent = getStatusLabel(p.status);
    statusEl.className = 'v2-status-pill v2-status-' + (p.status || '');
    document.getElementById('v2-detail-updated').textContent = formatDateShort(p.lastUpdated) || '—';

    var pathwaySelect = document.getElementById('v2-detail-pathway');
    pathwaySelect.innerHTML = PATHWAY_OPTIONS.map(function(o) { return '<option value="' + o.value + '"' + (o.value === p.pathway ? ' selected' : '') + '>' + o.label + '</option>'; }).join('');
    document.getElementById('v2-detail-diagnosis').value = p.diagnosis || '';
    document.getElementById('v2-detail-ownership').value = p.ownership === 'Urology' ? 'Urology' : 'GP';
    document.getElementById('v2-detail-anchor').value = p.anchorDate || '';
    var y = getPhaseYearFromAnchor(p.anchorDate);
    var yearBadge = document.getElementById('v2-detail-year-badge');
    document.getElementById('v2-detail-year-num').textContent = y;
    yearBadge.style.display = p.anchorDate ? 'inline-block' : 'none';

    function pathwayDirty() {
      var diag = document.getElementById('v2-detail-diagnosis').value || '';
      var own = document.getElementById('v2-detail-ownership').value || 'GP';
      var anchor = document.getElementById('v2-detail-anchor').value || '';
      return pathwaySelect.value !== p.pathway || diag !== (p.diagnosis || '') || own !== (p.ownership === 'Urology' ? 'Urology' : 'GP') || anchor !== (p.anchorDate || '');
    }
    function updatePathwayActions() {
      document.getElementById('v2-detail-pathway-actions').style.display = pathwayDirty() ? '' : 'none';
    }
    pathwaySelect.addEventListener('change', updatePathwayActions);
    document.getElementById('v2-detail-diagnosis').addEventListener('change', updatePathwayActions);
    document.getElementById('v2-detail-ownership').addEventListener('change', updatePathwayActions);
    document.getElementById('v2-detail-anchor').addEventListener('change', function() {
      var y = getPhaseYearFromAnchor(this.value);
      document.getElementById('v2-detail-year-num').textContent = y;
      yearBadge.style.display = this.value ? 'inline-block' : 'none';
      updatePathwayActions();
    });
    document.getElementById('v2-detail-pathway-save').onclick = function() {
      p.pathway = pathwaySelect.value;
      var opt = PATHWAY_OPTIONS.filter(function(o) { return o.value === p.pathway; })[0];
      p.pathwayLabel = opt ? opt.label : p.pathway;
      p.diagnosis = document.getElementById('v2-detail-diagnosis').value || '';
      p.ownership = document.getElementById('v2-detail-ownership').value || 'GP';
      p.anchorDate = document.getElementById('v2-detail-anchor').value || null;
      p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
      if (!p.scheduleRows || !p.scheduleRows.length) p.scheduleRows = getProtocolScheduleRows(p.pathway);
      renderDetailScheduleTable(p);
      document.getElementById('v2-detail-year-num').textContent = getPhaseYearFromAnchor(p.anchorDate);
      renderDetailNextBanner(p);
      updatePathwayActions();
    };
    document.getElementById('v2-detail-pathway-cancel').onclick = function() {
      pathwaySelect.value = p.pathway;
      document.getElementById('v2-detail-diagnosis').value = p.diagnosis || '';
      document.getElementById('v2-detail-ownership').value = p.ownership === 'Urology' ? 'Urology' : 'GP';
      document.getElementById('v2-detail-anchor').value = p.anchorDate || '';
      updatePathwayActions();
    };

    document.getElementById('v2-detail-schedule-table-wrap').classList.remove('hidden');
    document.getElementById('v2-detail-schedule-edit').classList.add('hidden');
    renderDetailScheduleTable(p);

    document.getElementById('v2-detail-customise').onclick = function() {
      customiseRows = (p.scheduleRows || []).map(function(r) { return { yearFrom: r.yearFrom, yearTo: r.yearTo, schedule: r.schedule, mot: r.mot, lft: r.lft }; });
      if (customiseRows.length === 0) customiseRows = getProtocolScheduleRows(p.pathway);
      document.getElementById('v2-detail-schedule-table-wrap').classList.add('hidden');
      document.getElementById('v2-detail-customise').classList.add('hidden');
      document.getElementById('v2-detail-schedule-edit').classList.remove('hidden');
      renderDetailScheduleEditTbody();
      document.getElementById('v2-detail-schedule-edit-add-year').onclick = function() {
        var last = customiseRows.length ? customiseRows[customiseRows.length - 1] : null;
        var nextY = last ? last.yearTo + 1 : 1;
        var s = last ? last.schedule : '6-monthly';
        customiseRows.push({ yearFrom: nextY, yearTo: nextY, schedule: s, mot: last ? last.mot : false, lft: last ? last.lft : false });
        renderDetailScheduleEditTbody();
      };
      document.getElementById('v2-detail-schedule-edit-reset').onclick = function() {
        if (!confirm('Reset schedule to protocol default for the selected pathway?')) return;
        customiseRows = getProtocolScheduleRows(p.pathway);
        renderDetailScheduleEditTbody();
      };
      document.getElementById('v2-detail-schedule-edit-discard').onclick = function() {
        document.getElementById('v2-detail-schedule-edit').classList.add('hidden');
        document.getElementById('v2-detail-schedule-table-wrap').classList.remove('hidden');
        document.getElementById('v2-detail-customise').classList.remove('hidden');
      };
      document.getElementById('v2-detail-schedule-edit-update').onclick = function() {
        p.scheduleRows = customiseRows.map(function(r) { return { yearFrom: r.yearFrom, yearTo: r.yearTo, schedule: r.schedule, mot: r.mot, lft: r.lft }; });
        p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
        document.getElementById('v2-detail-schedule-edit').classList.add('hidden');
        document.getElementById('v2-detail-schedule-table-wrap').classList.remove('hidden');
        document.getElementById('v2-detail-customise').classList.remove('hidden');
        renderDetailScheduleTable(p);
        renderDetailNextBanner(p);
      };
    };

    var threshInput = document.getElementById('v2-detail-threshold');
    threshInput.value = p.threshold || '';
    function thresholdDirty() { return (threshInput.value || '').trim() !== (p.threshold || ''); }
    function updateThresholdActions() {
      document.getElementById('v2-detail-threshold-actions').style.display = thresholdDirty() ? '' : 'none';
    }
    threshInput.addEventListener('input', updateThresholdActions);
    threshInput.addEventListener('change', updateThresholdActions);
    document.getElementById('v2-detail-threshold-save').onclick = function() {
      p.threshold = String((threshInput.value || '').trim() || getProtocolThreshold(p.pathway));
      p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
      renderDetailPSA(p);
      updateThresholdActions();
    };
    document.getElementById('v2-detail-threshold-cancel').onclick = function() {
      threshInput.value = p.threshold || '';
      updateThresholdActions();
    };

    renderDetailNextBanner(p);
    renderDetailPSA(p);

    var addForm = document.getElementById('v2-detail-psa-add-form');
    var addPsaBtn = document.getElementById('v2-detail-add-psa');
    addForm.classList.add('hidden');
    addPsaBtn.classList.remove('hidden');
    document.getElementById('v2-detail-add-psa').onclick = function() {
      addForm.classList.remove('hidden');
      addPsaBtn.classList.add('hidden');
      document.getElementById('v2-detail-psa-add-date').value = new Date().toISOString().slice(0, 10);
      document.getElementById('v2-detail-psa-add-value').value = '';
    };
    function closeAddPsaForm() {
      addForm.classList.add('hidden');
      addPsaBtn.classList.remove('hidden');
    }
    document.getElementById('v2-detail-psa-add-cancel').onclick = function() {
      if (confirm('Discard new result?')) closeAddPsaForm();
    };
    document.getElementById('v2-detail-psa-add-submit').onclick = function() {
      var date = document.getElementById('v2-detail-psa-add-date').value;
      var val = document.getElementById('v2-detail-psa-add-value').value;
      if (date && val !== '') {
        p.psaResults = p.psaResults || [];
        p.psaResults.push({ date: date, value: parseFloat(val) || 0 });
        p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
        document.getElementById('v2-detail-psa-add-date').value = '';
        document.getElementById('v2-detail-psa-add-value').value = '';
        closeAddPsaForm();
        renderDetailPSA(p);
        renderDetailNextBanner(p);
      }
    };

    var footer = document.getElementById('v2-detail-footer');
    footer.innerHTML = '';
    function addMoveBtn(label, status, icon) {
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.setAttribute('data-variant', 'secondary');
      btn.innerHTML = (icon ? '<span aria-hidden="true">' + icon + '</span> ' : '') + label;
      btn.onclick = function() { p.status = status; p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' '); renderBoard(); renderList(); closeDetailModal(); };
      footer.appendChild(btn);
    }
    if (p.status === 'upcoming') { addMoveBtn('Move to Recall', 'recall', '\u21bb'); addMoveBtn('Move to Awaiting results', 'awaiting', ''); }
    else if (p.status === 'awaiting') { addMoveBtn('Move to Recall', 'recall', '\u21bb'); }
    else if (p.status === 'completed') { addMoveBtn('Move to Recall', 'recall', '\u21bb'); }
    else if (p.status === 'action') { addMoveBtn('Move to Follow-up Required', 'action_required', '?'); addMoveBtn('Move to Awaiting results', 'awaiting', ''); }
    else if (p.status === 'action_required') { addMoveBtn('Move to Recall', 'recall', '\u21bb'); addMoveBtn('Move to Awaiting results', 'awaiting', ''); }
    else if (p.status === 'recall') { addMoveBtn('Move to Awaiting results', 'awaiting', ''); }
    var moreWrap = document.createElement('div');
    moreWrap.className = 'v2-more-menu';
    moreWrap.innerHTML = '<button type="button" class="ghost icon" id="v2-detail-more-btn" aria-label="More actions">&#8230;</button><div id="v2-detail-more-dropdown" class="v2-more-dropdown hidden"><button type="button" id="v2-detail-discharge">Discharge</button></div>';
    footer.appendChild(moreWrap);
    var dd = moreWrap.querySelector('#v2-detail-more-dropdown');
    moreWrap.querySelector('#v2-detail-more-btn').onclick = function() {
      dd.classList.toggle('hidden');
      if (!dd.classList.contains('hidden')) {
        setTimeout(function() {
          function closeMore(e) {
            if (!moreWrap.contains(e.target)) { dd.classList.add('hidden'); document.removeEventListener('click', closeMore); }
          }
          document.addEventListener('click', closeMore);
        }, 0);
      }
    };
    moreWrap.querySelector('#v2-detail-discharge').onclick = function() {
      if (confirm('Discharge this patient?')) {
        p.status = 'discharged';
        p.lastUpdated = new Date().toISOString().slice(0, 16).replace('T', ' ');
        renderBoard();
        renderList();
        closeDetailModal();
      }
    };

    document.getElementById('v2-detail-close').onclick = closeDetailModal;
  }

  document.getElementById('v2-detail-modal').addEventListener('click', function(e) {
    if (e.target.id === 'v2-detail-modal') closeDetailModal();
  });

  function renderDetailScheduleEditTbody() {
    var tbody = document.getElementById('v2-detail-schedule-edit-tbody');
    var dischargeYearEl = document.getElementById('v2-detail-schedule-edit-discharge-year');
    if (!tbody) return;
    tbody.innerHTML = '';
    customiseRows.forEach(function(row, idx) {
      var tr = document.createElement('tr');
      var freqOpts = FREQUENCY_OPTIONS.map(function(o) { return '<option value="' + o.value + '"' + (o.value === row.schedule ? ' selected' : '') + '>' + o.label + '</option>'; }).join('');
      var delCell = (idx === customiseRows.length - 1 && customiseRows.length > 1) ? '<td><button type="button" class="v2-schedule-delete-btn" data-variant="secondary" data-detail-edit-delete aria-label="Delete year">Delete</button></td>' : '<td></td>';
      tr.innerHTML = '<td>' + row.yearFrom + '</td><td><select data-row="' + idx + '" data-field="schedule">' + freqOpts + '</select></td><td><input type="checkbox" data-row="' + idx + '" data-field="mot"' + (row.mot ? ' checked' : '') + ' aria-label="MOT"></td><td><input type="checkbox" data-row="' + idx + '" data-field="lft"' + (row.lft ? ' checked' : '') + ' aria-label="LFT"></td>' + delCell;
      tbody.appendChild(tr);
    });
    tbody.querySelectorAll('select[data-field="schedule"]').forEach(function(el) {
      el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (customiseRows[i]) customiseRows[i].schedule = el.value; });
    });
    tbody.querySelectorAll('input[data-field="mot"]').forEach(function(el) {
      el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (customiseRows[i]) customiseRows[i].mot = el.checked; });
    });
    tbody.querySelectorAll('input[data-field="lft"]').forEach(function(el) {
      el.addEventListener('change', function() { var i = parseInt(el.getAttribute('data-row'), 10); if (customiseRows[i]) customiseRows[i].lft = el.checked; });
    });
    tbody.querySelectorAll('[data-detail-edit-delete]').forEach(function(btn) {
      btn.addEventListener('click', function() { customiseRows.pop(); renderDetailScheduleEditTbody(); });
    });
    if (dischargeYearEl) dischargeYearEl.textContent = customiseRows.length ? customiseRows[customiseRows.length - 1].yearTo : '1';
  }

  function onHashChange() {
    var hash = (window.location.hash || '').trim();
    var m = hash.match(/^#?detail\/(.+)$/);
    if (m && m[1]) {
      try { showDetail(decodeURIComponent(m[1])); } catch (e) { showDetail(m[1]); }
    } else {
      closeDetailModal();
    }
  }

  window.addEventListener('hashchange', onHashChange);
  window.addEventListener('load', onHashChange);

  renderBoard();
  renderList();
  wireCardActionsDropdown();
})();
  </script>
</body>
</html>
