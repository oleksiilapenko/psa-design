<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NHS Prostate Cancer Follow-Up — Prototype</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f5f5f5; color: #333; min-height: 100vh; }
    .hidden { display: none !important; }
    .header { background: #fff; border-bottom: 2px solid #333; padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; gap: 24px; flex-wrap: wrap; }
    #view-dashboard .header { position: sticky; top: 0; z-index: 100; }
    .header h1 { margin: 0; font-size: 1.25rem; font-weight: 700; }
    .header-actions { display: flex; align-items: center; gap: 16px; margin-left: auto; }
    .view-toggle { display: flex; border: 1px solid #333; border-radius: 0; }
    .view-toggle a { padding: 8px 16px; text-decoration: none; color: #333; background: #fff; }
    .view-toggle a.active { background: #333; color: #fff; }
    .view-toggle a:not(.active):hover { background: #eee; }
    .btn { display: inline-block; padding: 8px 16px; border: 2px solid #333; background: #fff; cursor: pointer; font-size: 1rem; text-decoration: none; color: #333; }
    .btn:hover { background: #333; color: #fff; }
    .btn-primary { background: #007f3b; color: #fff; border-color: #007f3b; }
    .btn-primary:hover { background: #004d24; border-color: #004d24; color: #fff; }
    .btn-secondary { background: #fff; color: #333; }
    main { padding: 24px; max-width: 1600px; margin: 0 auto; }

    /* Board */
    .dashboard-toolbar { display: flex; flex-wrap: wrap; align-items: center; gap: 10px 16px; margin-bottom: 12px; padding: 4px 0 8px; }
    .dashboard-toolbar label { font-size: 13px; font-weight: 600; color: #333; margin: 0; }
    .dashboard-toolbar input[type="text"] { padding: 5px 8px; border: 1px solid #999; font-size: 14px; width: 220px; }
    .dashboard-toolbar select { padding: 6px 10px; border: 1px solid #999; font-size: 14px; min-width: 160px; background: #fff; }
    .dashboard-toolbar .toolbar-group { display: flex; align-items: center; gap: 8px; }
    .board { display: flex; gap: 12px; overflow-x: auto; min-height: 400px; padding-bottom: 6px; }
    .column { flex: 0 0 268px; background: #e8e8e8; display: flex; flex-direction: column; }
    .column-header { padding: 8px 10px; font-weight: 700; font-size: 13px; background: transparent; }
    .column.alert { background: #f5e6e9; }
    .column.alert .column-header { color: #7d3c47; }
    .column.completed { background: #e8f5e9; }
    .column.completed .column-header { color: #1b5e20; }
    .column.completed .column-note { color: #2e7d32; }
    .column-cards { padding: 6px; flex: 1; overflow-y: auto; }
    .column-note { font-size: 11px; color: #555; line-height: 1.4; padding: 6px 8px; height: 80px; flex-shrink: 0; box-sizing: border-box; overflow: hidden; }
    .card { background: #fff; border: 2px solid transparent; border-radius: 0; padding: 8px 38px 8px 10px; margin-bottom: 6px; cursor: pointer; display: flex; flex-direction: column; position: relative; }
    .card:hover { border-color: #333; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    /* Compact left-aligned stack: NHS → Name • Age → Chips → PSA → Due → Last updated */
    .card-nhs { font-size: 11px; font-variant-numeric: tabular-nums; color: #333; margin: 0 0 1px; line-height: 1.3; }
    .card-name { font-size: 15px; font-weight: 700; color: #333; margin: 0 0 4px; line-height: 1.3; }
    .card-chips { display: flex; flex-wrap: wrap; gap: 3px; margin: 0 0 4px; }
    .card-chip-protocol { display: inline-block; background: #333; color: #fff; padding: 2px 6px; font-size: 10px; font-weight: 700; border: 2px solid #333; border-radius: 0; cursor: help; }
    .protocol-tooltip { position: fixed; z-index: 10000; max-width: 280px; padding: 6px 10px; font-size: 13px; line-height: 1.4; background: #333; color: #fff; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.25); pointer-events: none; opacity: 0; transition: opacity 0.15s ease; }
    .protocol-tooltip.visible { opacity: 1; }
    .card-chip-phase { display: inline-block; background: #fff; color: #555; padding: 2px 6px; font-size: 10px; font-weight: 600; border: 1px solid #999; border-radius: 0; }
    .card-chip-5ari { display: inline-block; background: #f5f0e6; color: #5c4a2d; padding: 2px 6px; font-size: 10px; font-weight: 600; border: 1px solid #8b7355; border-radius: 0; }
    .card-psa-line { font-size: 13px; margin: 0 0 2px; line-height: 1.3; }
    .card-psa-line strong { font-weight: 700; }
    .card-threshold { font-size: 12px; color: #666; }
    .card-psa-trend-row { margin-top: 10px; margin-bottom: 10px; }
    .card-context { margin-top: 2px; margin-bottom: 10px; }
    .card-due-line { font-size: 11px; color: #666; margin: 0 0 4px; line-height: 1.3; }
    .card-due-line.overdue { color: #b71c1c; font-weight: 600; }
    .card-last-updated { margin-top: auto; padding-top: 4px; font-size: 10px; color: #999; line-height: 1.3; }
    /* PSA + sparkline on one row; chart aligned right with menu */
    .card-psa-trend-row { display: flex; align-items: center; margin: 0 0 2px; position: relative; padding-top: 10px; padding-bottom: 10px; }
    .card-psa-trend-row .card-psa-line { margin: 0; flex: 1 1 auto; min-width: 0; padding-right: 56px; }
    .card-psa-trend-row .sparkline-wrap { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 48px; height: 12px; }
    .card-psa-trend-row .sparkline-threshold-line { position: absolute; left: 0; right: 0; height: 1px; background: #b71c1c; pointer-events: none; z-index: 1; }
    .card-psa-trend-row .card-sparkline { height: 12px; width: 48px; margin: 0; background: transparent; border: none; display: flex; align-items: flex-end; gap: 1px; padding: 0; }
    .card-psa-trend-row .card-sparkline span { display: inline-block; background: #333; flex: 1; min-width: 2px; max-width: 10px; min-height: 2px; border-radius: 0; }
    .card-psa-trend-row .card-psa-row { margin: 0; flex: 1 1 auto; min-width: 0; font-size: 13px; }
    .card-psa-trend-row .card-psa-row strong { font-weight: 700; }
    .card-context { font-size: 11px; color: #c00; margin: 0 0 4px; }
    .card-context-icon { font-weight: 700; margin-right: 2px; }
    .card-context-delta { font-variant-numeric: tabular-nums; margin-left: 4px; color: #721c24; }
    .card-actions { margin-top: 6px; padding-top: 6px; border-top: 1px solid #eee; }
    .card-actions .btn { padding: 4px 8px; font-size: 11px; margin-right: 4px; }
    .card-actions-menu-btn { position: absolute; top: 6px; right: 6px; width: 26px; height: 26px; border: 1px solid #ccc; background: #fff; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; border-radius: 0; font-size: 18px; line-height: 1; color: #000; flex-shrink: 0; font-weight: 800; }
    .card-actions-menu-btn:hover { background: #f0f0f0; }
    .card-actions-menu-btn:focus { outline: 2px solid #333; outline-offset: 2px; }
    .card-actions-dropdown { position: fixed; z-index: 100; background: #fff; border: 1px solid #999; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; display: none; padding: 4px 0; }
    .card-actions-dropdown.show { display: block; }
    .card-actions-dropdown button { display: block; width: 100%; padding: 8px 12px; text-align: left; background: none; border: none; cursor: pointer; font-size: 13px; }
    .card-actions-dropdown button:hover { background: #f0f0f0; }
    .card-actions-dropdown .dropdown-title { padding: 6px 12px; font-size: 11px; font-weight: 700; color: #666; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid #eee; margin-bottom: 4px; }

    /* List view — tabs */
    .list-view .tabs { display: flex; flex-wrap: wrap; align-items: flex-end; gap: 0 24px; border-bottom: 1px solid #ccc; margin-bottom: 0; padding: 0; }
    .list-view .tabs-group { display: flex; gap: 0; }
    .list-view .tabs button { padding: 10px 16px; border: 1px solid #ccc; border-bottom: none; background: #eee; cursor: pointer; font-size: 14px; font-weight: 400; margin-bottom: -1px; }
    .list-view .tabs button.active { background: #fff; border-bottom: 1px solid #fff; color: #333; font-weight: 600; }
    .list-view .tabs button:hover:not(.active) { background: #e8e8e8; }
    .list-view .tabs button:focus-visible { outline: 2px solid #333; outline-offset: 2px; }
    .list-view .tabs .list-tab-count { font-weight: 600; margin-left: 4px; }
    .list-view table { width: 100%; border-collapse: collapse; background: #fff; border: 1px solid #ccc; border-top: none; }
    .list-view th, .list-view td { padding: 10px 12px; text-align: left; border-bottom: 1px solid #ddd; }
    .list-view tbody td:first-child { font-size: 16px; font-weight: 700; }
    .list-view th { background: #e0e0e0; font-weight: 700; }
    .list-view tr:hover { background: #f9f9f9; }
    .list-view tr[data-detail] { cursor: pointer; }
    .list-view .sparkline-wrap { position: relative; display: inline-block; height: 24px; }
    .list-view .sparkline-threshold-line { position: absolute; left: 0; right: 0; height: 1px; background: #b71c1c; pointer-events: none; z-index: 1; }
    .list-view .sparkline-inline { display: flex; align-items: flex-end; height: 24px; gap: 2px; }
    .list-view .sparkline-inline span { min-width: 4px; max-width: 8px; width: 6px; background: #333; border-radius: 0; min-height: 4px; flex: 0 1 6px; }
    .list-view .status-badge { display: inline-block; padding: 4px 10px; font-size: 11px; font-weight: 700; border: 2px solid; border-radius: 0; white-space: nowrap; background: transparent; }
    .list-view .status-upcoming { color: #0d47a1; border-color: #0d47a1; }
    .list-view .status-awaiting { color: #e65100; border-color: #e65100; }
    .list-view .status-action { color: #b71c1c; border-color: #b71c1c; }
    .list-view .status-completed { color: #1b5e20; border-color: #1b5e20; }
    .list-view .status-recall { color: #4a148c; border-color: #4a148c; }
    .list-view .status-action_required { color: #e65100; border-color: #e65100; }
    .list-view .status-discharged { color: #616161; border-color: #616161; }
    .list-view th:nth-child(8), .list-view td:nth-child(8),
    .list-view th:nth-child(9), .list-view td:nth-child(9),
    .list-view th:nth-child(10), .list-view td:nth-child(10) { text-align: right; }
    .list-view .threshold-cell { font-variant-numeric: tabular-nums; }
    .list-view .list-delta-cell { font-variant-numeric: tabular-nums; font-size: 13px; }
    .list-view .list-delta-above { font-weight: 700; color: #b71c1c; }
    .list-view .list-delta-below { color: #1b5e20; }
    .list-view .th-delta-legend { font-weight: 400; font-size: 11px; color: #666; }
    .list-view .threshold-legend { font-size: 11px; color: #666; margin-top: 8px; }
    .list-view .list-next-due-overdue { color: #b71c1c; font-weight: 600; }
    .list-view th:nth-child(6), .list-view .col-diagnoses { max-width: 140px; width: 140px; box-sizing: border-box; }
    .list-view th:nth-child(2), .list-view td:nth-child(2) { white-space: nowrap; }

    /* Wizard */
    .wizard { background: #fff; border: 1px solid #999; border-radius: 4px; padding: 32px; max-width: 560px; margin: 0 auto; }
    .wizard h2 { margin: 0 0 8px; font-size: 1.25rem; }
    .wizard .step-label { font-size: 12px; color: #666; margin-bottom: 24px; }
    .wizard .form-group { margin-bottom: 20px; }
    .wizard label { display: block; font-weight: 600; margin-bottom: 6px; }
    .wizard input, .wizard select { width: 100%; max-width: 320px; padding: 8px 12px; border: 1px solid #333; font-size: 1rem; }
    .diagnosis-select-wrap { position: relative; display: inline-block; width: 100%; max-width: 320px; min-width: 200px; }
    .diagnosis-select-wrap input { width: 100%; padding-right: 28px; box-sizing: border-box; }
    .diagnosis-select-wrap .diagnosis-chevron { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #555; font-size: 11px; line-height: 1; }
    .detail-view .diagnosis-select-wrap { max-width: 320px; min-width: 200px; flex: 1 1 200px; }
    .detail-view .diagnosis-select-wrap input { border: 2px solid #333; padding: 6px 28px 6px 10px; font-size: 14px; min-width: 0; }
    .wizard .readonly { background: #eee; color: #555; }
    .wizard .confirm-box { background: #f0f0f0; padding: 12px; margin: 16px 0; border-left: 4px solid #007f3b; }
    .wizard .actions { margin-top: 28px; display: flex; gap: 12px; }
    .wizard .wizard-nav { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
    .wizard .wizard-nav-right { display: flex; gap: 8px; }
    .wizard #step1-result { margin-top: 12px; }
    .wizard .step1-success-banner { display: flex; align-items: center; gap: 8px; padding: 10px 12px; margin-bottom: 12px; background: #e8f5e9; border-left: 4px solid #007f3b; font-size: 14px; }
    .wizard .step1-success-banner::before { content: '✓'; font-weight: 700; color: #007f3b; }
    .wizard .step1-patient-card { background: #f5f5f5; border: 1px solid #ccc; padding: 16px; margin-bottom: 16px; position: relative; }
    .wizard .step1-patient-card .step1-patient-clear { position: absolute; top: 8px; right: 8px; padding: 4px 8px; font-size: 14px; cursor: pointer; background: transparent; border: 1px solid #666; }
    .wizard .step1-patient-card .step1-patient-clear:hover { background: #eee; }
    .wizard .step1-patient-card .step1-patient-nhs { font-size: 12px; color: #666; margin-bottom: 4px; }
    .wizard .step1-patient-card .step1-patient-name { font-size: 18px; font-weight: 700; margin: 0 0 12px; }
    .wizard .step1-patient-card .step1-patient-meta { font-size: 13px; color: #555; margin: 4px 0; }
    .phase-inline { color: #007f3b; }
    .wizard-hint { font-size: 12px; color: #555; margin: 6px 0 0; }
    .wizard-guideline-text { font-size: 14px; line-height: 1.5; color: #333; margin: 10px 0; padding: 10px 12px; background: #e8f5e9; border-left: 4px solid #007f3b; }
    .wizard .protocol-radios { border: 0; padding: 0; margin: 0 0 20px; }
    .wizard .protocol-option { margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
    .wizard .protocol-option input { width: auto; margin: 0; }
    .wizard .protocol-option label { margin: 0; font-weight: 600; cursor: pointer; }
    .wizard .protocol-help { font-size: 13px; color: #333; line-height: 1.5; margin: 0 0 16px; padding: 10px 12px; background: #f0f4f8; border-left: 4px solid #007f3b; }
    .wizard .wizard-5ari { border: 0; padding: 0; margin: 0; }
    .protocol-table-wrap { overflow-x: auto; }
    .protocol-table { width: 100%; min-width: 280px; border-collapse: collapse; font-size: 14px; }
    .protocol-table th, .protocol-table td { padding: 6px 10px; text-align: left; border: 1px solid #ccc; }
    .protocol-table th { background: #e8e8e8; font-weight: 700; }
    .protocol-table tbody tr.current-year { background: #e8f5e9; }
    .protocol-table tbody tr.current-year td:first-child { border-left: 4px solid #007f3b; }
    .protocol-table tbody tr.schedule-override td:last-child { font-weight: 600; }
    .protocol-table .override-marker { font-weight: 700; color: #333; }
    .protocol-table .override-cell { min-width: 120px; }
    .protocol-table select { width: 100%; padding: 4px 8px; border: 1px solid #333; font-size: 13px; }
    .protocol-table .phase-range-cell input[type="number"] { padding: 4px 6px; border: 1px solid #333; font-size: 13px; }
    .protocol-table td label[title] { cursor: help; margin-left: 4px; }

    /* Detail view */
    .detail-view { background: #fff; border: 1px solid #999; border-radius: 4px; padding: 24px; max-width: 720px; margin: 0 auto; }
    .detail-view h2 { margin: 0 0 8px; font-size: 1.35rem; }
    .detail-view .back { margin-bottom: 16px; }
    .detail-view .section { margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid #ddd; }
    .detail-view .section:last-of-type { border-bottom: none; }
    .detail-view .section-title { font-size: 1.15rem; font-weight: 700; color: #333; margin-bottom: 10px; letter-spacing: 0.02em; }
    .detail-view .detail-chart-wrap { position: relative; margin: 8px 0; width: 100%; max-width: 100%; }
    .detail-view .detail-sparkline { position: relative; height: 48px; background: #f5f5f5; display: flex; align-items: flex-end; padding: 8px; gap: 4px; }
    .detail-view .detail-sparkline .detail-sparkline-bar { flex: 1; background: #666; border-radius: 2px; min-height: 4px; }
    .detail-view .detail-sparkline-threshold { position: absolute; left: 0; right: 0; bottom: 0; height: 1px; background: #b71c1c; pointer-events: none; z-index: 2; border: none; }
    .detail-view .detail-sparkline-labels { display: flex; gap: 4px; margin-top: 4px; font-size: 11px; color: #555; font-variant-numeric: tabular-nums; }
    .detail-view .detail-sparkline-labels span { flex: 1; text-align: center; }
    .detail-view .detail-sparkline-empty { margin: 0; padding: 12px; font-size: 13px; color: #666; background: #f5f5f5; }
    .detail-view .detail-psa-unit { font-size: 12px; font-weight: 400; color: #666; margin-left: 2px; }
    .detail-view .detail-grid { display: grid; grid-template-columns: auto 1fr; gap: 6px 16px; font-size: 14px; }
    .detail-view .detail-grid dt { color: #666; }
    .detail-view .detail-grid dd { margin: 0; }
    .detail-view .detail-pathway-fields.detail-pathway-two-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 0 32px; align-items: start; }
    .detail-view .pathway-diagnosis-row { margin: 0 0 12px; }
    .detail-view .pathway-col-1 { margin: 0; }
    .detail-view .pathway-col-2 { margin: 0; }
    .detail-view .pathway-full-width { margin-top: 24px; }
    @media (max-width: 560px) {
      .detail-view .detail-pathway-fields.detail-pathway-two-cols { grid-template-columns: 1fr; }
    }
    .detail-view .detail-protocol-rules { margin-top: 12px; border: 1px solid #999; border-radius: 0; }
    .detail-view .detail-protocol-rules-summary { padding: 10px 12px; font-size: 14px; font-weight: 600; cursor: pointer; list-style: none; background: #f0f0f0; }
    .detail-view .detail-protocol-rules-summary::-webkit-details-marker { display: none; }
    .detail-view .detail-protocol-rules-summary::before { content: '▸ '; display: inline-block; width: 1em; }
    .detail-view .detail-protocol-rules[open] .detail-protocol-rules-summary::before { content: '▾ '; }
    .detail-view .detail-protocol-rules-content { padding: 12px; border-top: 1px solid #ddd; background: #fff; }
    .detail-view .detail-protocol-rules-content .detail-grid { margin: 0; }
    .detail-view #detail-next-steps-section .actions { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
    .detail-view .actions .btn { margin-right: 8px; margin-bottom: 8px; }
    .detail-view .action-card { display: block; width: 100%; text-align: left; border: 1px solid #ccc; border-left: 3px solid #333; padding: 14px 16px; margin: 0; cursor: pointer; background: #fafafa; font-family: inherit; border-radius: 0; }
    .detail-view .action-card:hover { background: #f0f0f0; }
    .detail-view .action-card:focus { outline: 2px solid #333; outline-offset: 2px; }
    .detail-view .action-card-title { font-weight: 700; margin: 0; font-size: 15px; color: #333; }
    .detail-view .action-card-desc { margin: 4px 0 0; font-size: 13px; line-height: 1.4; color: #555; }
    .detail-view .action-card-discharge { border-left-color: #b71c1c; }
    .detail-view #detail-discharge-section .actions { display: flex; flex-direction: column; gap: 8px; margin-top: 6px; }
    .detail-view .detail-chips { display: flex; flex-wrap: wrap; align-items: center; gap: 6px; margin-top: 6px; }
    .detail-view .detail-chip-protocol { display: inline-block; background: #333; color: #fff; padding: 4px 10px; font-size: 12px; font-weight: 700; border: 2px solid #333; border-radius: 0; cursor: help; }
    .detail-view .detail-chip-phase { display: inline-block; background: #fff; color: #555; padding: 4px 10px; font-size: 12px; font-weight: 600; border: 1px solid #999; border-radius: 0; }
    .detail-view .detail-guideline-text { font-size: 14px; line-height: 1.5; color: #333; margin: 10px 0; padding: 10px 12px; background: #e8f5e9; border-left: 4px solid #007f3b; }
    .detail-view .detail-5ari-block { margin-top: 12px; }
    .detail-view .detail-5ari-block .inline-label { display: inline; font-weight: 600; margin-left: 4px; }
    .detail-view .status-badge-detail { display: inline-block; padding: 4px 10px; font-size: 12px; font-weight: 700; border: 2px solid; border-radius: 0; background: transparent; }
    .detail-view .status-badge-detail.status-upcoming { color: #0d47a1; border-color: #0d47a1; }
    .detail-view .status-badge-detail.status-awaiting { color: #e65100; border-color: #e65100; }
    .detail-view .status-badge-detail.status-action { color: #b71c1c; border-color: #b71c1c; }
    .detail-view .status-badge-detail.status-completed { color: #1b5e20; border-color: #1b5e20; }
    .detail-view .status-badge-detail.status-recall { color: #4a148c; border-color: #4a148c; }
    .detail-view .status-badge-detail.status-action_required { color: #e65100; border-color: #e65100; }
    .detail-view .status-badge-detail.status-discharged { color: #616161; border-color: #616161; }
    .detail-view .threshold-edit { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-top: 4px; }
    .detail-view .threshold-edit input { width: 80px; padding: 6px 10px; border: 2px solid #333; font-size: 14px; }
    .detail-view .threshold-edit .btn { padding: 6px 12px; font-size: 14px; }
    .detail-view .detail-psa-section .section-title { margin-bottom: 14px; }
    .detail-view .psa-subsection { margin-bottom: 18px; }
    .detail-view .psa-subsection:last-child { margin-bottom: 0; }
    .detail-view .psa-subsection-title { font-size: 0.9rem; font-weight: 600; color: #555; margin: 0 0 8px; letter-spacing: 0.02em; }
    .detail-view .psa-subsection-inner { padding: 12px 14px; background: #fafafa; border: 1px solid #e8e8e8; border-radius: 4px; }
    .detail-view .psa-subsection-inner--highlight { border-left: 4px solid #007f3b; }
    .detail-view .psa-subsection-trend .psa-subsection-inner { padding: 10px 12px; }
    .detail-view .detail-chart-wrap--in-subsection { margin: 0; }
    .detail-view #detail-psa-chart-wrap.hidden { display: none !important; }
    .detail-view .psa-subsection-latest .psa-subsection-inner { display: flex; align-items: baseline; flex-wrap: wrap; gap: 8px; }
    .detail-view .psa-latest-value { font-size: 1.1rem; font-variant-numeric: tabular-nums; }
    .detail-view .psa-latest-value.hidden { display: none !important; }
    .detail-view .psa-latest-sep { color: #666; font-weight: 400; }
    .detail-view .psa-latest-analytical { margin: 4px 0 0; font-size: 12px; color: #666; font-variant-numeric: tabular-nums; }
    .detail-view .psa-latest-analytical.hidden { display: none !important; }
    .detail-view .psa-no-result-msg { margin: 0; font-size: 14px; color: #666; font-style: italic; }
    .detail-view .psa-no-result-msg.hidden { display: none !important; }
    .detail-view .psa-latest-threshold { margin: 8px 0 0; font-size: 14px; }
    .detail-view .psa-latest-threshold.hidden { display: none !important; }
    .detail-view .psa-latest-threshold-label { color: #666; margin-right: 4px; }
    .detail-view .detail-psa-edit-hint { font-size: 13px; color: #333; margin: 0 0 12px; line-height: 1.5; font-weight: 500; }
    .detail-view .psa-result-form { display: grid; grid-template-columns: auto 1fr auto; gap: 12px 20px; align-items: end; max-width: 440px; }
    .detail-view .psa-result-form .form-field { display: flex; flex-direction: column; gap: 4px; }
    .detail-view .psa-result-form .form-field label { font-size: 13px; font-weight: 600; color: #333; }
    .detail-view .psa-result-form input[type="text"] { width: 88px; min-width: 88px; padding: 8px 12px; border: 2px solid #333; font-size: 14px; font-variant-numeric: tabular-nums; }
    .detail-view .psa-result-form input[type="date"] { min-width: 11rem; padding: 8px 12px; border: 2px solid #333; font-size: 14px; }
    .detail-view .psa-result-form .btn { padding: 8px 16px; font-size: 14px; align-self: end; }
    @media (max-width: 380px) {
      .detail-view .psa-result-form { grid-template-columns: 1fr; }
      .detail-view .psa-result-form .btn { align-self: start; }
    }
    .detail-view .detail-edit-hint { font-size: 11px; color: #666; margin: 0; line-height: 1.3; }
    .detail-view .detail-edit-label { font-size: 12px; color: #666; margin: 0; align-self: center; }
    .detail-view .threshold-legend { font-size: 11px; color: #666; margin: 8px 0 0; }
    .detail-view .pathway-threshold-legend { margin: 0 0 8px; font-size: 12px; }
    .detail-view .pathway-threshold-table-wrap { margin-top: 20px; }
    .detail-view .pathway-threshold-reflow { margin-top: 12px; }
    .detail-view .pathway-threshold-reflow .threshold-label { font-weight: 600; margin-right: 8px; }
    .detail-view .pathway-threshold-hint { margin: 6px 0 0; font-size: 12px; color: #666; }
    .detail-view .pathway-5ari-block { margin-top: 16px; }
    .detail-view .pathway-5ari-hint { margin: 6px 0 0; }
    .detail-view .threshold-label-cell { font-weight: 700; }
    .detail-view .threshold-asterisk { font-weight: 700; color: #333; }
    .detail-view .detail-edit-inline { margin-left: 8px; padding: 4px 10px; font-size: 12px; }
    .detail-view .detail-editable-grid { margin: 0; }
    .detail-view .detail-editable-row { margin: 0; display: flex; flex-wrap: wrap; align-items: baseline; gap: 8px; }
    .detail-view .detail-editable-value { flex: 1 1 auto; min-width: 0; }
    .detail-view .detail-editable-btn { flex-shrink: 0; padding: 4px 10px; font-size: 12px; }
    .detail-view .detail-editable-edit { display: flex; flex-wrap: wrap; align-items: center; gap: 8px; width: 100%; margin-top: 4px; }
    .detail-view .detail-editable-edit.hidden { display: none !important; }
    .detail-view .detail-editable-input { padding: 6px 10px; border: 2px solid #333; font-size: 14px; max-width: 320px; }
    .detail-view .detail-editable-input[type="text"] { min-width: 200px; }
    .detail-view .detail-required-action-select { max-width: 280px; }
    .detail-view .detail-editable-save { padding: 6px 12px; font-size: 13px; }
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0; }
    .toast { position: fixed; bottom: 24px; right: 24px; background: #333; color: #fff; padding: 12px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); display: none; z-index: 1000; }
    .toast.visible { display: block; }

    /* Detail modal overlay */
    #view-detail.detail-modal { position: fixed; inset: 0; z-index: 500; display: flex; align-items: flex-start; justify-content: center; padding: 24px; overflow-y: auto; background: rgba(0,0,0,0.4); }
    #view-detail.detail-modal.hidden { display: none; }
    #view-detail .modal-dialog { background: #fff; border: 2px solid #333; border-radius: 0; width: 100%; max-width: 720px; margin: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.2); position: relative; }
    #view-detail .modal-body { padding: 24px; padding-top: 48px; max-height: calc(100vh - 48px); overflow-y: auto; }
    #view-detail .modal-close { position: absolute; top: 12px; right: 12px; padding: 6px 12px; font-size: 14px; }
    #view-detail .detail-view { border: none; margin: 0; max-width: none; padding: 0; }

    /* Wizard */
    #view-wizard .header-wizard { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    #view-wizard .wizard-close { padding: 6px 12px; font-size: 14px; }
    #view-wizard .wizard-wrap { position: relative; max-width: 560px; margin: 0 auto; }
    #view-wizard .wizard-stepper { display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 24px; padding: 12px 0; border-bottom: none; }
    #view-wizard .wizard-stepper .step { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 14px; border: 2px solid #999; background: #fff; color: #666; }
    #view-wizard .wizard-stepper .step.active { border-color: #333; background: #333; color: #fff; }
    #view-wizard .wizard-stepper .step.done { border-color: #333; color: #333; background: #fff; }
    #view-wizard .wizard-stepper .step-connector { width: 24px; height: 2px; background: #999; }
    #view-wizard .wizard h2 { margin: 0 0 4px; font-size: 1.25rem; font-weight: 700; color: #333; }
    #view-wizard .wizard .wizard-step-num { color: #999; font-weight: 600; }
    #view-wizard .wizard .step-intro { font-size: 14px; line-height: 1.5; color: #555; margin-bottom: 20px; max-width: 36em; }
    #view-wizard .step-label { font-size: 12px; color: #555; margin-bottom: 16px; }

    /* Discard modal */
    #wizard-discard-modal { position: fixed; inset: 0; z-index: 600; display: none; align-items: center; justify-content: center; padding: 24px; background: rgba(0,0,0,0.4); }
    #wizard-discard-modal.visible { display: flex; }
    #wizard-discard-modal .modal-inner { background: #fff; border: 2px solid #333; padding: 24px; max-width: 360px; }
    #wizard-discard-modal h3 { margin: 0 0 8px; font-size: 1.1rem; }
    #wizard-discard-modal p { margin: 0 0 16px; font-size: 14px; color: #555; }
    #wizard-discard-modal .modal-actions { display: flex; gap: 8px; justify-content: flex-end; }
  </style>
</head>
<body>

  <!-- Dashboard -->
  <div id="view-dashboard">
    <header class="header">
      <h1>PSA Monitoring</h1>
      <div class="header-actions">
        <div class="view-toggle">
          <a href="#" id="link-kanban" class="active">Board</a>
          <a href="#" id="link-list">List</a>
        </div>
        <a href="#" class="btn btn-primary" id="btn-add-patient">Add New Patient</a>
      </div>
    </header>
    <main>
      <div class="dashboard-toolbar" id="dashboard-toolbar">
        <div class="toolbar-group">
          <label for="filter-nhs">Search</label>
          <input type="text" id="filter-nhs" placeholder="Search by NHS# or name" aria-label="Search by NHS number or name">
        </div>
        <div class="toolbar-group">
          <label for="filter-protocol">Protocol</label>
          <select id="filter-protocol" aria-label="Filter by protocol">
            <option value="">All protocols</option>
            <option value="RP" title="Radical Prostatectomy">RP</option>
            <option value="EBRT" title="EBRT (external beam radiotherapy)">EBRT</option>
            <option value="Brachy" title="Brachytherapy">Brachy</option>
            <option value="ADT" title="Primary ADT (androgen deprivation therapy)">ADT</option>
            <option value="Intermittent hormones" title="Intermittent hormones">Intermittent hormones</option>
            <option value="Watchful waiting" title="Watchful waiting">Watchful waiting</option>
            <option value="Active surveillance" title="Active surveillance">Active surveillance</option>
          </select>
        </div>
        <div class="toolbar-group list-only-sort" id="toolbar-sort-wrap" style="display: none;">
          <label for="list-sort">Sort by</label>
          <select id="list-sort" aria-label="Sort list">
            <option value="status" selected>Status</option>
            <option value="last-updated">Last updated</option>
            <option value="due-date">Due date</option>
          </select>
        </div>
      </div>
      <!-- Board view: Upcoming, Awaiting Results, Completed, Review Required, Follow-up Required. Recall and Discharged hidden. -->
      <div id="kanban-view" class="board-container">
        <div class="board">
          <div class="column">
            <div class="column-header">Upcoming</div>
            <div class="column-note">PSA due in the next 4 weeks. Prepare the patient for the test; when the sample is with the lab, move the card to Awaiting Results.</div>
            <div class="column-cards">
              <div class="card" data-detail="john-smith" data-status="upcoming">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">123 456 7890</div>
                <div class="card-name">Smith, John • 68</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Radical Prostatectomy">RP</span><span class="card-chip-phase">Year 1</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA <strong>0.02</strong> <span class="card-threshold">/ 0.03 ✓</span></div>
                  <div class="card-sparkline"><span style="height:93%"></span><span style="height:83%"></span><span style="height:70%"></span><span style="height:67%"></span></div>
                </div>
                <div class="card-due-line">Due 12 Apr 2025</div>
                <div class="card-last-updated">Last updated: 28 Jan 2025</div>
              </div>
              <div class="card" data-detail="alan-jones" data-status="upcoming">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">987 654 3210</div>
                <div class="card-name">Jones, Alan • 72</div>
                <div class="card-chips"><span class="card-chip-protocol" title="EBRT (external beam radiotherapy)">EBRT</span><span class="card-chip-phase">Year 1</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA <strong>1.2</strong> <span class="card-threshold">/ 2.0 ✓</span></div>
                  <div class="card-sparkline"><span style="height:60%"></span></div>
                </div>
                <div class="card-due-line">Due 28 Mar 2025</div>
                <div class="card-last-updated">Last updated: 5 Feb 2025</div>
              </div>
              <div class="card" data-detail="emma-reid" data-status="upcoming">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">700 800 9012</div>
                <div class="card-name">Reid, Emma • 63</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Radical Prostatectomy">RP</span><span class="card-chip-phase">Year 1</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA <strong>0.018</strong> <span class="card-threshold">/ 0.02 ✓</span></div>
                  <div class="card-sparkline"><span style="height:90%"></span><span style="height:85%"></span></div>
                </div>
                <div class="card-due-line">Due 8 Feb 2025</div>
                <div class="card-last-updated">Last updated: 6 Feb 2025</div>
              </div>
            </div>
          </div>
          <div class="column">
            <div class="column-header">Awaiting Results</div>
            <div class="column-note">Sample with the lab. When the result comes back, the card moves to Completed if PSA is at or below threshold, or to Review Required if it is above.</div>
            <div class="column-cards">
              <div class="card" data-detail="david-brown" data-status="awaiting">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">555 111 2233</div>
                <div class="card-name">Brown, David • 65</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Radical Prostatectomy">RP</span><span class="card-chip-phase">Year 3</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA <strong>0.025</strong></div>
                  <div class="card-sparkline"><span style="height:100%"></span><span style="height:91%"></span><span style="height:86%"></span><span style="height:83%"></span><span style="height:83%"></span></div>
                </div>
                <div class="card-due-line">Waiting for 5 days</div>
                <div class="card-last-updated">Last updated: 2 Feb 2025</div>
              </div>
              <div class="card" data-detail="robert-wilson" data-status="awaiting">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">444 555 6677</div>
                <div class="card-name">Wilson, Robert • 70</div>
                <div class="card-chips"><span class="card-chip-protocol" title="EBRT (external beam radiotherapy)">EBRT</span><span class="card-chip-phase">Year 2</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA —</div>
                  <div class="card-sparkline" aria-label="No PSA results on record"></div>
                </div>
                <div class="card-due-line overdue">15 days overdue</div>
                <div class="card-last-updated">Last updated: 27 Jan 2025</div>
              </div>
              <div class="card" data-detail="david-patel" data-status="awaiting">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">300 400 5002</div>
                <div class="card-name">Patel, David • 61</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Intermittent hormones">Intermittent hormones</span><span class="card-chip-phase">Year 1</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">Last PSA <strong>6.0</strong></div>
                  <div class="card-sparkline"><span style="height:55%"></span><span style="height:52%"></span><span style="height:60%"></span></div>
                </div>
                <div class="card-due-line">Waiting for 3 days</div>
                <div class="card-last-updated">Last updated: 4 Feb 2025</div>
              </div>
            </div>
          </div>
          <div class="column completed">
            <div class="column-header">Completed</div>
            <div class="column-note">Result normal. Cards stay here for 7 days so you can spot-check; after 7 days they reset and return to Recall until their next test is due.</div>
            <div class="column-cards">
              <div class="card" data-detail="peter-green" data-status="completed">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">222 333 4455</div>
                <div class="card-name">Green, Peter • 67</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Radical Prostatectomy">RP</span><span class="card-chip-phase">Year 4</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">PSA <strong>0.02</strong> <span class="card-threshold">/ 0.03 ✓</span></div>
                  <div class="card-sparkline"><span style="height:100%"></span><span style="height:88%"></span><span style="height:78%"></span><span style="height:72%"></span><span style="height:69%"></span><span style="height:63%"></span></div>
                </div>
                <div class="card-due-line">Next due Sep 2025</div>
                <div class="card-last-updated">Last updated: 5 Feb 2025</div>
              </div>
              <div class="card" data-detail="ian-collins" data-status="completed">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">200 300 4001</div>
                <div class="card-name">Collins, Ian • 64</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Primary ADT (androgen deprivation therapy)">ADT</span><span class="card-chip-phase">Year 2</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">PSA <strong>2.5</strong> <span class="card-threshold">/ 4.0 ✓</span></div>
                  <div class="card-sparkline"><span style="height:63%"></span><span style="height:58%"></span><span style="height:55%"></span></div>
                </div>
                <div class="card-due-line">Next due Apr 2025</div>
                <div class="card-last-updated">Last updated: 4 Feb 2025</div>
              </div>
              <div class="card" data-detail="frank-wright" data-status="completed">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">400 500 6003</div>
                <div class="card-name">Wright, Frank • 76</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Watchful waiting">Watchful waiting</span><span class="card-chip-phase">Year 2</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line">PSA <strong>18</strong> <span class="card-threshold">/ 30.0 ✓</span></div>
                  <div class="card-sparkline"><span style="height:52%"></span><span style="height:55%"></span><span style="height:60%"></span></div>
                </div>
                <div class="card-due-line">Next due Jun 2025</div>
                <div class="card-last-updated">Last updated: 5 Feb 2025</div>
              </div>
            </div>
          </div>
          <div class="column alert">
            <div class="column-header">Review Required</div>
            <div class="column-note">PSA is above threshold. Review the trend and result, then either add a follow-up action and move to Follow-up Required, or send the card back to Recall.</div>
            <div class="column-cards">
              <div class="card" data-detail="michael-clark" data-status="action">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">777 888 9900</div>
                <div class="card-name">Clark, Michael • 69</div>
                <div class="card-chips"><span class="card-chip-protocol" title="Radical Prostatectomy">RP</span><span class="card-chip-phase">Year 2</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line"><strong>PSA 0.06</strong> <span class="card-threshold">/ 0.03</span></div>
                  <div class="card-sparkline"><span style="height:25%"></span><span style="height:62%"></span><span style="height:100%"></span></div>
                </div>
                <div class="card-context"><span class="card-context-icon" aria-hidden="true">↑</span> Δ +0.03 vs threshold</div>
                <div class="card-last-updated">Last updated: 28 Jan 2025</div>
              </div>
            </div>
          </div>
          <div class="column">
            <div class="column-header">Follow-up Required</div>
            <div class="column-note">A follow-up action is in place. When it is done, move the card back to Recall.</div>
            <div class="column-cards">
              <div class="card" data-detail="philip-hayes" data-status="action_required">
                <button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button>
                <div class="card-nhs">555 666 7788</div>
                <div class="card-name">Hayes, Philip • 68</div>
                <div class="card-chips"><span class="card-chip-protocol" title="EBRT (external beam radiotherapy)">EBRT</span><span class="card-chip-phase">Year 2</span></div>
                <div class="card-psa-trend-row">
                  <div class="card-psa-line"><strong>PSA 2.4</strong> <span class="card-threshold">/ 2.0</span></div>
                  <div class="card-sparkline"><span style="height:50%"></span><span style="height:63%"></span><span style="height:75%"></span><span style="height:100%"></span></div>
                </div>
                <div class="card-context"><span class="card-context-icon" aria-hidden="true">&#9888;</span> Urgent Suspected Cancer</div>
                <div class="card-last-updated">Last updated: 29 Jan 2025</div>
              </div>
            </div>
          </div>
        </div>
        <div id="card-actions-dropdown" class="card-actions-dropdown" role="menu" aria-label="Card actions"></div>
      </div>

      <!-- List view: All (separate), then Pathway, GP focus, Exit -->
      <div id="list-view" class="list-view hidden">
        <div class="tabs" id="list-tabs-container">
          <div class="tabs-group" aria-label="All">
            <button type="button" data-tab="all">All <span class="list-tab-count"></span></button>
          </div>
          <div class="tabs-group" aria-label="Pathway">
            <button type="button" data-tab="recall" class="active" title="Recall: everyone on pathway waiting for their next due date, or recalled to clinic">Recall <span class="list-tab-count"></span></button>
            <button type="button" data-tab="upcoming">Upcoming <span class="list-tab-count"></span></button>
            <button type="button" data-tab="awaiting">Awaiting <span class="list-tab-count"></span></button>
            <button type="button" data-tab="completed">Completed <span class="list-tab-count"></span></button>
          </div>
          <div class="tabs-group" aria-label="GP focus">
            <button type="button" data-tab="action">Review Required <span class="list-tab-count"></span></button>
            <button type="button" data-tab="action_required">Follow-up Required <span class="list-tab-count"></span></button>
          </div>
          <div class="tabs-group" aria-label="Exit">
            <button type="button" data-tab="discharged">Discharged <span class="list-tab-count"></span></button>
          </div>
        </div>
        <table>
          <thead>
            <tr>
              <th>Patient</th>
              <th>NHS No</th>
              <th class="col-status">Status</th>
              <th>Protocol</th>
              <th>Schedule</th>
              <th>Diagnoses</th>
              <th>Trend</th>
              <th>Last PSA (ng/mL)</th>
              <th>Threshold</th>
              <th>Δ</th>
              <th>Next Due</th>
              <th>Last updated</th>
            </tr>
          </thead>
          <tbody id="list-tbody">
            <tr data-tab="upcoming" data-status="upcoming" data-detail="john-smith"><td>Smith, John (68)</td><td>123 456 7890</td><td class="col-status"><span class="status-badge status-upcoming">Upcoming</span></td><td title="Radical Prostatectomy">RP</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:93%"></span><span style="height:83%"></span><span style="height:70%"></span><span style="height:67%"></span></div></td><td>0.02</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.01 below threshold">↓ −0.01</span></td><td>12 Apr 2025</td><td>28 Jan 2025</td></tr>
            <tr data-tab="upcoming" data-status="upcoming" data-detail="alan-jones"><td>Jones, Alan (72)</td><td>987 654 3210</td><td class="col-status"><span class="status-badge status-upcoming">Upcoming</span></td><td title="EBRT (external beam radiotherapy)">EBRT</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:60%"></span></div></td><td>1.2</td><td class="threshold-cell">2.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.8 below threshold">↓ −0.8</span></td><td>28 Mar 2025</td><td>5 Feb 2025</td></tr>
            <tr data-tab="upcoming" data-status="upcoming" data-detail="nicholas-bell"><td>Bell, Nicholas (67)</td><td>111 333 5555</td><td class="col-status"><span class="status-badge status-upcoming">Upcoming</span></td><td title="Brachytherapy">Brachy</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:40%"></span><span style="height:30%"></span></div></td><td>0.15</td><td class="threshold-cell">0.5</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.35 below threshold">↓ −0.35</span></td><td>28 Mar 2025</td><td>6 Feb 2025</td></tr>
            <tr data-tab="upcoming" data-status="upcoming" data-detail="harry-nelson"><td>Nelson, Harry (69)</td><td>500 600 7004</td><td class="col-status"><span class="status-badge status-upcoming">Upcoming</span></td><td title="Active surveillance">Active surveillance</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:50%"></span><span style="height:55%"></span><span style="height:58%"></span></div></td><td>8.2</td><td class="threshold-cell">15.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="6.8 below threshold">↓ −6.8</span></td><td>1 May 2025</td><td>6 Feb 2025</td></tr>
            <tr data-tab="upcoming" data-status="upcoming" data-detail="emma-reid"><td>Reid, Emma (63)</td><td>700 800 9012</td><td class="col-status"><span class="status-badge status-upcoming">Upcoming</span></td><td title="Radical Prostatectomy">RP</td><td>Year 1</td><td class="col-diagnoses">Localised</td><td><div class="sparkline-inline"><span style="height:90%"></span><span style="height:85%"></span></div></td><td>0.018</td><td class="threshold-cell">0.02*</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.01 below threshold">↓ −0.01</span></td><td>8 Feb 2025</td><td>6 Feb 2025</td></tr>
            <tr data-tab="awaiting" data-status="awaiting" data-detail="david-brown"><td>Brown, David (65)</td><td>555 111 2233</td><td class="col-status"><span class="status-badge status-awaiting">Awaiting</span></td><td title="Radical Prostatectomy">RP</td><td>Year 3</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:100%"></span><span style="height:91%"></span><span style="height:86%"></span><span style="height:83%"></span><span style="height:83%"></span></div></td><td>0.025</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.01 below threshold">↓ −0.01</span></td><td>—</td><td>2 Feb 2025</td></tr>
            <tr data-tab="awaiting" data-status="awaiting" data-detail="robert-wilson"><td>Wilson, Robert (70)</td><td>444 555 6677</td><td class="col-status"><span class="status-badge status-awaiting">Awaiting</span></td><td title="EBRT (external beam radiotherapy)">EBRT</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline" aria-label="No PSA results on record"></div></td><td>—</td><td class="threshold-cell">2.0</td><td class="list-delta-cell">—</td><td>—</td><td>27 Jan 2025</td></tr>
            <tr data-tab="awaiting" data-status="awaiting" data-detail="david-patel"><td>Patel, David (61)</td><td>300 400 5002</td><td class="col-status"><span class="status-badge status-awaiting">Awaiting</span></td><td title="Intermittent hormones">Intermittent hormones</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:55%"></span><span style="height:52%"></span><span style="height:60%"></span></div></td><td>6.0</td><td class="threshold-cell">10.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="4.0 below threshold">↓ −4.0</span></td><td>—</td><td>4 Feb 2025</td></tr>
            <tr data-tab="action" data-status="action" data-detail="michael-clark"><td>Clark, Michael (69)</td><td>777 888 9900</td><td class="col-status"><span class="status-badge status-action">Review Required</span></td><td title="Radical Prostatectomy">RP</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:25%"></span><span style="height:62%"></span><span style="height:100%"></span></div></td><td>0.06</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-above" aria-label="0.03 above threshold">↑ +0.03</span></td><td>Review</td><td>28 Jan 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="peter-green"><td>Green, Peter (67)</td><td>222 333 4455</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="Radical Prostatectomy">RP</td><td>Year 4</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:100%"></span><span style="height:88%"></span><span style="height:78%"></span><span style="height:72%"></span><span style="height:69%"></span><span style="height:63%"></span></div></td><td>0.02</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.01 below threshold">↓ −0.01</span></td><td>Sep 2025</td><td>5 Feb 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="george-walsh"><td>Walsh, George (69)</td><td>111 222 3344</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="Radical Prostatectomy">RP</td><td>Year 3</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:55%"></span><span style="height:52%"></span><span style="height:48%"></span><span style="height:45%"></span></div></td><td>0.01</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.02 below threshold">↓ −0.02</span></td><td>Sep 2025</td><td>3 Feb 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="terence-bennett"><td>Bennett, Terence (74)</td><td>333 444 5566</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="EBRT (external beam radiotherapy)">EBRT</td><td>Year 4</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:25%"></span><span style="height:28%"></span><span style="height:30%"></span><span style="height:32%"></span></div></td><td>0.8</td><td class="threshold-cell">2.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="1.2 below threshold">↓ −1.2</span></td><td>Sep 2025</td><td>1 Feb 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="kevin-shaw"><td>Shaw, Kevin (66)</td><td>888 999 0011</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="Radical Prostatectomy">RP</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:40%"></span><span style="height:38%"></span><span style="height:35%"></span></div></td><td>0.02</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.01 below threshold">↓ −0.01</span></td><td>May 2025</td><td>15 Jan 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="ian-collins"><td>Collins, Ian (64)</td><td>200 300 4001</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="Primary ADT (androgen deprivation therapy)">ADT</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:63%"></span><span style="height:58%"></span><span style="height:55%"></span></div></td><td>2.5</td><td class="threshold-cell">4.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="1.5 below threshold">↓ −1.5</span></td><td>Apr 2025</td><td>4 Feb 2025</td></tr>
            <tr data-tab="completed" data-status="completed" data-detail="frank-wright"><td>Wright, Frank (76)</td><td>400 500 6003</td><td class="col-status"><span class="status-badge status-completed">Completed</span></td><td title="Watchful waiting">Watchful waiting</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:52%"></span><span style="height:55%"></span><span style="height:60%"></span></div></td><td>18</td><td class="threshold-cell">30.0</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="12 below threshold">↓ −12</span></td><td>Jun 2025</td><td>5 Feb 2025</td></tr>
            <tr data-tab="recall" data-status="recall" data-detail="james-taylor"><td>Taylor, James (71)</td><td>666 777 8899</td><td class="col-status"><span class="status-badge status-recall">Recall</span></td><td title="Radical Prostatectomy">RP</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:33%"></span><span style="height:67%"></span><span style="height:100%"></span></div></td><td>0.12</td><td class="threshold-cell">0.03*</td><td class="list-delta-cell"><span class="list-delta-above" aria-label="0.09 above threshold">↑ +0.09</span></td><td>Recall</td><td>30 Jan 2025</td></tr>
            <tr data-tab="action_required" data-status="action_required" data-detail="philip-hayes"><td>Hayes, Philip (68)</td><td>555 666 7788</td><td class="col-status"><span class="status-badge status-action_required">Follow-up Required</span></td><td title="EBRT (external beam radiotherapy)">EBRT</td><td>Year 2</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:50%"></span><span style="height:63%"></span><span style="height:75%"></span><span style="height:100%"></span></div></td><td>2.4</td><td class="threshold-cell">2.0</td><td class="list-delta-cell"><span class="list-delta-above" aria-label="0.4 above threshold">↑ +0.4</span></td><td>Urgent Suspected Cancer</td><td>29 Jan 2025</td></tr>
            <tr data-tab="recall" data-status="recall" data-detail="stephen-webb"><td>Webb, Stephen (70)</td><td>999 000 1122</td><td class="col-status"><span class="status-badge status-recall">Recall</span></td><td title="Brachytherapy">Brachy</td><td>Year 1</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:29%"></span><span style="height:50%"></span><span style="height:71%"></span><span style="height:100%"></span></div></td><td>0.7</td><td class="threshold-cell">0.5</td><td class="list-delta-cell"><span class="list-delta-above" aria-label="0.2 above threshold">↑ +0.2</span></td><td>Recall</td><td>4 Feb 2025</td></tr>
            <tr data-tab="discharged" data-status="discharged" data-detail="arthur-discharged"><td>Smith, Arthur (72)</td><td>600 700 8005</td><td class="col-status"><span class="status-badge status-discharged">Discharged</span></td><td title="Radical Prostatectomy">RP</td><td>Year 5</td><td class="col-diagnoses"></td><td><div class="sparkline-inline"><span style="height:100%"></span><span style="height:95%"></span><span style="height:90%"></span></div></td><td>0.01</td><td class="threshold-cell">0.03</td><td class="list-delta-cell"><span class="list-delta-below" aria-label="0.02 below threshold">↓ −0.02</span></td><td>—</td><td>1 Feb 2025</td></tr>
          </tbody>
        </table>
        <p class="threshold-legend" id="list-threshold-legend">Δ = PSA − threshold (↑ above, ↓ below). * Custom threshold. Shown when a result is available.</p>
      </div>
    </main>
  </div>

  <!-- Add Patient Wizard -->
  <div id="view-wizard" class="hidden">
    <header class="header header-wizard">
      <h1>Add New Patient</h1>
      <button type="button" class="btn btn-secondary wizard-close" id="wizard-close" aria-label="Close">× Close</button>
    </header>
    <main>
      <div class="wizard-wrap">
        <div class="wizard-stepper" aria-label="Progress">
          <span class="step" id="stepper-1" aria-current="true">1</span>
          <span class="step-connector"></span>
          <span class="step" id="stepper-2">2</span>
          <span class="step-connector"></span>
          <span class="step" id="stepper-3">3</span>
        </div>
      <div class="wizard">
        <!-- Step 1 -->
        <div id="wizard-step1">
          <h2><span class="wizard-step-num" aria-hidden="true">1. </span>Find the patient</h2>
          <p class="step-intro">Specify patient's NHS number to add them to the monitoring registry.</p>
          <div class="form-group">
            <label for="nhs-number">Search by NHS number</label>
            <input type="text" id="nhs-number" placeholder="e.g. 123 456 7890" value="" aria-label="Search by NHS number">
          </div>
          <button type="button" class="btn btn-primary" id="wizard-search">Find</button>
          <div id="step1-result" class="hidden">
            <div class="step1-patient-card" id="step1-patient-card">
              <button type="button" class="step1-patient-clear" id="step1-patient-clear" aria-label="Clear selection">×</button>
              <div class="step1-patient-nhs" id="pas-nhs-label">NHS</div>
              <p id="pas-nhs" class="step1-patient-meta">—</p>
              <p class="step1-patient-name" id="pas-name">—</p>
              <p class="step1-patient-meta" id="pas-dob">—</p>
              <p class="step1-patient-meta" id="pas-practice">—</p>
              <p class="step1-patient-meta" id="pas-address">—</p>
            </div>
            <div class="actions wizard-nav">
              <span aria-hidden="true"></span>
              <button type="button" class="btn btn-primary" id="wizard-step1-next">Confirm and continue</button>
            </div>
          </div>
        </div>
        <!-- Step 2 -->
        <div id="wizard-step2" class="hidden">
          <h2><span class="wizard-step-num" aria-hidden="true">2. </span>Select pathway</h2>
          <p class="step-intro">Choose the patient's PSA monitoring pathway. This sets the protocol rules you'll use to build the monitoring schedule next.</p>
          <div class="form-group">
            <p style="margin:0 0 8px;font-weight:600;">Is prostate cancer confirmed?</p>
            <div class="protocol-option" style="margin-bottom:8px;">
              <input type="radio" name="cancer-confirmed" id="cancer-yes" value="yes" />
              <label for="cancer-yes">Yes</label>
            </div>
            <div class="protocol-option" style="margin-bottom:16px;">
              <input type="radio" name="cancer-confirmed" id="cancer-no" value="no" />
              <label for="cancer-no">No</label>
            </div>
          </div>
          <div id="wizard-pathway-cancer" class="hidden">
            <p style="margin:0 0 8px;font-weight:600;">Select pathway</p>
            <p class="wizard-hint" style="margin-bottom:12px;">Pick the pathway that matches the patient's current status or treatment.</p>
            <fieldset class="protocol-radios" aria-describedby="protocol-help">
              <legend class="sr-only">Pathway</legend>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-radical" value="radical" /><label for="protocol-radical">Radical Prostatectomy</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-ebrt" value="ebrt" /><label for="protocol-ebrt">EBRT (external beam radiotherapy)</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-brachy" value="brachytherapy" /><label for="protocol-brachy">Brachytherapy</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-adt" value="primary-adt" /><label for="protocol-adt">Primary ADT (androgen deprivation therapy)</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-intermittent" value="intermittent-hormones" /><label for="protocol-intermittent">Intermittent hormones</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-watchful" value="watchful-waiting" /><label for="protocol-watchful">Watchful waiting</label></div>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-active-surveillance" value="active-surveillance" /><label for="protocol-active-surveillance">Active surveillance</label></div>
            </fieldset>
          </div>
          <div id="wizard-pathway-non-cancer" class="hidden">
            <p style="margin:0 0 8px;font-weight:600;">Select pathway</p>
            <p class="wizard-hint" style="margin-bottom:12px;">Pick the pathway that matches the patient's current status.</p>
            <fieldset class="protocol-radios">
              <legend class="sr-only">Pathway</legend>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-general-psa" value="general-psa-monitoring" /><label for="protocol-general-psa">General PSA monitoring</label></div>
              <p class="wizard-hint" style="margin:-4px 0 12px 24px;font-size:12px;">Ongoing PSA checks without a cancer diagnosis.</p>
              <div class="protocol-option"><input type="radio" name="protocol" id="protocol-raised-psa" value="raised-psa-follow-up" /><label for="protocol-raised-psa">Raised PSA follow-up</label></div>
              <p class="wizard-hint" style="margin:-4px 0 12px 24px;font-size:12px;">Repeat PSA after a raised result to decide on referral.</p>
            </fieldset>
          </div>
          <p id="protocol-help" class="protocol-help hidden" role="status"></p>
          <div class="form-group">
            <p style="margin:0 0 8px;font-weight:600;">Ownership</p>
            <p class="wizard-hint" style="margin:0 0 8px;">Who will manage recalls and act on results.</p>
            <div class="protocol-option" style="margin-bottom:8px;">
              <input type="radio" name="ownership" id="ownership-gp" value="GP" checked />
              <label for="ownership-gp">General Practice</label>
            </div>
            <div class="protocol-option">
              <input type="radio" name="ownership" id="ownership-urology" value="Urology" />
              <label for="ownership-urology">Urology</label>
            </div>
          </div>
          <div class="form-group" id="wizard-anchor-wrap">
            <label for="anchor-date">Date of surgery or start of the treatment</label>
            <p class="wizard-hint" style="margin:0 0 8px;">Used to calculate year of follow-up, monitoring frequency, and discharge.</p>
            <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
              <input type="date" id="anchor-date" value="">
              <span id="phase-output" class="phase-inline" style="display:none;font-weight:700;font-size:14px;white-space:nowrap;padding:4px 10px;background:#e3f2fd;">Year <span id="phase-text">—</span></span>
            </div>
          </div>
          <div class="actions wizard-nav">
            <button type="button" class="btn btn-secondary wizard-back" id="wizard-step2-back">Back</button>
            <button type="button" class="btn btn-primary" id="wizard-step2-next">Continue</button>
          </div>
        </div>
        <!-- Step 3 -->
        <div id="wizard-step3" class="hidden">
          <h2><span class="wizard-step-num" aria-hidden="true">3. </span>Set up monitoring schedule</h2>
          <p class="wizard-protocol-label" style="margin:0 0 4px;font-size:13px;color:#666;">Guidelines for <span id="wizard-protocol-heading">—</span></p>
          <div class="form-group protocol-table-wrap" style="margin-top:8px;">
            <table class="protocol-table" id="wizard-protocol-table" aria-label="PSA monitoring schedule by phase">
              <thead>
                <tr><th>Phase (years)</th><th>Threshold (ng/mL)</th><th>Monitoring schedule</th><th title="Monitoring Other Test">MOT</th><th title="Liver Function Test">LFT</th><th></th></tr>
              </thead>
              <tbody id="wizard-protocol-tbody"></tbody>
            </table>
          </div>
          <p class="wizard-hint" style="margin-top:8px;">Edit phase year ranges, threshold, schedule, and MOT/LFT per phase. Add a phase at the end or delete the last phase if needed.</p>
          <button type="button" class="btn btn-secondary" id="wizard-add-phase" style="margin-top:8px;">Add phase</button>
          <p id="wizard-schedule-caveat" class="wizard-guideline-text" style="margin-top:12px;"></p>
          <div class="form-group" style="margin-top:24px;">
            <p style="margin:0 0 8px;font-weight:700;font-size:1rem;">Monitoring</p>
            <p class="step-intro" style="margin:0 0 12px;">Set how often this patient should have a PSA test, and when they should be reviewed for discharge.</p>
            <div style="display:flex;flex-wrap:wrap;align-items:center;gap:16px 24px;margin-bottom:12px;">
              <div>
                <label for="wizard-psa-schedule" class="sr-only">PSA test schedule</label>
                <select id="wizard-psa-schedule" aria-label="PSA test schedule" style="padding:6px 10px;min-width:160px;">
                  <option value="3-monthly">Every 3 months</option>
                  <option value="4-monthly">Every 4 months</option>
                  <option value="6-monthly">Every 6 months</option>
                  <option value="annual">Annually</option>
                </select>
              </div>
              <div>
                <label for="wizard-review-discharge">Review for discharge in</label>
                <select id="wizard-review-discharge" aria-label="Review for discharge in years" style="padding:6px 10px;min-width:120px;margin-left:8px;">
                  <option value="5">5 years</option>
                  <option value="7">7 years</option>
                  <option value="10" selected>10 years</option>
                </select>
              </div>
            </div>
            <p class="wizard-hint" style="margin:0 0 8px;">And require: <span title="Monitoring Other Test">MOT</span> / <span title="Liver Function Test">LFT</span> (from current phase above).</p>
          </div>
          <div class="form-group" style="margin-top:20px;">
            <p style="margin:0 0 8px;font-weight:700;font-size:1rem;">Threshold</p>
            <p class="wizard-hint" style="margin:0 0 8px;">Set a PSA threshold for this patient. Results below this value will be auto-completed. Results at or above it will be flagged for review.</p>
            <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
              <input type="text" id="wizard-threshold-input" value="0.03" placeholder="0.03" inputmode="decimal" style="width:80px;padding:6px 10px;" aria-label="Threshold ng/mL">
              <span>ng/mL</span>
            </div>
            <div class="protocol-option" style="margin-top:12px;">
              <input type="checkbox" id="wizard-5ari-yes" />
              <label for="wizard-5ari-yes">On 5-ARI</label>
            </div>
            <p class="wizard-hint">Finasteride or Dutasteride may result in lower PSA reading.</p>
          </div>
          <p class="wizard-hint" style="margin-top:20px;">You will be able to edit this information later.</p>
          <div class="actions wizard-nav">
            <button type="button" class="btn btn-secondary wizard-back" id="wizard-step3-back">Back</button>
            <button type="button" class="btn btn-primary" id="wizard-submit">+ Add patient</button>
          </div>
        </div>
      </div>
      </div>
    </main>
  </div>

  <!-- Wizard discard confirmation -->
  <div id="wizard-discard-modal" role="dialog" aria-labelledby="discard-modal-title" aria-modal="true">
    <div class="modal-inner">
      <h3 id="discard-modal-title">Discard changes?</h3>
      <p>Your progress will be lost. Are you sure you want to close?</p>
      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" id="discard-cancel">Cancel</button>
        <button type="button" class="btn btn-primary" id="discard-confirm">Discard</button>
      </div>
    </div>
  </div>

  <!-- Card / Patient detail (modal overlay) -->
  <div id="view-detail" class="detail-modal hidden" aria-modal="true" aria-labelledby="detail-modal-title" role="dialog">
    <div class="modal-dialog">
      <button type="button" class="btn btn-secondary modal-close" id="detail-close" aria-label="Close">× Close</button>
      <div class="modal-body">
        <h1 id="detail-modal-title" class="sr-only">Patient detail</h1>
        <div class="detail-view">
        <div class="section">
          <div class="section-title">Patient</div>
          <h2 id="detail-name">—</h2>
          <dl class="detail-grid">
            <dt>NHS No</dt><dd id="detail-nhs">—</dd>
            <dt>DOB</dt><dd id="detail-dob">—</dd>
            <dt>Last updated</dt><dd id="detail-last-updated">—</dd>
          </dl>
          <div class="detail-chips">
            <span class="detail-chip-protocol" id="detail-chip-protocol">—</span>
            <span class="detail-chip-phase" id="detail-chip-phase">—</span>
            <span id="detail-status-badge"></span>
          </div>
        </div>

        <div class="section">
          <div class="section-title">Pathway</div>
          <dl class="detail-grid pathway-diagnosis-row">
            <dt>Pathway</dt><dd id="detail-protocol">—</dd>
            <dt>Ownership</dt>
            <dd>
              <select id="detail-ownership" aria-label="Ownership" style="padding:6px 10px;min-width:160px;">
                <option value="GP">General Practice</option>
                <option value="Urology">Urology</option>
              </select>
            </dd>
            <dt>Diagnosis</dt>
            <dd>
              <div class="detail-editable-row">
                <span id="detail-diagnoses-display" class="detail-editable-value">—</span>
                <div id="detail-diagnoses-edit" class="detail-editable-edit hidden">
                  <div class="diagnosis-select-wrap">
                    <input type="text" id="detail-diagnoses-input" class="detail-editable-input" list="diagnosis-list" placeholder="Choose or type…" aria-label="Diagnoses" autocomplete="off" />
                    <span class="diagnosis-chevron" aria-hidden="true">▼</span>
                    <datalist id="diagnosis-list">
                      <option value="Localised prostate cancer">
                      <option value="Locally advanced prostate cancer">
                      <option value="Metastatic prostate cancer">
                      <option value="Recurrent prostate cancer">
                      <option value="Prostate cancer (unspecified)">
                      <option value="BPH">
                      <option value="Localised prostate cancer, BPH">
                      <option value="Prostate cancer on active surveillance">
                      <option value="Prostate cancer on watchful waiting">
                      <option value="General PSA monitoring">
                      <option value="Raised PSA">
                    </datalist>
                  </div>
                  <button type="button" class="btn btn-secondary detail-editable-save" id="detail-diagnoses-save">Save</button>
                </div>
                <button type="button" class="btn btn-secondary detail-editable-btn" id="detail-diagnoses-edit-btn" aria-label="Edit diagnoses">Edit</button>
              </div>
            </dd>
          </dl>
          <div class="detail-pathway-fields detail-pathway-two-cols">
            <dl class="detail-grid pathway-col-1">
              <dt>Date of surgery or treatment start</dt><dd id="detail-anchor">—</dd>
              <dt>Year of follow-up</dt><dd><span id="detail-year-badge" class="detail-year-badge" style="display:inline-block;padding:4px 10px;background:#e3f2fd;font-weight:700;">—</span></dd>
            </dl>
            <dl class="detail-grid pathway-col-2">
              <dt>Next test due</dt><dd id="detail-next-due">—</dd>
              <dt id="detail-extra-date-label" style="display:none">Last bleed</dt><dd id="detail-extra-date" style="display:none">—</dd>
            </dl>
          </div>
          <div class="pathway-full-width">
            <details class="detail-protocol-rules" id="detail-guidelines-details">
              <summary class="detail-protocol-rules-summary" id="detail-guidelines-summary">Guidelines</summary>
              <div class="detail-protocol-rules-content">
                <div class="protocol-table-wrap">
                  <table class="protocol-table" id="detail-protocol-table" aria-label="PSA monitoring schedule by phase">
                    <thead><tr><th>Phase</th><th>Threshold (ng/mL)</th><th>Monitoring schedule</th><th title="Monitoring Other Test">MOT</th><th title="Liver Function Test">LFT</th></tr></thead>
                    <tbody id="detail-protocol-tbody"></tbody>
                  </table>
                </div>
                <p class="detail-guideline-text" id="detail-protocol-guideline-text"></p>
              </div>
            </details>
            <p class="threshold-legend pathway-threshold-legend">* = personalised for this patient (overrides protocol default).</p>
            <div class="pathway-threshold-reflow">
              <div class="threshold-edit">
                <label for="detail-threshold-input" class="threshold-label">Threshold</label>
                <input type="text" id="detail-threshold-input" value="" placeholder="Same as protocol" inputmode="decimal" aria-label="Threshold (ng/mL)" />
                <span class="detail-psa-unit">ng/mL</span>
                <button type="button" class="btn btn-secondary" id="detail-threshold-save">Save</button>
                <span id="detail-threshold-asterisk" class="threshold-asterisk hidden" aria-hidden="true">*</span>
              </div>
              <p class="wizard-hint pathway-threshold-hint">Protocol default: <span id="detail-protocol-threshold">—</span> ng/mL</p>
            </div>
            <div class="pathway-5ari-block">
              <div class="protocol-option">
                <input type="checkbox" id="detail-5ari-yes" aria-label="On 5-ARI" />
                <label for="detail-5ari-yes">On 5-ARI</label>
              </div>
              <p class="wizard-hint pathway-5ari-hint">May result in lower PSA readings (e.g. finasteride or dutasteride) — noted for clinical context only.</p>
            </div>
          </div>
        </div>

        <div class="section detail-monitoring-section">
          <div class="section-title">Monitoring</div>
          <dl class="detail-grid">
            <dt>PSA test schedule</dt>
            <dd>
              <select id="detail-psa-schedule" aria-label="PSA test schedule">
                <option value="3-monthly">3‑monthly</option>
                <option value="4-monthly">4‑monthly</option>
                <option value="6-monthly">6‑monthly</option>
                <option value="annual">Annual</option>
              </select>
              <button type="button" class="btn btn-secondary" id="detail-psa-schedule-save">Save</button>
            </dd>
            <dt>Review for discharge in</dt>
            <dd>
              <select id="detail-review-discharge" aria-label="Review for discharge in years">
                <option value="">—</option>
                <option value="5">5 years</option>
                <option value="7">7 years</option>
                <option value="10">10 years</option>
              </select>
            </dd>
            <dt>And require</dt>
            <dd id="detail-mot-lft-display" title="MOT: Monitoring Other Test; LFT: Liver Function Test">—</dd>
          </dl>
          <p class="wizard-hint">MOT and LFT requirements are derived from the current phase; they cannot be overridden per patient.</p>
        </div>

        <div class="section detail-psa-section">
          <div class="section-title">PSA</div>

          <div class="psa-subsection psa-subsection-results" id="detail-psa-subsection-results">
            <h3 class="psa-subsection-title">PSA results</h3>
            <div class="psa-subsection-inner">
              <table class="protocol-table" id="detail-psa-results-table" aria-label="PSA results">
                <thead><tr><th>Date of result</th><th>Relative</th><th>PSA (ng/mL)</th><th></th></tr></thead>
                <tbody id="detail-psa-results-tbody"></tbody>
              </table>
              <p id="detail-psa-results-empty" class="detail-psa-results-empty hidden" aria-live="polite">No PSA results on record.</p>
            </div>
          </div>

          <div class="psa-subsection psa-subsection-trend" id="detail-psa-subsection-trend">
            <h3 class="psa-subsection-title">Trend</h3>
            <div class="psa-subsection-inner">
              <p id="detail-sparkline-empty" class="detail-sparkline-empty hidden" aria-live="polite">No PSA results on record.</p>
              <div class="detail-chart-wrap detail-chart-wrap--in-subsection" id="detail-psa-chart-wrap">
                <div class="detail-sparkline" id="detail-sparkline"></div>
                <div class="detail-sparkline-labels" id="detail-sparkline-labels" aria-hidden="true"></div>
              </div>
            </div>
          </div>

          <div class="psa-subsection psa-subsection-latest" id="detail-psa-subsection-latest">
            <h3 class="psa-subsection-title">Latest result</h3>
            <div class="psa-subsection-inner">
              <div id="detail-latest-psa-wrap" class="psa-latest-value">
                <strong id="detail-latest-psa">—</strong><span class="psa-latest-sep"> / </span><span id="detail-psa-threshold">—</span> <span class="detail-psa-unit">ng/mL</span>
              </div>
              <p id="detail-psa-analytical" class="psa-latest-analytical hidden" aria-live="polite"></p>
              <p id="detail-psa-no-result" class="psa-no-result-msg hidden" aria-live="polite">No result recorded yet.</p>
              <p id="detail-psa-threshold-line" class="psa-latest-threshold">
                <span class="psa-latest-threshold-label">Threshold</span> <strong id="detail-psa-threshold-fallback">—</strong> <span class="detail-psa-unit">ng/mL</span>
              </p>
            </div>
          </div>

          <div class="psa-subsection psa-subsection-add-result" id="detail-psa-subsection-add">
            <div id="detail-psa-add-toggle-wrap">
              <button type="button" class="btn btn-secondary" id="detail-psa-add-new-btn">Add new result</button>
            </div>
            <div id="detail-psa-add-form-wrap" class="hidden">
              <h3 class="psa-subsection-title">Record new result</h3>
              <div class="psa-subsection-inner psa-subsection-inner--highlight">
                <p class="detail-psa-edit-hint" id="detail-psa-edit-hint"></p>
                <div class="psa-result-form">
                  <div class="form-field">
                    <label for="detail-psa-result-input">PSA value (ng/mL)</label>
                    <input type="text" id="detail-psa-result-input" placeholder="e.g. 0.06" inputmode="decimal" aria-label="PSA result" />
                  </div>
                  <div class="form-field">
                    <label for="detail-psa-result-date">Date of result</label>
                    <input type="date" id="detail-psa-result-date" aria-label="Date of result" />
                  </div>
                  <button type="button" class="btn btn-primary" id="detail-psa-result-save">Save result</button>
                  <button type="button" class="btn btn-secondary" id="detail-psa-result-close">Close</button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="section" id="detail-required-action-section" style="display:none;">
          <div class="section-title">Required action</div>
          <div class="detail-editable-row">
            <span id="detail-required-action-display" class="detail-editable-value">—</span>
            <div id="detail-required-action-edit" class="detail-editable-edit hidden">
              <select id="detail-required-action-input" class="detail-editable-input detail-required-action-select" aria-label="Required action">
                <option value="">None</option>
                <option value="Urgent Suspected Cancer">Urgent Suspected Cancer</option>
                <option value="Advice & Guidance">Advice &amp; Guidance</option>
                <option value="Repeat PSA">Repeat PSA</option>
                <option value="MDT discussion">MDT discussion</option>
                <option value="Imaging">Imaging</option>
                <option value="GP review">GP review</option>
              </select>
              <button type="button" class="btn btn-secondary detail-editable-save" id="detail-required-action-save">Save</button>
            </div>
            <button type="button" class="btn btn-secondary detail-editable-btn" id="detail-required-action-edit-btn" aria-label="Edit required action">Edit</button>
          </div>
          <p id="detail-required-action-hint" class="wizard-hint"></p>
        </div>

        <div class="section" id="detail-next-steps-section">
          <div class="section-title">Actions</div>
          <div class="actions" id="detail-next-steps-actions"></div>
        </div>
        <div class="section" id="detail-discharge-section">
          <div class="actions" id="detail-discharge-actions"></div>
        </div>
      </div>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>
  <div id="protocol-tooltip" class="protocol-tooltip" role="tooltip" aria-hidden="true"></div>

  <script>
    (function() {
      var viewDashboard = document.getElementById('view-dashboard');
      var viewWizard = document.getElementById('view-wizard');
      var viewDetail = document.getElementById('view-detail');
      var kanbanView = document.getElementById('kanban-view');
      var listView = document.getElementById('list-view');
      var linkKanban = document.getElementById('link-kanban');
      var linkList = document.getElementById('link-list');
      var btnAddPatient = document.getElementById('btn-add-patient');
      var listTbody = document.getElementById('list-tbody');
      var listTabs = document.querySelectorAll('.list-view .tabs button');
      var toastEl = document.getElementById('toast');
      var currentDetailId = null;

      (function initProtocolTooltips() {
        var tip = document.getElementById('protocol-tooltip');
        var showTimer = null;
        var hideTimer = null;
        function show(el) {
          var text = el && el.getAttribute('title');
          if (!text || !tip) return;
          if (showTimer) clearTimeout(showTimer);
          showTimer = setTimeout(function() {
            showTimer = null;
            if (!tip) return;
            tip.textContent = text;
            tip.setAttribute('aria-hidden', 'false');
            var rect = el.getBoundingClientRect();
            var x = rect.left + (rect.width / 2);
            var y = rect.top - 4;
            tip.style.left = Math.max(8, Math.min(x - 140, document.documentElement.clientWidth - 288)) + 'px';
            tip.style.top = (y - 10) + 'px';
            tip.style.transform = 'translateY(-100%)';
            tip.classList.add('visible');
          }, 200);
        }
        function hide() {
          if (showTimer) { clearTimeout(showTimer); showTimer = null; }
          if (hideTimer) clearTimeout(hideTimer);
          hideTimer = setTimeout(function() {
            hideTimer = null;
            if (tip) { tip.classList.remove('visible'); tip.setAttribute('aria-hidden', 'true'); }
          }, 50);
        }
        function isProtocolTarget(el) {
          return el && (el.classList && (el.classList.contains('card-chip-protocol') || el.classList.contains('detail-chip-protocol')) || (el.tagName === 'TD' && el.cellIndex === 3 && el.closest('.list-view')));
        }
        document.body.addEventListener('mouseover', function(e) {
          var el = e.target;
          if (isProtocolTarget(el)) show(el);
        });
        document.body.addEventListener('mouseout', function(e) {
          var el = e.target;
          if (isProtocolTarget(el)) hide();
        });
        document.body.addEventListener('mousemove', function(e) {
          var el = e.target;
          if (!tip || !isProtocolTarget(el) || !tip.classList.contains('visible')) return;
          {
            var rect = el.getBoundingClientRect();
            var x = rect.left + (rect.width / 2);
            var y = rect.top - 4;
            tip.style.left = Math.max(8, Math.min(x - 140, document.documentElement.clientWidth - 288)) + 'px';
            tip.style.top = (y - 10) + 'px';
          }
        });
      })();

      function showView(view) {
        if (viewDashboard) viewDashboard.classList.add('hidden');
        if (viewWizard) viewWizard.classList.add('hidden');
        if (viewDetail) viewDetail.classList.add('hidden');
        if (view) view.classList.remove('hidden');
      }

      function openDetailModal() { if (viewDetail) viewDetail.classList.remove('hidden'); }
      function closeDetailModal() { if (viewDetail) viewDetail.classList.add('hidden'); }

      function showToast(msg) {
        if (toastEl) { toastEl.textContent = msg; toastEl.classList.add('visible'); setTimeout(function() { toastEl.classList.remove('visible'); }, 3000); }
      }

      function on(el, ev, fn) { if (el) el.addEventListener(ev, fn); }

      // View toggle: Board / List
      var toolbarSortWrap = document.getElementById('toolbar-sort-wrap');
      on(linkKanban, 'click', function(e) {
        e.preventDefault();
        if (linkKanban) linkKanban.classList.add('active');
        if (linkList) linkList.classList.remove('active');
        if (kanbanView) kanbanView.classList.remove('hidden');
        if (listView) listView.classList.add('hidden');
        if (toolbarSortWrap) toolbarSortWrap.style.display = 'none';
        applyFilters();
      });
      on(linkList, 'click', function(e) {
        e.preventDefault();
        if (linkList) linkList.classList.add('active');
        if (linkKanban) linkKanban.classList.remove('active');
        if (listView) listView.classList.remove('hidden');
        if (kanbanView) kanbanView.classList.add('hidden');
        if (toolbarSortWrap) toolbarSortWrap.style.display = '';
        updateListTabCounts();
        applyListTab();
        applyFilters();
      });

      function updateListTabCounts() {
        if (!listTbody) return;
        listTabs.forEach(function(btn) {
          var tab = btn.getAttribute('data-tab');
          var count = tab === 'all' ? listTbody.querySelectorAll('tr[data-detail]').length : listTbody.querySelectorAll('tr[data-tab="' + tab + '"]').length;
          var span = btn.querySelector('.list-tab-count');
          if (span) span.textContent = count;
        });
      }
      function applyListTab() {
        applyFilters();
      }

      var wizardStep1 = document.getElementById('wizard-step1');
      var wizardStep2 = document.getElementById('wizard-step2');
      var wizardStep3 = document.getElementById('wizard-step3');
      var stepper1 = document.getElementById('stepper-1');
      var stepper2 = document.getElementById('stepper-2');
      var stepper3 = document.getElementById('stepper-3');
      var discardModal = document.getElementById('wizard-discard-modal');

      function setWizardStep(step) {
        if (stepper1) { stepper1.classList.remove('active', 'done'); stepper1.setAttribute('aria-current', 'false'); }
        if (stepper2) { stepper2.classList.remove('active', 'done'); stepper2.setAttribute('aria-current', 'false'); }
        if (stepper3) { stepper3.classList.remove('active', 'done'); stepper3.setAttribute('aria-current', 'false'); }
        if (step >= 1 && stepper1) { stepper1.classList.add(step > 1 ? 'done' : 'active'); stepper1.setAttribute('aria-current', step === 1 ? 'step' : 'false'); }
        if (step >= 2 && stepper2) { stepper2.classList.add(step > 2 ? 'done' : 'active'); stepper2.setAttribute('aria-current', step === 2 ? 'step' : 'false'); }
        if (step >= 3 && stepper3) { stepper3.classList.add(step > 3 ? 'done' : 'active'); stepper3.setAttribute('aria-current', step === 3 ? 'step' : 'false'); }
      }

      function getWizardStep() {
        if (wizardStep1 && !wizardStep1.classList.contains('hidden')) return 1;
        if (wizardStep2 && !wizardStep2.classList.contains('hidden')) return 2;
        if (wizardStep3 && !wizardStep3.classList.contains('hidden')) return 3;
        return 1;
      }

      // Add Patient
      on(btnAddPatient, 'click', function(e) {
        e.preventDefault();
        showView(viewWizard);
        if (wizardStep1) wizardStep1.classList.remove('hidden');
        if (wizardStep2) wizardStep2.classList.add('hidden');
        if (wizardStep3) wizardStep3.classList.add('hidden');
        var step1Result = document.getElementById('step1-result');
        if (step1Result) step1Result.classList.add('hidden');
        var nhsInput = document.getElementById('nhs-number');
        if (nhsInput) nhsInput.value = '';
        var diagEl = document.getElementById('wizard-diagnoses');
        if (diagEl) diagEl.value = '';
        var ariCb = document.getElementById('wizard-5ari-yes');
        if (ariCb) ariCb.checked = false;
        
        var radicalRadio = document.getElementById('protocol-radical');
        if (radicalRadio) { radicalRadio.checked = true; }
        setWizardStep(1);
      });

      on(document.getElementById('wizard-close'), 'click', function() {
        var step = getWizardStep();
        if (step >= 2 && discardModal) {
          discardModal.classList.add('visible');
        } else {
          showView(viewDashboard);
        }
      });
      on(document.getElementById('discard-cancel'), 'click', function() { if (discardModal) discardModal.classList.remove('visible'); });
      on(document.getElementById('discard-confirm'), 'click', function() {
        if (discardModal) discardModal.classList.remove('visible');
        showView(viewDashboard);
      });
      if (discardModal) discardModal.addEventListener('click', function(e) { if (e.target === discardModal) discardModal.classList.remove('visible'); });

      // Wizard Step 1: mock search
      on(document.getElementById('wizard-search'), 'click', function() {
        var nhsInput = document.getElementById('nhs-number');
        var raw = (nhsInput && nhsInput.value) ? nhsInput.value.replace(/\D/g, '') : '2712127328';
        var formatted = raw ? raw.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3') : '271 212 7328';
        var pasName = document.getElementById('pas-name');
        if (pasName) pasName.textContent = 'Williams, Steve (59)';
        var pasDob = document.getElementById('pas-dob');
        if (pasDob) pasDob.textContent = 'DOB: 12 Nov 1967';
        var pasNhs = document.getElementById('pas-nhs');
        if (pasNhs) pasNhs.textContent = formatted;
        var pasPractice = document.getElementById('pas-practice');
        if (pasPractice) pasPractice.textContent = 'Berrylands Surgery';
        var pasAddress = document.getElementById('pas-address');
        if (pasAddress) pasAddress.textContent = '4517 Washington Ave. Manchester, Kentucky 39495';
        var step1Result = document.getElementById('step1-result');
        if (step1Result) step1Result.classList.remove('hidden');
      });
      on(document.getElementById('step1-patient-clear'), 'click', function() {
        var step1Result = document.getElementById('step1-result');
        if (step1Result) step1Result.classList.add('hidden');
      });
      on(document.getElementById('wizard-step1-next'), 'click', function() {
        if (wizardStep1) wizardStep1.classList.add('hidden');
        if (wizardStep2) wizardStep2.classList.remove('hidden');
        document.querySelectorAll('input[name="cancer-confirmed"]').forEach(function(r) { r.checked = false; });
        document.getElementById('wizard-pathway-cancer').classList.add('hidden');
        document.getElementById('wizard-pathway-non-cancer').classList.add('hidden');
        document.getElementById('wizard-anchor-wrap').style.display = '';
        var r = document.getElementById('protocol-radical');
        if (r && !document.querySelector('input[name="protocol"]:checked')) { r.checked = true; }
        updateProtocolOutput();
        setWizardStep(2);
      });

      on(document.getElementById('wizard-step2-back'), 'click', function() {
        if (wizardStep2) wizardStep2.classList.add('hidden');
        if (wizardStep1) wizardStep1.classList.remove('hidden');
        setWizardStep(1);
      });

      function wizardStep2SyncFromCancer() {
        var cancerYes = document.getElementById('cancer-yes');
        var cancerNo = document.getElementById('cancer-no');
        var pathwayCancer = document.getElementById('wizard-pathway-cancer');
        var pathwayNonCancer = document.getElementById('wizard-pathway-non-cancer');
        var anchorWrap = document.getElementById('wizard-anchor-wrap');
        var diagInput = document.getElementById('wizard-diagnoses');
        var isYes = cancerYes && cancerYes.checked;
        var isNo = cancerNo && cancerNo.checked;
        if (pathwayCancer) pathwayCancer.classList.toggle('hidden', !isYes);
        if (pathwayNonCancer) pathwayNonCancer.classList.toggle('hidden', !isNo);
        if (anchorWrap) anchorWrap.style.display = isYes ? '' : 'none';
        if (isYes) {
          if (diagInput) diagInput.value = 'Localised prostate cancer';
          var rad = document.getElementById('protocol-radical');
          if (rad && !document.querySelector('input[name="protocol"]:checked')) rad.checked = true;
          updateProtocolOutput();
        } else if (isNo) {
          document.querySelectorAll('input[name="protocol"]').forEach(function(r) { r.checked = false; });
          var gen = document.getElementById('protocol-general-psa');
          if (gen) gen.checked = true;
          if (diagInput) diagInput.value = 'General PSA monitoring';
          if (phaseOutput) phaseOutput.style.display = 'none';
          updateProtocolOutput();
        }
      }
      function wizardStep2SyncFromNonCancerPathway() {
        var protocol = getSelectedProtocol();
        var diagInput = document.getElementById('wizard-diagnoses');
        if (!diagInput) return;
        if (protocol === 'raised-psa-follow-up') diagInput.value = 'Raised PSA';
        else if (protocol === 'general-psa-monitoring') diagInput.value = 'General PSA monitoring';
      }
      on(document.getElementById('cancer-yes'), 'change', wizardStep2SyncFromCancer);
      on(document.getElementById('cancer-no'), 'change', wizardStep2SyncFromCancer);
      document.querySelectorAll('#wizard-pathway-non-cancer input[name="protocol"]').forEach(function(r) {
        on(r, 'change', wizardStep2SyncFromNonCancerPathway);
      });

      // Wizard Step 2: protocol radios, phase from anchor, schedule/guideline (aligned with Protocol Matrix)
      // RP Y1 4‑monthly, Y2–5 6‑monthly, Y6–10 annual; EBRT/Brachy per matrix; Primary ADT all years 6‑monthly.
      var protocolConfig = {
        radical: {
          threshold: '0.03',
          help: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.',
          scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.',
          guidelineSummary: 'PSA &lt; 0.03 ng/mL normal. Review if &gt; 0.03; recall if &gt; 0.1 or 2 consecutive rises.',
          getFrequency: function(phaseYear) { return phaseYear === 1 ? '4‑monthly' : phaseYear >= 2 && phaseYear <= 5 ? '6‑monthly' : 'annual'; }
        },
        ebrt: {
          threshold: '2.0',
          help: 'PSA &lt; 2.0 ng/mL (Phoenix criteria) suggests remission. Nadir + 2 ng/mL may trigger further investigation.',
          scheduleSummary: 'Year 1–5: 6‑monthly; Year 6–10: annual.',
          guidelineSummary: 'PSA &lt; 2.0 ng/mL (Phoenix). Review if &gt; 2.0; recall &gt; 2.0 (check for bounce).',
          getFrequency: function(phaseYear) { return phaseYear >= 1 && phaseYear <= 5 ? '6‑monthly' : 'annual'; }
        },
        brachytherapy: {
          threshold: '2.0',
          help: 'PSA &lt; 2.0 ng/mL suggests remission. Year 1 monitoring is 3‑monthly. Check for PSA bounce before recall.',
          scheduleSummary: 'Year 1: 3‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.',
          guidelineSummary: 'PSA &lt; 2.0 ng/mL normal. Review if &gt; 2.0; check for PSA bounce before recall.',
          getFrequency: function(phaseYear) { return phaseYear === 1 ? '3\u2011monthly' : phaseYear >= 2 && phaseYear <= 5 ? '6\u2011monthly' : 'annual'; }
        },
        'primary-adt': {
          threshold: '4.0',
          help: 'PSA &lt; 4.0 ng/mL on ADT. Review if &gt; 4.0; recall if &gt; 4.0 (check testosterone).',
          scheduleSummary: 'All years: 6‑monthly.',
          guidelineSummary: 'PSA &lt; 4.0 ng/mL normal. Review if &gt; 4.0; recall if &gt; 4.0 (check testosterone).',
          getFrequency: function() { return '6‑monthly'; }
        },
        'intermittent-hormones': {
          threshold: '10.0',
          help: 'PSA &lt; 10.0 ng/mL in off‑treatment phase. Review if &gt; 10.0; recall if &gt; 10.0 (restart hormones).',
          scheduleSummary: 'All years: 6‑monthly.',
          guidelineSummary: 'PSA &lt; 10.0 ng/mL normal. Review if &gt; 10.0; recall if &gt; 10.0 (restart hormones).',
          getFrequency: function() { return '6‑monthly'; }
        },
        'watchful-waiting': {
          threshold: '30.0',
          help: 'PSA &lt; 30.0 ng/mL. Review if &gt; 30.0; recall if &gt; 30.0 or doubling time &lt; 1 year.',
          scheduleSummary: 'All years: 6‑monthly.',
          guidelineSummary: 'PSA &lt; 30.0 ng/mL normal. Review if &gt; 30.0; recall if &gt; 30.0 or doubling time &lt; 1 year.',
          getFrequency: function() { return '6‑monthly'; }
        },
        'active-surveillance': {
          threshold: '15.0',
          help: 'PSA monitoring without immediate treatment. Review if rise &gt; 0.75 ng/mL/year or doubling time &lt; 1 year; recall as per local policy.',
          scheduleSummary: 'All years: 6‑monthly.',
          guidelineSummary: 'PSA &lt; 15.0 ng/mL normal. Review if rise &gt; 0.75/year or doubling time &lt; 1 year.',
          getFrequency: function() { return '6‑monthly'; }
        },
        'general-psa-monitoring': {
          threshold: '10.0',
          help: 'Follow local policy. Ongoing PSA checks without a cancer diagnosis.',
          scheduleSummary: 'All years: 6‑monthly (placeholder).',
          guidelineSummary: 'Follow local policy for general PSA monitoring.',
          getFrequency: function() { return '6‑monthly'; }
        },
        'raised-psa-follow-up': {
          threshold: '10.0',
          help: 'Follow local policy. Repeat PSA after a raised result to decide on referral.',
          scheduleSummary: 'All years: 6‑monthly (placeholder).',
          guidelineSummary: 'Follow local policy for raised PSA follow-up.',
          getFrequency: function() { return '6‑monthly'; }
        }
      };
      function getPhaseYearFromAnchor(anchorDateStr) {
        if (!anchorDateStr) return 1;
        var anchor = new Date(anchorDateStr);
        var now = new Date();
        var years = (now - anchor) / (365.25 * 24 * 60 * 60 * 1000);
        return Math.min(10, Math.max(1, Math.floor(years) + 1));
      }
      var phaseOutput = document.getElementById('phase-output');
      var phaseText = document.getElementById('phase-text');
      var protocolHelpEl = document.getElementById('protocol-help');
      function getSelectedProtocol() {
        var r = document.querySelector('input[name="protocol"]:checked');
        return r ? r.value : '';
      }
      function updateProtocolOutput() {
        var v = getSelectedProtocol();
        var cfg = protocolConfig[v];
        var anchorInput = document.getElementById('anchor-date');
        var anchorVal = anchorInput ? anchorInput.value.trim() : '';
        var phaseYear = getPhaseYearFromAnchor(anchorVal);
        if (cfg) {
          if (phaseText) phaseText.textContent = phaseYear;
          if (phaseOutput) phaseOutput.style.display = anchorVal ? '' : 'none';
          if (protocolHelpEl) { protocolHelpEl.innerHTML = cfg.help; protocolHelpEl.classList.remove('hidden'); }
        } else {
          if (phaseText) phaseText.textContent = '—';
          if (phaseOutput) phaseOutput.style.display = 'none';
          if (protocolHelpEl) { protocolHelpEl.textContent = ''; protocolHelpEl.classList.add('hidden'); }
        }
      }
      document.querySelectorAll('input[name="protocol"]').forEach(function(radio) {
        radio.addEventListener('change', function() { updateProtocolOutput(); });
      });
      var anchorDateEl = document.getElementById('anchor-date');
      if (anchorDateEl) anchorDateEl.addEventListener('change', function() { updateProtocolOutput(); buildWizardProtocolTable(); });
      var protocolPhases = {
        radical: [
          { label: 'Year 1', years: [1], schedule: '4\u2011monthly' },
          { label: 'Year 2\u20135', years: [2,3,4,5], schedule: '6\u2011monthly' },
          { label: 'Year 6\u201310', years: [6,7,8,9,10], schedule: 'Annual' }
        ],
        ebrt: [
          { label: 'Year 1\u20135', years: [1,2,3,4,5], schedule: '6\u2011monthly' },
          { label: 'Year 6\u201310', years: [6,7,8,9,10], schedule: 'Annual' }
        ],
        brachytherapy: [
          { label: 'Year 1', years: [1], schedule: '3\u2011monthly' },
          { label: 'Year 2\u20135', years: [2,3,4,5], schedule: '6\u2011monthly' },
          { label: 'Year 6\u201310', years: [6,7,8,9,10], schedule: 'Annual' }
        ],
        'primary-adt': [
          { label: 'All years', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ],
        'intermittent-hormones': [
          { label: 'All years', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ],
        'watchful-waiting': [
          { label: 'All years', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ],
        'active-surveillance': [
          { label: 'All years', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ],
        'general-psa-monitoring': [
          { label: 'Ongoing', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ],
        'raised-psa-follow-up': [
          { label: 'Ongoing', years: [1,2,3,4,5,6,7,8,9,10], schedule: '6\u2011monthly' }
        ]
      };
      function deriveScheduleRowsFromProtocol(protocolKey, scheduleByYear, protocolThreshold) {
        var phases = protocolPhases[protocolKey] || protocolPhases['primary-adt'];
        var cfg = protocolConfig[protocolKey] || { threshold: '0.03' };
        var th = protocolThreshold || cfg.threshold || '0.03';
        return phases.map(function(phase) {
          var y = phase.years;
          var yearFrom = y[0];
          var yearTo = y[y.length - 1];
          var s = (scheduleByYear && scheduleByYear[yearFrom]) ? scheduleByYear[yearFrom] : phase.schedule.replace(/\u2011/g, '-').toLowerCase();
          if (s === '3\u2011monthly') s = '3-monthly';
          if (s === '4\u2011monthly') s = '4-monthly';
          if (s === '6\u2011monthly') s = '6-monthly';
          return { yearFrom: yearFrom, yearTo: yearTo, schedule: s, threshold: th, mot: false, lft: false, isProtocol: true };
        });
      }
      function getThresholdForPhaseYear(scheduleRows, phaseYear) {
        if (!scheduleRows || !scheduleRows.length) return '';
        for (var i = 0; i < scheduleRows.length; i++) {
          var r = scheduleRows[i];
          if (phaseYear >= r.yearFrom && phaseYear <= r.yearTo) return r.threshold;
        }
        var last = scheduleRows[scheduleRows.length - 1];
        return phaseYear > last.yearTo ? last.threshold : (scheduleRows[0].threshold || '');
      }
      function getScheduleByYearFromRows(scheduleRows) {
        var byYear = {};
        if (!scheduleRows) return byYear;
        scheduleRows.forEach(function(r) {
          for (var y = r.yearFrom; y <= r.yearTo; y++) byYear[y] = r.schedule;
        });
        return byYear;
      }
      var wizardScheduleRows = [];
      var scheduleOptions = [
        { value: '3-monthly', label: '3\u2011monthly' },
        { value: '4-monthly', label: '4\u2011monthly' },
        { value: '6-monthly', label: '6\u2011monthly' },
        { value: 'annual', label: 'Annual' }
      ];
      function buildWizardProtocolTable() {
        var v = getSelectedProtocol();
        var cfg = protocolConfig[v] || { threshold: '0.03', getFrequency: function() { return '6\u2011monthly'; } };
        var anchorInput = document.getElementById('anchor-date');
        var anchorVal = anchorInput ? anchorInput.value.trim() : '';
        var currentYear = anchorVal ? getPhaseYearFromAnchor(anchorVal) : null;
        var tbody = document.getElementById('wizard-protocol-tbody');
        if (!tbody) return;
        var rows = wizardScheduleRows.length ? wizardScheduleRows : deriveScheduleRowsFromProtocol(v, undefined, cfg.threshold);
        if (!wizardScheduleRows.length) wizardScheduleRows = rows.slice();
        tbody.innerHTML = '';
        rows.forEach(function(row, idx) {
          var isCurrent = currentYear !== null && currentYear >= row.yearFrom && currentYear <= row.yearTo;
          var tr = document.createElement('tr');
          tr.setAttribute('data-row-idx', String(idx));
          if (isCurrent) tr.classList.add('current-year');
          var phaseLabel = row.yearFrom === row.yearTo ? 'Year ' + row.yearFrom : 'Year ' + row.yearFrom + '\u2013' + row.yearTo;
          var options = scheduleOptions.map(function(opt) {
            var selected = (opt.value === row.schedule) ? ' selected' : '';
            return '<option value="' + opt.value + '"' + selected + '>' + opt.label + '</option>';
          }).join('');
          var motTitle = 'Monitoring Other Test';
          var lftTitle = 'Liver Function Test';
          var delHtml = (idx === rows.length - 1 && rows.length > 1)
            ? '<td><button type="button" class="btn btn-secondary wizard-delete-phase" data-row-idx="' + idx + '" aria-label="Delete last phase">Delete</button></td>'
            : '<td></td>';
          tr.innerHTML = '<td class="phase-range-cell"><label class="sr-only">Phase year from</label><input type="number" min="1" max="20" value="' + row.yearFrom + '" data-field="yearFrom" data-row-idx="' + idx + '" aria-label="Phase start year" style="width:3em;"> <span aria-hidden="true">–</span> <label class="sr-only">Phase year to</label><input type="number" min="1" max="20" value="' + row.yearTo + '" data-field="yearTo" data-row-idx="' + idx + '" aria-label="Phase end year" style="width:3em;"></td><td><input type="text" value="' + (row.threshold || '') + '" data-field="threshold" data-row-idx="' + idx + '" placeholder="' + (cfg.threshold || '0.03') + '" inputmode="decimal" style="width:4em;padding:4px 6px;" aria-label="Threshold ng/mL"></td><td class="override-cell"><select data-field="schedule" data-row-idx="' + idx + '" aria-label="Schedule for ' + phaseLabel + '">' + options + '</select></td><td><input type="checkbox" id="wizard-mot-' + idx + '" data-field="mot" data-row-idx="' + idx + '"' + (row.mot ? ' checked' : '') + ' aria-label="MOT"><label for="wizard-mot-' + idx + '" title="' + motTitle + '">MOT</label></td><td><input type="checkbox" id="wizard-lft-' + idx + '" data-field="lft" data-row-idx="' + idx + '"' + (row.lft ? ' checked' : '') + ' aria-label="LFT"><label for="wizard-lft-' + idx + '" title="' + lftTitle + '">LFT</label></td>' + delHtml;
          tbody.appendChild(tr);
        });
        tbody.querySelectorAll('input[data-field], select[data-field]').forEach(function(el) {
          el.addEventListener('change', function() {
            var idx = parseInt(el.getAttribute('data-row-idx'), 10);
            var field = el.getAttribute('data-field');
            if (wizardScheduleRows[idx] == null) return;
            if (field === 'yearFrom' || field === 'yearTo') wizardScheduleRows[idx][field] = parseInt(el.value, 10) || 1;
            else if (field === 'threshold') wizardScheduleRows[idx].threshold = el.value.trim() || '';
            else if (field === 'schedule') wizardScheduleRows[idx].schedule = el.value;
            else if (field === 'mot') wizardScheduleRows[idx].mot = el.checked;
            else if (field === 'lft') wizardScheduleRows[idx].lft = el.checked;
          });
        });
        tbody.querySelectorAll('.wizard-delete-phase').forEach(function(btn) {
          btn.onclick = function() {
            wizardScheduleRows.pop();
            buildWizardProtocolTable();
          };
        });
        var caveatEl = document.getElementById('wizard-schedule-caveat');
        if (caveatEl && cfg && cfg.help) {
          caveatEl.innerHTML = cfg.help;
        } else if (caveatEl) {
          caveatEl.textContent = '';
        }
      }
      on(document.getElementById('wizard-step2-next'), 'click', function() {
        var v = getSelectedProtocol();
        if (!v) {
          showToast('Please select a pathway.');
          return;
        }
        var cfg = protocolConfig[v] || { threshold: '0.03', getFrequency: function() { return '6\u2011monthly'; } };
        if (wizardStep2) wizardStep2.classList.add('hidden');
        if (wizardStep3) wizardStep3.classList.remove('hidden');
        var heading = document.getElementById('wizard-protocol-heading');
        if (heading) heading.textContent = protocolKeyToName[v] || v;
        wizardScheduleRows = deriveScheduleRowsFromProtocol(v, undefined, cfg.threshold);
        buildWizardProtocolTable();
        updateProtocolOutput();
        var psaScheduleEl = document.getElementById('wizard-psa-schedule');
        var threshInputEl = document.getElementById('wizard-threshold-input');
        var anchorVal = (document.getElementById('anchor-date') && document.getElementById('anchor-date').value) || '';
        var phaseYear = getPhaseYearFromAnchor(anchorVal);
        var row = wizardScheduleRows.filter(function(r) { return phaseYear >= r.yearFrom && phaseYear <= r.yearTo; })[0];
        var effectiveSched = row ? row.schedule : (cfg.getFrequency ? cfg.getFrequency(phaseYear) : '6-monthly');
        if (effectiveSched === '3\u2011monthly' || effectiveSched === '3-monthly') effectiveSched = '3-monthly';
        else if (effectiveSched === '4\u2011monthly' || effectiveSched === '4-monthly') effectiveSched = '4-monthly';
        else if (effectiveSched === '6\u2011monthly' || effectiveSched === '6-monthly') effectiveSched = '6-monthly';
        else if (effectiveSched === 'annual') effectiveSched = 'annual';
        if (psaScheduleEl) psaScheduleEl.value = effectiveSched;
        if (threshInputEl) threshInputEl.value = (row && row.threshold) ? row.threshold : (cfg.threshold || '0.03');
        setWizardStep(3);
      });
      on(document.getElementById('wizard-add-phase'), 'click', function() {
        var v = getSelectedProtocol();
        var cfg = protocolConfig[v] || { threshold: '0.03' };
        var last = wizardScheduleRows.length ? wizardScheduleRows[wizardScheduleRows.length - 1] : null;
        var nextYear = last ? last.yearTo + 1 : 1;
        wizardScheduleRows.push({ yearFrom: nextYear, yearTo: nextYear, schedule: '6-monthly', threshold: cfg.threshold || '0.03', mot: false, lft: false, isProtocol: false });
        buildWizardProtocolTable();
      });

      var wizard5ariYes = document.getElementById('wizard-5ari-yes');
      on(document.getElementById('wizard-step3-back'), 'click', function() {
        if (wizardStep3) wizardStep3.classList.add('hidden');
        if (wizardStep2) wizardStep2.classList.remove('hidden');
        setWizardStep(2);
      });
      var protocolKeyToName = { radical: 'Radical Prostatectomy', ebrt: 'EBRT', brachytherapy: 'Brachytherapy', 'primary-adt': 'Primary ADT', 'intermittent-hormones': 'Intermittent Hormones', 'watchful-waiting': 'Watchful Waiting', 'active-surveillance': 'Active Surveillance', 'general-psa-monitoring': 'General PSA monitoring', 'raised-psa-follow-up': 'Raised PSA follow-up' };
      function getWizardScheduleRows() {
        var tbody = document.getElementById('wizard-protocol-tbody');
        var rows = [];
        if (tbody) {
          tbody.querySelectorAll('tr[data-row-idx]').forEach(function(tr) {
            var idx = parseInt(tr.getAttribute('data-row-idx'), 10);
            var yearFromEl = tr.querySelector('input[data-field="yearFrom"]');
            var yearToEl = tr.querySelector('input[data-field="yearTo"]');
            var threshEl = tr.querySelector('input[data-field="threshold"]');
            var schedEl = tr.querySelector('select[data-field="schedule"]');
            var motEl = tr.querySelector('input[data-field="mot"]');
            var lftEl = tr.querySelector('input[data-field="lft"]');
            var yearFrom = yearFromEl ? (parseInt(yearFromEl.value, 10) || 1) : (wizardScheduleRows[idx] && wizardScheduleRows[idx].yearFrom) || 1;
            var yearTo = yearToEl ? (parseInt(yearToEl.value, 10) || 1) : (wizardScheduleRows[idx] && wizardScheduleRows[idx].yearTo) || 1;
            var threshold = threshEl ? threshEl.value.trim() : (wizardScheduleRows[idx] && wizardScheduleRows[idx].threshold) || '';
            var schedule = schedEl ? schedEl.value : (wizardScheduleRows[idx] && wizardScheduleRows[idx].schedule) || '6-monthly';
            var mot = motEl ? motEl.checked : false;
            var lft = lftEl ? lftEl.checked : false;
            var isProtocol = wizardScheduleRows[idx] ? wizardScheduleRows[idx].isProtocol : false;
            rows.push({ yearFrom: yearFrom, yearTo: yearTo, schedule: schedule, threshold: threshold, mot: mot, lft: lft, isProtocol: isProtocol });
          });
        }
        var scheduleByYear = getScheduleByYearFromRows(rows);
        var v = getSelectedProtocol();
        var protoRows = deriveScheduleRowsFromProtocol(v, undefined, (protocolConfig[v] && protocolConfig[v].threshold) || '0.03');
        var personalScheduleSet = rows.length !== protoRows.length || rows.some(function(r, i) {
          var p = protoRows[i];
          return !p || r.yearFrom !== p.yearFrom || r.yearTo !== p.yearTo || r.schedule !== p.schedule || r.threshold !== (p.threshold || '');
        });
        return { scheduleRows: rows, scheduleByYear: scheduleByYear, personalScheduleSet: personalScheduleSet };
      }
      function addNewPatientFromWizard() {
        var nameEl = document.getElementById('pas-name');
        var dobEl = document.getElementById('pas-dob');
        var nhsEl = document.getElementById('pas-nhs');
        var name = (nameEl && nameEl.textContent) ? nameEl.textContent.replace(/^.*?:\s*/i, '').trim() : 'Unknown';
        var dob = (dobEl && dobEl.textContent) ? dobEl.textContent.replace(/^.*?:\s*/i, '').trim() : '—';
        var nhsRaw = (nhsEl && nhsEl.textContent) ? nhsEl.textContent.replace(/\D/g, '') : '';
        var ownershipEl = document.querySelector('input[name="ownership"]:checked');
        var ownership = (ownershipEl && ownershipEl.value) ? ownershipEl.value : 'GP';
        var nhs = nhsRaw ? nhsRaw.replace(/(\d{3})(\d{3})(\d{4})/, '$1 $2 $3') : '000 000 0000';
        var ageMatch = name.match(/\((\d+)\)/);
        var age = ageMatch ? ageMatch[1] : (function() {
          var m = dob.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/i);
          if (m) {
            var y = parseInt(m[3], 10);
            var now = new Date();
            return String(now.getFullYear() - y);
          }
          return '—';
        })();
        var protocolKey = getSelectedProtocol();
        var protocolName = protocolKeyToName[protocolKey] || 'Radical Prostatectomy';
        var anchorInput = document.getElementById('anchor-date');
        var anchorVal = anchorInput ? anchorInput.value : '';
        var anchorStr = anchorVal ? (function() {
          var d = new Date(anchorVal);
          return d.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + ' ' + d.getFullYear();
        })() : '—';
        var phaseYear = getPhaseYearFromAnchor(anchorVal);
        var phase = 'Year ' + phaseYear;
        var cfg = protocolConfig[protocolKey] || { threshold: '0.03', getFrequency: function() { return '6\u2011monthly'; }, guidelineSummary: '' };
        var scheduleResult = getWizardScheduleRows();
        var scheduleRows = scheduleResult.scheduleRows || [];
        var psaScheduleSelect = document.getElementById('wizard-psa-schedule');
        var effectiveScheduleVal = (psaScheduleSelect && psaScheduleSelect.value) ? psaScheduleSelect.value : '6-monthly';
        var protocolFreq = effectiveScheduleVal === '3-monthly' ? '3\u2011monthly' : effectiveScheduleVal === '4-monthly' ? '4\u2011monthly' : effectiveScheduleVal === '6-monthly' ? '6\u2011monthly' : effectiveScheduleVal;
        var protocolThreshold = cfg.threshold || '0.03';
        var wizardThreshEl = document.getElementById('wizard-threshold-input');
        var threshold = (wizardThreshEl && wizardThreshEl.value.trim()) ? wizardThreshEl.value.trim() : (getThresholdForPhaseYear(scheduleRows, phaseYear) || protocolThreshold);
        var personalThresholdSet = !!(threshold && threshold !== protocolThreshold);
        var reviewDischargeEl = document.getElementById('wizard-review-discharge');
        var reviewForDischargeYears = (reviewDischargeEl && reviewDischargeEl.value) ? parseInt(reviewDischargeEl.value, 10) : undefined;
        var lastPsa = '';
        var lastPsaDate = '';
        var diagnoses = (function() {
          var p = getSelectedProtocol();
          if (p === 'general-psa-monitoring') return 'General PSA monitoring';
          if (p === 'raised-psa-follow-up') return 'Raised PSA';
          if (p) return 'Localised prostate cancer';
          return '';
        })();
        var description = '';
        var on5ari = wizard5ariYes && wizard5ariYes.checked;
        var medication5ARI = on5ari ? 'yes' : 'none';
        var today = new Date();
        var lastUpdated = today.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][today.getMonth()] + ' ' + today.getFullYear();
        var scheduleSummary = cfg.scheduleSummary || 'Year 1–5: 6‑monthly; Year 6–10: annual.';
        var protocolGuideline = cfg.help || cfg.guidelineSummary || 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.';
        var psaDisplay = lastPsa || '—';
        var psaHistory = lastPsa ? [parseFloat(lastPsa, 10)] : [];
        var spark = psaHistory.length ? psaHistory.map(function(v) { var t = parseFloat(threshold) || 0.01; return Math.min(100, Math.round((v / Math.max(t, 0.01)) * 33)); }) : [50];
        var nextDue = 'Next due in 4 months';
        var id = name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
        if (!id) id = 'new-patient';
        if (detailData[id]) id = id + '-' + Date.now();
        var d = {
          name: name.indexOf('(') !== -1 ? name : name + ' (' + age + ')',
          nhs: nhs,
          dob: dob,
          lastUpdated: lastUpdated,
          ownership: ownership,
          badge: protocolName + ' | ' + phase,
          protocol: protocolName,
          phase: phase,
          protocolFrequency: cfg.getFrequency ? cfg.getFrequency(phaseYear) : '6\u2011monthly',
          frequency: protocolFreq,
          personalScheduleSet: scheduleResult.personalScheduleSet,
          scheduleByYear: scheduleResult.scheduleByYear,
          scheduleRows: scheduleRows,
          anchor: anchorStr,
          psa: psaDisplay,
          psaDate: lastPsaDate || undefined,
          protocolThreshold: protocolThreshold,
          threshold: threshold,
          personalThresholdSet: personalThresholdSet,
          nextDue: nextDue,
          lastBleed: '',
          status: 'upcoming',
          spark: spark,
          psaHistory: psaHistory,
          psaResults: psaHistory.length ? [{ date: lastPsaDate || new Date().toISOString().slice(0, 10), value: psaHistory[0] }] : [],
          medication5ARI: medication5ARI,
          diagnoses: diagnoses || '—',
          description: description || '',
          scheduleSummary: scheduleSummary,
          protocolGuideline: protocolGuideline,
          reviewForDischargeYears: reviewForDischargeYears
        };
        detailData[id] = d;
        var shortLabel = protocolName === 'Radical Prostatectomy' ? 'RP' : protocolName === 'EBRT' ? 'EBRT' : protocolName === 'Brachytherapy' ? 'Brachy' : protocolName === 'Primary ADT' ? 'ADT' : protocolName;
        var scheduleLabel = formatScheduleForDisplay(d.frequency);
        var upCol = document.querySelector('.board .column:nth-child(1) .column-cards');
        if (upCol) {
          var card = document.createElement('div');
          card.className = 'card';
          card.setAttribute('data-detail', id);
          card.setAttribute('data-status', 'upcoming');
          var chip5ari = (medication5ARI && medication5ARI !== 'none') ? '<span class="card-chip-5ari" title="On 5-ARI">5-ARI</span>' : '';
          card.innerHTML = '<button type="button" class="card-actions-menu-btn" aria-label="Actions">&#8942;</button><div class="card-nhs">' + nhs + '</div><div class="card-name">' + d.name.replace(/\s*\(\d+\)\s*$/, '').trim() + ' • ' + age + '</div><div class="card-chips"><span class="card-chip-protocol" title="' + protocolName + '">' + shortLabel + '</span><span class="card-chip-phase">' + scheduleLabel + '</span>' + chip5ari + '</div><div class="card-psa-trend-row"><div class="card-psa-line">Last PSA <strong>' + psaDisplay + '</strong> <span class="card-threshold">/ ' + threshold + ' ✓</span></div><div class="card-sparkline">' + spark.map(function(h) { return '<span style="height:' + h + '%"></span>'; }).join('') + '</div></div><div class="card-due-line">' + nextDue + '</div><div class="card-last-updated">Last updated: ' + lastUpdated + '</div>';
          card.addEventListener('click', function(ev) {
            if (ev.target.closest('button')) return;
            openDetail(id);
          });
          upCol.appendChild(card);
          var wrap = document.createElement('div');
          wrap.className = 'sparkline-wrap';
          var sparkEl = card.querySelector('.card-sparkline');
          if (sparkEl && sparkEl.parentNode) {
            sparkEl.parentNode.insertBefore(wrap, sparkEl);
            wrap.appendChild(sparkEl);
            var threshNum = parseFloat(threshold) || 0;
            var maxVal = Math.max.apply(null, spark.concat([threshNum, 0.01]));
            var line = document.createElement('span');
            line.className = 'sparkline-threshold-line';
            line.style.bottom = (threshNum / maxVal * 100) + '%';
            line.setAttribute('aria-hidden', 'true');
            wrap.appendChild(line);
          }
        }
        var listTbody = document.getElementById('list-tbody');
        if (listTbody) {
          var deltaClass = 'list-delta-below';
          var deltaText = '—';
          var p = parseFloat(psaDisplay, 10);
          var t = parseFloat(threshold, 10);
          if (!isNaN(p) && !isNaN(t)) {
            var delta = Math.round((p - t) * 100) / 100;
            deltaClass = delta > 0 ? 'list-delta-above' : 'list-delta-below';
            deltaText = (delta > 0 ? '↑ +' : '↓ ') + delta;
          }
          var statusBadge = '<span class="status-badge status-upcoming">Upcoming</span>';
          var row = document.createElement('tr');
          row.setAttribute('data-tab', 'upcoming');
          row.setAttribute('data-status', 'upcoming');
          row.setAttribute('data-detail', id);
          row.setAttribute('data-last-updated', dateToSortKey(lastUpdated));
          row.setAttribute('data-next-due', dateToSortKey(nextDue));
          row.innerHTML = '<td>' + d.name + '</td><td>' + nhs + '</td><td class="col-status">' + statusBadge + '</td><td title="' + protocolName + '">' + shortLabel + '</td><td>' + scheduleLabel + '</td><td class="col-diagnoses">' + (diagnoses || '—') + '</td><td><div class="sparkline-inline">' + spark.map(function(h) { return '<span style="height:' + h + '%"></span>'; }).join('') + '</div></td><td>' + psaDisplay + '</td><td class="threshold-cell">' + threshold + '</td><td class="list-delta-cell"><span class="' + deltaClass + '" aria-label="' + (deltaText !== '—' ? deltaText : '') + '">' + deltaText + '</span></td><td>' + nextDue + '</td><td>' + lastUpdated + '</td>';
          listTbody.appendChild(row);
          var listSparkWrap = row.querySelector('.sparkline-inline');
          if (listSparkWrap && listSparkWrap.parentNode && psaHistory.length) {
            var lwrap = document.createElement('div');
            lwrap.className = 'sparkline-wrap';
            listSparkWrap.parentNode.insertBefore(lwrap, listSparkWrap);
            lwrap.appendChild(listSparkWrap);
            var threshNum = parseFloat(threshold) || 0;
            var maxVal = Math.max.apply(null, psaHistory.concat([threshNum, 0.01]));
            var lline = document.createElement('span');
            lline.className = 'sparkline-threshold-line';
            lline.style.bottom = (threshNum / maxVal * 100) + '%';
            lline.setAttribute('aria-hidden', 'true');
            lwrap.appendChild(lline);
          }
          row.addEventListener('click', function() { openDetail(id); });
        }
        updateListTabCounts();
        showView(viewDashboard);
        showToast('Patient added. They appear in Upcoming.');
      }
      on(document.getElementById('wizard-submit'), 'click', function() {
        addNewPatientFromWizard();
      });
      // List tabs: filter rows by data-tab
      listTabs.forEach(function(btn) {
        btn.addEventListener('click', function() {
          listTabs.forEach(function(b) { b.classList.remove('active'); });
          btn.classList.add('active');
          applyListTab();
        });
      });

      function psaResultsFromLegacy(d) {
        if (d.psaResults && d.psaResults.length) return d.psaResults;
        var history = d.psaHistory || [];
        if (history.length === 0) return [];
        var lastDate = d.psaDate || '';
        function addMonths(isoDate, months) {
          var date = new Date(isoDate);
          date.setMonth(date.getMonth() + months);
          return date.toISOString().slice(0, 10);
        }
        return history.map(function(val, i) {
          var date = (i === history.length - 1 && lastDate) ? lastDate : (lastDate ? addMonths(lastDate, (i - (history.length - 1)) * 6) : '');
          return { date: date, value: typeof val === 'number' ? val : parseFloat(val) || 0 };
        });
      }
      function getPsaResults(d) {
        var arr = d.psaResults && d.psaResults.length ? d.psaResults : psaResultsFromLegacy(d);
        return arr;
      }
      function derivePsaFromResults(d) {
        var results = getPsaResults(d);
        if (results.length === 0) return { psa: d.psa || '—', psaDate: d.psaDate || '', psaHistory: d.psaHistory || [] };
        var last = results[results.length - 1];
        return {
          psa: String(last.value),
          psaDate: last.date || '',
          psaHistory: results.map(function(r) { return r.value; })
        };
      }
      // Mock detail data (keyed by data-detail). psaHistory = chronological (oldest first). Clinician-reviewed: post-RP <0.03; EBRT/brachy higher; one no-result case (Wilson).
      var detailData = {
        'john-smith':     { name: 'Smith, John (68)', nhs: '123 456 7890', dob: '12 Apr 1956', lastUpdated: '28 Jan 2025', badge: 'Radical prostatectomy | Year 1', protocol: 'Radical Prostatectomy', phase: 'Year 1', protocolFrequency: '4‑monthly', frequency: '4‑monthly', personalScheduleSet: false, anchor: '15 Dec 2024', psa: '0.02', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: '12 Apr 2025', lastBleed: '', status: 'upcoming', spark: [93,83,70,67], psaHistory: [0.028,0.025,0.021,0.02], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'alan-jones':     { name: 'Jones, Alan (72)', nhs: '987 654 3210', dob: '3 Jul 1952', lastUpdated: '5 Feb 2025', badge: 'EBRT | Year 1', protocol: 'EBRT', phase: 'Year 1', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '10 Sep 2024', psa: '1.2', protocolThreshold: '2.0', threshold: '2.0', personalThresholdSet: false, nextDue: '28 Mar 2025', lastBleed: '', status: 'upcoming', spark: [60], psaHistory: [1.2], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL (Phoenix criteria) suggests remission. Nadir + 2 ng/mL may trigger further investigation.' },
        'david-brown':    { name: 'Brown, David (65)', nhs: '555 111 2233', dob: '22 Jan 1959', lastUpdated: '2 Feb 2025', badge: 'Radical prostatectomy | Year 3', protocol: 'Radical Prostatectomy', phase: 'Year 3', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '22 Mar 2022', psa: '0.025', psaDate: '2025-02-02', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Awaiting result', lastBleed: '5 days ago', status: 'awaiting', daysAwaiting: 5, spark: [100,91,86,83,83], psaHistory: [0.035,0.032,0.030,0.028,0.025], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'robert-wilson':  { name: 'Wilson, Robert (70)', nhs: '444 555 6677', dob: '8 Sep 1954', lastUpdated: '27 Jan 2025', badge: 'EBRT | Year 2', protocol: 'EBRT', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '8 Nov 2023', psa: '—', protocolThreshold: '2.0', threshold: '2.0', personalThresholdSet: false, nextDue: 'Awaiting result', lastBleed: '15 days ago', status: 'awaiting', daysAwaiting: 15, spark: [], psaHistory: [], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL (Phoenix criteria) suggests remission. Nadir + 2 ng/mL may trigger further investigation.' },
        'michael-clark':  { name: 'Clark, Michael (69)', nhs: '777 888 9900', dob: '19 Nov 1955', lastUpdated: '28 Jan 2025', badge: 'Radical prostatectomy | Year 2', protocol: 'Radical Prostatectomy', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '20 Jan 2023', psa: '0.06', psaDate: '2025-01-28', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Review', lastBleed: '', status: 'action', reviewReason: 'PSA above threshold (0.06 &gt; 0.03). Consider bounce vs biochemical recurrence.', spark: [25,62,100], psaHistory: [0.015,0.037,0.06], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.', scheduleRows: [ { yearFrom: 1, yearTo: 1, schedule: '4-monthly', threshold: '0.03', mot: false, lft: false, isProtocol: true }, { yearFrom: 2, yearTo: 5, schedule: '6-monthly', threshold: '0.03', mot: true, lft: false, isProtocol: true }, { yearFrom: 6, yearTo: 10, schedule: 'annual', threshold: '0.03', mot: false, lft: false, isProtocol: true } ] },
        'peter-green':    { name: 'Green, Peter (67)', nhs: '222 333 4455', dob: '5 Feb 1957', lastUpdated: '5 Feb 2025', badge: 'Radical prostatectomy | Year 4', protocol: 'Radical Prostatectomy', phase: 'Year 4', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '5 May 2021', psa: '0.02', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Next due Jun 2025', lastBleed: '', status: 'completed', spark: [100,88,78,72,69,63], psaHistory: [0.032,0.028,0.025,0.023,0.022,0.02], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'james-taylor':   { name: 'Taylor, James (71)', nhs: '666 777 8899', dob: '30 Jun 1953', lastUpdated: '30 Jan 2025', badge: 'Radical prostatectomy | Year 2', protocol: 'Radical Prostatectomy', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '30 Aug 2023', psa: '0.12', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: true, nextDue: 'Under clinic recall', lastBleed: '', status: 'recall', spark: [33,67,100], psaHistory: [0.04,0.08,0.12], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'george-walsh':   { name: 'Walsh, George (69)', nhs: '111 222 3344', dob: '18 Aug 1955', lastUpdated: '3 Feb 2025', badge: 'Radical prostatectomy | Year 3', protocol: 'Radical Prostatectomy', phase: 'Year 3', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '18 Jul 2022', psa: '0.01', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Next due Sep 2025', lastBleed: '', status: 'completed', spark: [55,52,48,45], psaHistory: [0.028,0.025,0.022,0.01], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'terence-bennett': { name: 'Bennett, Terence (74)', nhs: '333 444 5566', dob: '2 Dec 1950', lastUpdated: '1 Feb 2025', badge: 'EBRT | Year 4', protocol: 'EBRT', phase: 'Year 4', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '2 Mar 2021', psa: '0.8', protocolThreshold: '2.0', threshold: '2.0', personalThresholdSet: false, nextDue: 'Next due Sep 2025', lastBleed: '', status: 'completed', spark: [25,30,33,36,40], psaHistory: [0.5,0.6,0.65,0.72,0.8], medication5ARI: 'finasteride', diagnoses: 'Localised, BPH', scheduleSummary: 'Year 1–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL (Phoenix criteria) suggests remission. Nadir + 2 ng/mL may trigger further investigation.' },
        'kevin-shaw':     { name: 'Shaw, Kevin (66)', nhs: '888 999 0011', dob: '14 May 1958', lastUpdated: '15 Jan 2025', badge: 'Radical prostatectomy | Year 2', protocol: 'Radical Prostatectomy', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '4‑monthly', personalScheduleSet: true, scheduleByYear: { 2: '4-monthly' }, anchor: '14 Nov 2023', psa: '0.02', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Next due May 2025', lastBleed: '', status: 'completed', spark: [83,73,67], psaHistory: [0.025,0.022,0.02], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'philip-hayes':   { name: 'Hayes, Philip (68)', nhs: '555 666 7788', dob: '10 Mar 1956', lastUpdated: '29 Jan 2025', badge: 'EBRT | Year 2', protocol: 'EBRT', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '10 May 2023', psa: '2.4', protocolThreshold: '2.0', threshold: '2.0', personalThresholdSet: false, nextDue: 'Under clinic recall', lastBleed: '', status: 'action_required', required_action: 'Urgent Suspected Cancer', spark: [50,63,75,100], psaHistory: [1.2,1.5,1.8,2.4], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL (Phoenix criteria) suggests remission. Nadir + 2 ng/mL may trigger further investigation.' },
        'stephen-webb':   { name: 'Webb, Stephen (70)', nhs: '999 000 1122', dob: '25 Aug 1954', lastUpdated: '4 Feb 2025', badge: 'Brachy | Year 1', protocol: 'Brachytherapy', phase: 'Year 1', protocolFrequency: '3‑monthly', frequency: '3‑monthly', personalScheduleSet: false, anchor: '25 Jun 2024', psa: '0.7', protocolThreshold: '2.0', threshold: '0.5', personalThresholdSet: true, nextDue: 'Under clinic recall', lastBleed: '', status: 'recall', spark: [29,50,71,100], psaHistory: [0.2,0.35,0.5,0.7], medication5ARI: 'yes', diagnoses: 'Localised', scheduleSummary: 'Year 1: 3‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL suggests remission. Year 1 monitoring is 3‑monthly. Check for PSA bounce before recall.' },
        'nicholas-bell':  { name: 'Bell, Nicholas (67)', nhs: '111 333 5555', dob: '7 Nov 1957', lastUpdated: '6 Feb 2025', badge: 'Brachy | Year 1', protocol: 'Brachytherapy', phase: 'Year 1', protocolFrequency: '3‑monthly', frequency: '3‑monthly', personalScheduleSet: false, anchor: '7 Dec 2024', psa: '0.15', protocolThreshold: '2.0', threshold: '0.5', personalThresholdSet: true, nextDue: '28 Mar 2025', lastBleed: '', status: 'upcoming', spark: [40,30], psaHistory: [0.2,0.15], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 3‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 2.0 ng/mL suggests remission. Year 1 monitoring is 3‑monthly. Check for PSA bounce before recall.' },
        'ian-collins':    { name: 'Collins, Ian (64)', nhs: '200 300 4001', dob: '3 May 1960', lastUpdated: '4 Feb 2025', badge: 'ADT | Year 2', protocol: 'Primary ADT', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '1 Apr 2023', psa: '2.5', protocolThreshold: '4.0', threshold: '4.0', personalThresholdSet: false, nextDue: 'Next due Apr 2025', lastBleed: '', status: 'completed', spark: [63,58,55], psaHistory: [2.8,2.6,2.5], medication5ARI: 'none', diagnoses: 'Locally advanced', scheduleSummary: 'All years: 6‑monthly.', protocolGuideline: 'PSA &lt; 4.0 ng/mL on ADT. Review if &gt; 4.0; recall if &gt; 4.0 (check testosterone).' },
        'david-patel':    { name: 'Patel, David (61)', nhs: '300 400 5002', dob: '12 Aug 1963', lastUpdated: '4 Feb 2025', badge: 'Intermittent hormones | Year 1', protocol: 'Intermittent Hormones', phase: 'Year 1', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '1 Sep 2024', psa: '6.0', protocolThreshold: '10.0', threshold: '10.0', personalThresholdSet: false, nextDue: 'Awaiting result', lastBleed: '3 days ago', status: 'awaiting', daysAwaiting: 3, spark: [55,52,60], psaHistory: [5.5,5.2,6.0], medication5ARI: 'none', diagnoses: 'Prostate Ca', scheduleSummary: 'All years: 6‑monthly.', protocolGuideline: 'PSA &lt; 10.0 ng/mL in off-treatment phase. Review if &gt; 10.0; recall if &gt; 10.0 (restart hormones).' },
        'frank-wright':   { name: 'Wright, Frank (76)', nhs: '400 500 6003', dob: '22 Jan 1948', lastUpdated: '5 Feb 2025', badge: 'Watchful waiting | Year 2', protocol: 'Watchful Waiting', phase: 'Year 2', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '1 Jun 2023', psa: '18', protocolThreshold: '30.0', threshold: '30.0', personalThresholdSet: false, nextDue: 'Next due Jun 2025', lastBleed: '', status: 'completed', spark: [52,55,60], psaHistory: [15,16,18], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'All years: 6‑monthly.', protocolGuideline: 'PSA &lt; 30.0 ng/mL. Review if &gt; 30.0; recall if &gt; 30.0 or doubling time &lt; 1 year.' },
        'harry-nelson':   { name: 'Nelson, Harry (69)', nhs: '500 600 7004', dob: '14 Oct 1955', lastUpdated: '6 Feb 2025', badge: 'Active surveillance | Year 1', protocol: 'Active Surveillance', phase: 'Year 1', protocolFrequency: '6‑monthly', frequency: '6‑monthly', personalScheduleSet: false, anchor: '1 Nov 2024', psa: '8.2', protocolThreshold: '15.0', threshold: '15.0', personalThresholdSet: false, nextDue: '1 May 2025', lastBleed: '', status: 'upcoming', spark: [50,55,58], psaHistory: [7.2,7.8,8.2], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'All years: 6‑monthly.', protocolGuideline: 'PSA monitoring without immediate treatment. Review if rise &gt; 0.75 ng/mL/year or doubling time &lt; 1 year.' },
        'arthur-discharged': { name: 'Smith, Arthur (72)', nhs: '600 700 8005', dob: '20 Apr 1952', lastUpdated: '1 Feb 2025', badge: 'Radical prostatectomy | Year 5', protocol: 'Radical Prostatectomy', phase: 'Year 5', protocolFrequency: 'annual', frequency: 'annual', personalScheduleSet: false, anchor: '20 May 2019', psa: '0.01', protocolThreshold: '0.03', threshold: '0.03', personalThresholdSet: false, nextDue: 'Discharged', lastBleed: '', status: 'discharged', spark: [100,95,90], psaHistory: [0.02,0.015,0.01], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' },
        'emma-reid':       { name: 'Reid, Emma (63)', nhs: '700 800 9012', dob: '19 May 1961', lastUpdated: '6 Feb 2025', badge: 'Radical prostatectomy | Year 1', protocol: 'Radical Prostatectomy', phase: 'Year 1', protocolFrequency: '4‑monthly', frequency: '3‑monthly', personalScheduleSet: true, scheduleByYear: { 1: '3-monthly' }, anchor: '6 Nov 2024', psa: '0.018', protocolThreshold: '0.03', threshold: '0.02', personalThresholdSet: true, nextDue: '8 Feb 2025', lastBleed: '', status: 'upcoming', spark: [90,85], psaHistory: [0.022,0.018], medication5ARI: 'none', diagnoses: 'Localised', scheduleSummary: 'Year 1: 4‑monthly; Year 2–5: 6‑monthly; Year 6–10: annual.', protocolGuideline: 'PSA &lt; 0.03 ng/mL suggests biochemical remission. Results above threshold often need MDT review or recall.' }
      };
      function formatScheduleForDisplay(freq) {
        if (!freq) return '6\u2011monthly';
        var s = (freq + '').replace(/-/g, '\u2011');
        return s.toLowerCase() === 'annual' ? 'Annual' : s;
      }
      (function backfillDetailData() {
        Object.keys(detailData).forEach(function(id) {
          var d = detailData[id];
          if (d.ownership === undefined) d.ownership = 'GP';
          if (d.reviewForDischargeYears === undefined) d.reviewForDischargeYears = 10;
          if (!d.psaResults || !d.psaResults.length) d.psaResults = psaResultsFromLegacy(d);
          if (!d.frequency) d.frequency = d.protocolFrequency || '6\u2011monthly';
        });
      })();

      function injectSparklineThresholds() {
        function addThresholdToWrap(wrap, d) {
          var history = d.psaHistory || [];
          if (history.length === 0) return;
          var nums = history.map(function(v) { return typeof v === 'number' ? v : 0; });
          var thresh = parseFloat(d.threshold) || 0;
          var maxVal = Math.max.apply(null, nums.concat([thresh, 0.01]));
          var pct = (thresh / maxVal * 100);
          var line = document.createElement('span');
          line.className = 'sparkline-threshold-line';
          line.style.bottom = pct + '%';
          line.setAttribute('aria-hidden', 'true');
          wrap.appendChild(line);
        }
        document.querySelectorAll('.card[data-detail]').forEach(function(card) {
          var id = card.getAttribute('data-detail');
          var d = detailData[id];
          if (!d) return;
          var scheduleChip = card.querySelector('.card-chip-phase');
          if (scheduleChip) scheduleChip.textContent = formatScheduleForDisplay(d.frequency);
          if (d.medication5ARI && d.medication5ARI !== 'none') {
            var chips = card.querySelector('.card-chips');
            if (chips && !chips.querySelector('.card-chip-5ari')) {
              var chip5ari = document.createElement('span');
              chip5ari.className = 'card-chip-5ari';
              chip5ari.title = 'On 5-ARI';
              chip5ari.textContent = '5-ARI';
              chips.appendChild(chip5ari);
            }
          }
          var sparkEl = card.querySelector('.card-sparkline');
          if (!sparkEl || !sparkEl.parentNode) return;
          if (sparkEl.parentNode.classList && sparkEl.parentNode.classList.contains('sparkline-wrap')) return;
          var wrap = document.createElement('div');
          wrap.className = 'sparkline-wrap';
          sparkEl.parentNode.insertBefore(wrap, sparkEl);
          wrap.appendChild(sparkEl);
          addThresholdToWrap(wrap, d);
        });
        var tbody = document.getElementById('list-tbody');
        if (tbody) {
          tbody.querySelectorAll('tr[data-detail]').forEach(function(tr) {
            var id = tr.getAttribute('data-detail');
            var d = detailData[id];
            if (!d) return;
            if (tr.cells[4]) tr.cells[4].textContent = formatScheduleForDisplay(d.frequency);
            var sparkEl = tr.querySelector('.sparkline-inline');
            if (!sparkEl || !sparkEl.parentNode) return;
            if (sparkEl.parentNode.classList && sparkEl.parentNode.classList.contains('sparkline-wrap')) return;
            var wrap = document.createElement('div');
            wrap.className = 'sparkline-wrap';
            sparkEl.parentNode.insertBefore(wrap, sparkEl);
            wrap.appendChild(sparkEl);
            addThresholdToWrap(wrap, d);
          });
        }
      }
      try { injectSparklineThresholds(); } catch (err) { console.warn('injectSparklineThresholds:', err); }

      var OVERDUE_DAYS_THRESHOLD = 14;
      function formatAwaitingCopy(days) {
        var n = parseInt(days, 10);
        if (isNaN(n) || n < 0) return 'Awaiting result';
        return n > OVERDUE_DAYS_THRESHOLD ? n + ' days overdue' : 'Waiting for ' + n + ' days';
      }
      function injectAwaitingDueLines() {
        document.querySelectorAll('.card[data-status="awaiting"]').forEach(function(card) {
          var id = card.getAttribute('data-detail');
          var d = detailData[id];
          if (!d || d.daysAwaiting == null) return;
          var dueLine = card.querySelector('.card-due-line');
          if (!dueLine) return;
          dueLine.textContent = formatAwaitingCopy(d.daysAwaiting);
          if (d.daysAwaiting > OVERDUE_DAYS_THRESHOLD) dueLine.classList.add('overdue');
        });
      }
      function dateToSortKey(str) {
        if (!str || typeof str !== 'string') return '9999-12-31';
        var s = str.trim();
        var months = { jan: '01', feb: '02', mar: '03', apr: '04', may: '05', jun: '06', jul: '07', aug: '08', sep: '09', oct: '10', nov: '11', dec: '12' };
        var m = s.match(/^(\d{1,2})\s+(\w{3})\s+(\d{4})$/i);
        if (m) return m[3] + '-' + (months[m[2].toLowerCase().slice(0, 3)] || '12') + '-' + (m[1].length === 1 ? '0' + m[1] : m[1]);
        var m2 = s.match(/^(\w{3})\s+(\d{4})$/i);
        if (m2) return m2[2] + '-' + (months[m2[1].toLowerCase().slice(0, 3)] || '12') + '-01';
        return '9999-12-31';
      }
      function populateListFromDetailData() {
        var tbody = document.getElementById('list-tbody');
        if (!tbody) return;
        tbody.querySelectorAll('tr[data-detail]').forEach(function(tr) {
          var id = tr.getAttribute('data-detail');
          var d = detailData[id];
          if (!d) return;
          var cells = tr.querySelectorAll('td');
          if (cells.length >= 6) cells[5].textContent = d.diagnoses || '—';
          if (d.status === 'awaiting' && d.daysAwaiting != null && cells.length >= 11) {
            cells[10].textContent = formatAwaitingCopy(d.daysAwaiting);
            if (d.daysAwaiting > OVERDUE_DAYS_THRESHOLD) cells[10].classList.add('list-next-due-overdue');
          }
          tr.setAttribute('data-last-updated', dateToSortKey(d.lastUpdated));
          tr.setAttribute('data-next-due', dateToSortKey(d.nextDue));
        });
      }
      function applyFilters() {
        var searchRaw = (document.getElementById('filter-nhs') && document.getElementById('filter-nhs').value) ? document.getElementById('filter-nhs').value.trim() : '';
        var searchNorm = searchRaw.replace(/\s/g, '').toLowerCase();
        var searchLower = searchRaw.toLowerCase();
        var protocol = (document.getElementById('filter-protocol') && document.getElementById('filter-protocol').value) ? document.getElementById('filter-protocol').value : '';
        var activeTabBtn = document.querySelector('.list-view .tabs button.active');
        var tab = activeTabBtn ? activeTabBtn.getAttribute('data-tab') : 'upcoming';
        if (listTbody) {
          listTbody.querySelectorAll('tr[data-detail]').forEach(function(row) {
            var rowTab = row.getAttribute('data-tab');
            var tabMatch = tab === 'all' || rowTab === tab;
            var rowNhs = (row.cells[1] && row.cells[1].textContent) ? row.cells[1].textContent.replace(/\s/g, '') : '';
            var rowName = (row.cells[0] && row.cells[0].textContent) ? row.cells[0].textContent.toLowerCase() : '';
            var searchMatch = !searchRaw || (rowNhs.indexOf(searchNorm) !== -1) || (rowName.indexOf(searchLower) !== -1);
            var rowProtocol = (row.cells[3] && row.cells[3].textContent) ? row.cells[3].textContent.trim() : '';
            var protocolMatch = !protocol || rowProtocol === protocol;
            row.style.display = (tabMatch && searchMatch && protocolMatch) ? '' : 'none';
          });
        }
        document.querySelectorAll('.board .card[data-detail]').forEach(function(card) {
          var elNhs = card.querySelector('.card-nhs');
          var cardNhs = (elNhs && elNhs.textContent) ? elNhs.textContent.replace(/\s/g, '') : '';
          var elName = card.querySelector('.card-name');
          var cardName = (elName && elName.textContent) ? elName.textContent.toLowerCase() : '';
          var searchMatch = !searchRaw || (cardNhs.indexOf(searchNorm) !== -1) || (cardName.indexOf(searchLower) !== -1);
          var elProto = card.querySelector('.card-chip-protocol');
          var cardProtocol = (elProto && elProto.textContent) ? elProto.textContent.trim() : '';
          var protocolMatch = !protocol || cardProtocol === protocol;
          card.style.display = (searchMatch && protocolMatch) ? '' : 'none';
        });
        applyListSort();
      }
      function applyListSort() {
        var sortSelect = document.getElementById('list-sort');
        var key = (sortSelect && sortSelect.value) ? sortSelect.value : 'status';
        if (!listTbody) return;
        var rows = Array.prototype.slice.call(listTbody.querySelectorAll('tr[data-detail]'));
        var workflowOrder = { action: 0, awaiting: 1, upcoming: 2, completed: 3, action_required: 4, recall: 5, discharged: 6 };
        var attr = key === 'due-date' ? 'data-next-due' : 'data-last-updated';
        rows.sort(function(a, b) {
          if (key === 'status') {
            var ta = workflowOrder[a.getAttribute('data-tab')] ?? 99;
            var tb = workflowOrder[b.getAttribute('data-tab')] ?? 99;
            if (ta !== tb) return ta - tb;
            var va = a.getAttribute('data-last-updated') || '9999-12-31';
            var vb = b.getAttribute('data-last-updated') || '9999-12-31';
            return vb.localeCompare(va);
          }
          var va = a.getAttribute(attr) || '9999-12-31';
          var vb = b.getAttribute(attr) || '9999-12-31';
          return (key === 'due-date' ? va.localeCompare(vb) : vb.localeCompare(va));
        });
        rows.forEach(function(r) { listTbody.appendChild(r); });
      }
      injectAwaitingDueLines();
      populateListFromDetailData();
      applyFilters();
      updateListTabCounts();

      var fn = document.getElementById('filter-nhs');
      if (fn) fn.addEventListener('input', applyFilters);
      var fp = document.getElementById('filter-protocol');
      if (fp) fp.addEventListener('change', applyFilters);
      var ls = document.getElementById('list-sort');
      if (ls) ls.addEventListener('change', function() { applyListSort(); });

      var statusLabels = { upcoming: 'Upcoming', awaiting: 'Awaiting Results', action: 'Review Required', completed: 'Completed', recall: 'Recall', action_required: 'Follow-up Required', discharged: 'Discharged' };

      function setDetailDelta(d) {
        var analyticalEl = document.getElementById('detail-psa-analytical');
        if (!analyticalEl) return;
        var p = parseFloat(d.psa, 10);
        var t = parseFloat(d.threshold, 10);
        if (isNaN(p) || isNaN(t) || d.psa === '—' || d.threshold === '') {
          analyticalEl.classList.add('hidden');
          analyticalEl.textContent = '';
          return;
        }
        var delta = Math.round((p - t) * 100) / 100;
        analyticalEl.classList.remove('hidden');
        if (delta > 0) {
          analyticalEl.textContent = '↑ Δ +' + delta + ' above threshold';
        } else if (delta < 0) {
          analyticalEl.textContent = '↓ Δ ' + delta + ' below threshold';
        } else {
          analyticalEl.textContent = '✓ at threshold';
        }
      }

      function openDetail(id) {
        var d = detailData[id];
        if (!d) return;
        document.getElementById('detail-name').textContent = d.name;
        document.getElementById('detail-nhs').textContent = d.nhs;
        document.getElementById('detail-dob').textContent = d.dob;
        document.getElementById('detail-last-updated').textContent = d.lastUpdated || '—';
        document.getElementById('detail-diagnoses-display').textContent = d.diagnoses || '—';
        document.getElementById('detail-diagnoses-input').value = d.diagnoses || '';
        document.getElementById('detail-diagnoses-edit').classList.add('hidden');
        document.getElementById('detail-diagnoses-edit-btn').style.display = '';
        var is5ari = !!(d.medication5ARI && d.medication5ARI !== 'none');
        var detail5ariYes = document.getElementById('detail-5ari-yes');
        if (detail5ariYes) detail5ariYes.checked = is5ari;
        function protocolShortLabel(p) { return p === 'Radical Prostatectomy' ? 'RP' : p === 'EBRT' || p === 'External Beam Radiation Therapy' ? 'EBRT' : p === 'Brachytherapy' ? 'Brachy' : p === 'Primary ADT' ? 'ADT' : p === 'Intermittent Hormones' ? 'Intermittent hormones' : p === 'Watchful Waiting' ? 'Watchful waiting' : p === 'Active Surveillance' ? 'Active surveillance' : p || '—'; }
        function protocolTooltip(p) { return p === 'Radical Prostatectomy' ? 'Radical Prostatectomy' : p === 'EBRT' || p === 'External Beam Radiation Therapy' ? 'EBRT (external beam radiotherapy)' : p === 'Brachytherapy' ? 'Brachytherapy' : p === 'Primary ADT' ? 'Primary ADT (androgen deprivation therapy)' : p === 'Intermittent Hormones' ? 'Intermittent hormones' : p === 'Watchful Waiting' ? 'Watchful waiting' : p === 'Active Surveillance' ? 'Active surveillance' : p || ''; }
        var chipProto = document.getElementById('detail-chip-protocol');
        chipProto.textContent = protocolShortLabel(d.protocol);
        chipProto.title = protocolTooltip(d.protocol);
        document.getElementById('detail-chip-phase').textContent = d.phase;
        document.getElementById('detail-protocol').textContent = d.protocol;
        document.getElementById('detail-anchor').textContent = d.anchor;
        var ownershipEl = document.getElementById('detail-ownership');
        if (ownershipEl) ownershipEl.value = (d.ownership === 'Urology') ? 'Urology' : 'GP';
        var yearBadge = document.getElementById('detail-year-badge');
        if (yearBadge) { yearBadge.textContent = d.phase || '—'; yearBadge.style.display = d.anchor && d.anchor !== '—' ? 'inline-block' : 'none'; }
        var reqActionSection = document.getElementById('detail-required-action-section');
        var reqActionDisplay = document.getElementById('detail-required-action-display');
        var reqActionInput = document.getElementById('detail-required-action-input');
        var reqActionHint = document.getElementById('detail-required-action-hint');
        var reqActionEditWrap = document.getElementById('detail-required-action-edit');
        var reqActionEditBtn = document.getElementById('detail-required-action-edit-btn');
        if (d.required_action) {
          if (reqActionSection) reqActionSection.style.display = '';
          if (reqActionDisplay) reqActionDisplay.textContent = d.required_action;
          if (reqActionInput) reqActionInput.value = d.required_action;
          if (reqActionHint) reqActionHint.textContent = requiredActionHints[d.required_action] || '';
          if (reqActionEditWrap) reqActionEditWrap.classList.add('hidden');
          if (reqActionEditBtn) reqActionEditBtn.style.display = '';
        } else {
          if (reqActionSection) reqActionSection.style.display = 'none';
        }
        var protocolKeyMap = { 'Radical Prostatectomy': 'radical', 'EBRT': 'ebrt', 'Brachytherapy': 'brachytherapy', 'Primary ADT': 'primary-adt', 'Intermittent Hormones': 'intermittent-hormones', 'Watchful Waiting': 'watchful-waiting', 'Active Surveillance': 'active-surveillance', 'General PSA monitoring': 'general-psa-monitoring', 'Raised PSA follow-up': 'raised-psa-follow-up' };
        var pkey = protocolKeyMap[d.protocol] || 'radical';
        var cfg = protocolConfig[pkey] || { getFrequency: function() { return '6\u2011monthly'; } };
        var phaseYearNum = parseInt((d.phase || '').replace(/\D/g, ''), 10) || 1;
        var scheduleRows = d.scheduleRows;
        if (!scheduleRows || !scheduleRows.length) {
          scheduleRows = deriveScheduleRowsFromProtocol(pkey, d.scheduleByYear, d.threshold || cfg.threshold);
          d.scheduleRows = scheduleRows;
        }
        var table = document.getElementById('detail-protocol-table');
        var tbody = document.getElementById('detail-protocol-tbody');
        if (table && scheduleRows && scheduleRows.length > 0) {
          table.innerHTML = '<thead><tr><th>Phase</th><th>Threshold (ng/mL)</th><th>Monitoring schedule</th><th title="Monitoring Other Test">MOT</th><th title="Liver Function Test">LFT</th></tr></thead><tbody id="detail-protocol-tbody"></tbody>';
          tbody = document.getElementById('detail-protocol-tbody');
          scheduleRows.forEach(function(row) {
            var isCurrent = phaseYearNum >= row.yearFrom && phaseYearNum <= row.yearTo;
            var phaseLabel = row.yearFrom === row.yearTo ? 'Year ' + row.yearFrom : 'Year ' + row.yearFrom + '\u2013' + row.yearTo;
            var sched = row.schedule;
            if (sched === '3-monthly') sched = '3\u2011monthly';
            if (sched === '4-monthly') sched = '4\u2011monthly';
            if (sched === '6-monthly') sched = '6\u2011monthly';
            var tr = document.createElement('tr');
            if (isCurrent) tr.classList.add('current-year');
            tr.innerHTML = '<td>' + phaseLabel + '</td><td>' + (row.threshold || '—') + '</td><td>' + sched + '</td><td>' + (row.mot ? 'Yes' : '—') + '</td><td>' + (row.lft ? 'Yes' : '—') + '</td>';
            tbody.appendChild(tr);
          });
        } else if (tbody) {
          var phases = protocolPhases[pkey] || protocolPhases['primary-adt'];
          table.innerHTML = '<thead><tr><th>Phase</th><th>Protocol default</th><th>Effective schedule</th></tr></thead><tbody id="detail-protocol-tbody"></tbody>';
          tbody = document.getElementById('detail-protocol-tbody');
          phases.forEach(function(phase) {
            var isCurrent = phase.years.indexOf(phaseYearNum) !== -1;
            var protoSched = phase.schedule;
            var effective = protoSched;
            var isOverride = false;
            if (d.scheduleByYear) {
              var overrideYear = phase.years[0];
              if (d.scheduleByYear[overrideYear]) {
                effective = d.scheduleByYear[overrideYear];
                if (effective === '3-monthly') effective = '3\u2011monthly';
                if (effective === '4-monthly') effective = '4\u2011monthly';
                if (effective === '6-monthly') effective = '6\u2011monthly';
                isOverride = true;
              }
            }
            var tr = document.createElement('tr');
            if (isCurrent) tr.classList.add('current-year');
            if (isOverride) tr.classList.add('schedule-override');
            var effectiveCell = effective + (isOverride ? ' <span class="override-marker" aria-label="Personalised for this patient">*</span>' : '');
            tr.innerHTML = '<td>' + phase.label + '</td><td>' + protoSched + '</td><td>' + effectiveCell + '</td>';
            tbody.appendChild(tr);
          });
        }
        var guidelineTextEl = document.getElementById('detail-protocol-guideline-text');
        if (guidelineTextEl) guidelineTextEl.textContent = d.protocolGuideline ? d.protocolGuideline.replace(/&lt;/g, '<').replace(/&gt;/g, '>') : '';
        var currentScheduleRow = scheduleRows && scheduleRows.length ? scheduleRows.find(function(r) { return phaseYearNum >= r.yearFrom && phaseYearNum <= r.yearTo; }) : null;
        var motLftEl = document.getElementById('detail-mot-lft-display');
        if (motLftEl) {
          var motLftParts = [];
          if (currentScheduleRow && currentScheduleRow.mot) motLftParts.push('MOT');
          if (currentScheduleRow && currentScheduleRow.lft) motLftParts.push('LFT');
          motLftEl.textContent = motLftParts.length ? motLftParts.join(', ') : '—';
          motLftEl.title = 'MOT: Monitoring Other Test; LFT: Liver Function Test. Derived from current phase.';
        }
        var psaSchedEl = document.getElementById('detail-psa-schedule');
        if (psaSchedEl) psaSchedEl.value = (d.frequency || '6-monthly').replace(/\u2011/g, '-');
        var reviewDischargeEl = document.getElementById('detail-review-discharge');
        if (reviewDischargeEl) reviewDischargeEl.value = d.reviewForDischargeYears != null ? String(d.reviewForDischargeYears) : '';
        document.getElementById('detail-protocol-threshold').textContent = d.protocolThreshold || '—';
        document.getElementById('detail-latest-psa').textContent = d.psa;
        var psaThreshEl = document.getElementById('detail-psa-threshold');
        if (psaThreshEl) psaThreshEl.textContent = d.threshold || '—';
        var psaThreshFallback = document.getElementById('detail-psa-threshold-fallback');
        if (psaThreshFallback) psaThreshFallback.textContent = d.threshold || '—';
        setDetailDelta(d);
        var hasLatestResult = !!(d.psa && d.psa !== '—');
        var psaLatestWrap = document.getElementById('detail-latest-psa-wrap');
        var psaNoResultEl = document.getElementById('detail-psa-no-result');
        var psaThreshLine = document.getElementById('detail-psa-threshold-line');
        if (psaLatestWrap) psaLatestWrap.classList.toggle('hidden', !hasLatestResult);
        if (psaNoResultEl) psaNoResultEl.classList.toggle('hidden', hasLatestResult);
        if (psaThreshLine) psaThreshLine.classList.toggle('hidden', hasLatestResult);
        var psaAddToggleWrap = document.getElementById('detail-psa-add-toggle-wrap');
        var psaAddFormWrap = document.getElementById('detail-psa-add-form-wrap');
        if (psaAddToggleWrap) psaAddToggleWrap.classList.remove('hidden');
        if (psaAddFormWrap) psaAddFormWrap.classList.add('hidden');
        if (d.status === 'awaiting' || d.status === 'action') {
          document.getElementById('detail-psa-edit-hint').textContent = d.status === 'awaiting'
            ? 'Enter the result when it arrives, then choose an action below.'
            : 'Correct the result if needed, then choose an action below.';
        }
        document.getElementById('detail-psa-result-input').value = (d.psa && d.psa !== '—') ? d.psa : '';
        document.getElementById('detail-psa-result-date').value = d.psaDate || new Date().toISOString().slice(0, 10);
        var psaResultsTbody = document.getElementById('detail-psa-results-tbody');
        var psaResultsEmpty = document.getElementById('detail-psa-results-empty');
        var psaResultsTable = document.getElementById('detail-psa-results-table');
        var results = getPsaResults(d);
        function relativeTime(dateStr) {
          if (!dateStr) return '—';
          var d1 = new Date(dateStr);
          var d2 = new Date();
          var days = Math.round((d2 - d1) / (24 * 60 * 60 * 1000));
          if (days === 0) return 'Today';
          if (days === 1) return '1 day ago';
          if (days === -1) return 'In 1 day';
          if (days > 0 && days < 7) return days + ' days ago';
          if (days >= 7 && days < 14) return '1 week ago';
          if (days >= 14 && days < 30) return Math.floor(days / 7) + ' weeks ago';
          if (days >= 30 && days < 60) return '1 month ago';
          if (days >= 60 && days < 365) return Math.floor(days / 30) + ' months ago';
          if (days >= 365) return Math.floor(days / 365) + ' year(s) ago';
          if (days < 0 && days > -7) return 'In ' + (-days) + ' days';
          return dateStr;
        }
        function formatResultDate(dateStr) {
          if (!dateStr) return '—';
          var d = new Date(dateStr);
          return d.getDate() + ' ' + ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'][d.getMonth()] + ' ' + d.getFullYear();
        }
        if (psaResultsTbody && psaResultsTable) {
          psaResultsTbody.innerHTML = '';
          var sorted = results.slice().sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
          var editLocked = d.status === 'recall' || d.status === 'discharged';
          if (sorted.length === 0) {
            if (psaResultsEmpty) { psaResultsEmpty.classList.remove('hidden'); psaResultsEmpty.style.display = ''; }
            psaResultsTable.classList.add('hidden');
          } else {
            if (psaResultsEmpty) { psaResultsEmpty.classList.add('hidden'); psaResultsEmpty.style.display = 'none'; }
            psaResultsTable.classList.remove('hidden');
            sorted.forEach(function(r, idx) {
              var tr = document.createElement('tr');
              var isLast = idx === 0;
              var editCell = document.createElement('td');
              if (isLast && !editLocked) {
                var editBtn = document.createElement('button');
                editBtn.type = 'button';
                editBtn.className = 'btn btn-secondary detail-psa-edit-last';
                editBtn.setAttribute('aria-label', 'Edit last result');
                editBtn.textContent = 'Edit';
                editBtn.addEventListener('click', function() {
                  document.getElementById('detail-psa-result-input').value = String(r.value);
                  document.getElementById('detail-psa-result-date').value = r.date || '';
                  document.getElementById('detail-psa-add-toggle-wrap').classList.add('hidden');
                  document.getElementById('detail-psa-add-form-wrap').classList.remove('hidden');
                  document.body.setAttribute('data-detail-editing-last', id);
                });
                editCell.appendChild(editBtn);
              }
              tr.innerHTML = '<td>' + formatResultDate(r.date) + '</td><td>' + relativeTime(r.date) + '</td><td>' + (typeof r.value === 'number' ? r.value : (r.value != null ? String(r.value) : '—')) + '</td>';
              tr.appendChild(editCell);
              psaResultsTbody.appendChild(tr);
            });
          }
        }
        document.getElementById('detail-threshold-input').value = d.threshold;
        document.getElementById('detail-next-due').textContent = d.nextDue;
        var asteriskEl = document.getElementById('detail-threshold-asterisk');
        if (d.personalThresholdSet) { asteriskEl.classList.remove('hidden'); asteriskEl.setAttribute('aria-hidden', 'false'); }
        else { asteriskEl.classList.add('hidden'); asteriskEl.setAttribute('aria-hidden', 'true'); }
        var statusBadge = document.getElementById('detail-status-badge');
        statusBadge.textContent = statusLabels[d.status] || d.status;
        statusBadge.className = 'status-badge-detail status-' + d.status;
        var extraLabel = document.getElementById('detail-extra-date-label');
        var extraDate = document.getElementById('detail-extra-date');
        if (d.lastBleed) { extraLabel.textContent = 'Last bleed'; extraLabel.style.display = ''; extraDate.textContent = d.lastBleed; extraDate.style.display = ''; }
        else { extraLabel.style.display = 'none'; extraDate.style.display = 'none'; }
        var sparkEl = document.getElementById('detail-sparkline');
        var labelsEl = document.getElementById('detail-sparkline-labels');
        var emptyEl = document.getElementById('detail-sparkline-empty');
        var chartWrap = document.getElementById('detail-psa-chart-wrap');
        sparkEl.innerHTML = '';
        if (labelsEl) labelsEl.innerHTML = '';
        var history = d.psaHistory || [];
        var hasTrend = history.length > 0;
        if (emptyEl) {
          if (hasTrend) { emptyEl.classList.add('hidden'); emptyEl.style.display = 'none'; }
          else { emptyEl.classList.remove('hidden'); emptyEl.style.display = ''; }
        }
        if (chartWrap) chartWrap.classList.toggle('hidden', !hasTrend);
        var heights = history.length ? history.map(function(v) { return typeof v === 'number' ? v : 0; }) : (d.spark || []);
        var threshNum = parseFloat(d.threshold) || 0;
        var maxVal = Math.max.apply(null, heights.concat([threshNum, 0.01]));
        heights.forEach(function(val) {
          var s = document.createElement('span');
          s.className = 'detail-sparkline-bar';
          s.style.height = (val / maxVal * 100) + '%';
          sparkEl.appendChild(s);
        });
        var oldLine = sparkEl.querySelector('.detail-sparkline-threshold');
        if (oldLine) oldLine.remove();
        var line = document.createElement('span');
        line.className = 'detail-sparkline-threshold';
        line.setAttribute('aria-hidden', 'true');
        line.style.bottom = (threshNum / maxVal * 100) + '%';
        sparkEl.appendChild(line);
        setDetailNextSteps(d);
        currentDetailId = id;
        openDetailModal();
      }

      document.getElementById('detail-threshold-save').addEventListener('click', function() {
        var val = document.getElementById('detail-threshold-input').value.trim();
        if (currentDetailId && detailData[currentDetailId]) {
          var d = detailData[currentDetailId];
          d.threshold = val || d.protocolThreshold;
          d.personalThresholdSet = !!(val && val !== d.protocolThreshold);
          var asteriskEl = document.getElementById('detail-threshold-asterisk');
          if (d.personalThresholdSet) { asteriskEl.classList.remove('hidden'); asteriskEl.setAttribute('aria-hidden', 'false'); }
          else { asteriskEl.classList.add('hidden'); asteriskEl.setAttribute('aria-hidden', 'true'); }
          setDetailDelta(d);
          var psaThreshEl = document.getElementById('detail-psa-threshold');
          if (psaThreshEl) psaThreshEl.textContent = d.threshold || '—';
          var psaThreshFallback = document.getElementById('detail-psa-threshold-fallback');
          if (psaThreshFallback) psaThreshFallback.textContent = d.threshold || '—';
        }
        showToast('Threshold saved.');
      });


      function doDetailDischarge() {
        if (!currentDetailId || !detailData[currentDetailId]) return;
        detailData[currentDetailId].status = 'discharged';
        var listRow = document.querySelector('.list-view tr[data-detail="' + currentDetailId + '"]');
        if (listRow) {
          listRow.setAttribute('data-tab', 'discharged');
          listRow.setAttribute('data-status', 'discharged');
          var badge = listRow.querySelector('.col-status .status-badge');
          if (badge) { badge.textContent = 'Discharged'; badge.className = 'status-badge status-discharged'; }
        }
        var card = document.querySelector('.board .card[data-detail="' + currentDetailId + '"]');
        if (card) card.remove();
        updateListTabCounts();
        showToast('Patient discharged.');
        closeDetailModal();
      }
      function doDetailMoveToStatus(newStatus, targetColumnIndex) {
        if (!currentDetailId || !detailData[currentDetailId]) return;
        var id = currentDetailId;
        var statusByColumn = { 2: 'awaiting', 3: 'completed', 4: 'action', 5: 'action_required' };
        detailData[id].status = newStatus;
        var listRow = document.querySelector('.list-view tr[data-detail="' + id + '"]');
        if (listRow) {
          listRow.setAttribute('data-tab', newStatus);
          listRow.setAttribute('data-status', newStatus);
          var badge = listRow.querySelector('.col-status .status-badge');
          if (badge) { badge.textContent = statusLabels[newStatus] || newStatus; badge.className = 'status-badge status-' + newStatus; }
        }
        var card = document.querySelector('.board .card[data-detail="' + id + '"]');
        if (card) {
          if (targetColumnIndex != null && statusByColumn[targetColumnIndex] === newStatus) {
            var columns = document.querySelectorAll('.board .column');
            var targetCol = columns[targetColumnIndex - 1];
            if (targetCol) {
              var cardsContainer = targetCol.querySelector('.column-cards');
              if (cardsContainer) { cardsContainer.appendChild(card); card.setAttribute('data-status', newStatus); }
            }
          } else if (newStatus === 'recall') {
            card.remove();
          }
        }
        updateListTabCounts();
        var d = detailData[id];
        var statusBadge = document.getElementById('detail-status-badge');
        if (statusBadge) { statusBadge.textContent = statusLabels[d.status] || d.status; statusBadge.className = 'status-badge-detail status-' + d.status; }
        var reqSection = document.getElementById('detail-required-action-section');
        if (newStatus === 'action_required') {
          if (reqSection) {
            reqSection.style.display = '';
            document.getElementById('detail-required-action-display').style.display = 'none';
            document.getElementById('detail-required-action-edit-btn').style.display = 'none';
            document.getElementById('detail-required-action-edit').classList.remove('hidden');
          }
        } else {
          if (!d.required_action && reqSection) reqSection.style.display = 'none';
        }
        setDetailNextSteps(d);
        showToast('Moved to ' + (statusLabels[newStatus] || newStatus) + '.');
      }
      document.getElementById('detail-diagnoses-edit-btn').addEventListener('click', function() {
        document.getElementById('detail-diagnoses-display').style.display = 'none';
        document.getElementById('detail-diagnoses-edit-btn').style.display = 'none';
        document.getElementById('detail-diagnoses-edit').classList.remove('hidden');
      });
      document.getElementById('detail-diagnoses-save').addEventListener('click', function() {
        var val = document.getElementById('detail-diagnoses-input').value.trim();
        if (currentDetailId && detailData[currentDetailId]) {
          detailData[currentDetailId].diagnoses = val;
          document.getElementById('detail-diagnoses-display').textContent = val || '—';
        }
        document.getElementById('detail-diagnoses-edit').classList.add('hidden');
        document.getElementById('detail-diagnoses-display').style.display = '';
        document.getElementById('detail-diagnoses-edit-btn').style.display = '';
        showToast('Diagnoses saved.');
      });

      var detailOwnershipEl = document.getElementById('detail-ownership');
      if (detailOwnershipEl) detailOwnershipEl.addEventListener('change', function() {
        var val = this.value;
        if (currentDetailId && detailData[currentDetailId]) {
          detailData[currentDetailId].ownership = val === 'Urology' ? 'Urology' : 'GP';
          showToast('Ownership updated.');
        }
      });

      var detailPsaScheduleSave = document.getElementById('detail-psa-schedule-save');
      if (detailPsaScheduleSave) detailPsaScheduleSave.addEventListener('click', function() {
        var sel = document.getElementById('detail-psa-schedule');
        if (!sel || !currentDetailId || !detailData[currentDetailId]) return;
        var val = sel.value;
        if (val) {
          detailData[currentDetailId].frequency = val.replace(/-/g, '\u2011');
          showToast('PSA test schedule saved.');
        }
      });
      var detailReviewDischargeEl = document.getElementById('detail-review-discharge');
      if (detailReviewDischargeEl) detailReviewDischargeEl.addEventListener('change', function() {
        if (!currentDetailId || !detailData[currentDetailId]) return;
        var val = this.value;
        detailData[currentDetailId].reviewForDischargeYears = val === '' ? undefined : parseInt(val, 10);
        showToast('Review for discharge updated.');
      });

      document.getElementById('detail-5ari-yes').addEventListener('change', function() {
        var yesEl = document.getElementById('detail-5ari-yes');
        var val = (yesEl && yesEl.checked) ? 'yes' : 'none';
        if (currentDetailId && detailData[currentDetailId]) {
          detailData[currentDetailId].medication5ARI = val;
          showToast('5‑ARI updated.');
        }
      });

      var requiredActionHints = {
        'Urgent Suspected Cancer': 'Urgent suspected cancer referral to urology. Patient should be seen within 2 weeks.',
        'Advice & Guidance': 'Seek specialist advice before deciding on next steps. No direct referral yet.',
        'Repeat PSA': 'Repeat the PSA test to confirm the result before escalating. Retest in 4–6 weeks.',
        'MDT discussion': 'Case to be discussed at the next multidisciplinary team meeting for a consensus plan.',
        'Imaging': 'Imaging requested (e.g. MRI, bone scan) to support clinical decision-making.',
        'GP review': 'Patient to be reviewed by their GP to assess symptoms and determine next steps.'
      };
      document.getElementById('detail-required-action-edit-btn').addEventListener('click', function() {
        document.getElementById('detail-required-action-display').style.display = 'none';
        document.getElementById('detail-required-action-edit-btn').style.display = 'none';
        document.getElementById('detail-required-action-edit').classList.remove('hidden');
      });
      document.getElementById('detail-required-action-save').addEventListener('click', function() {
        var val = document.getElementById('detail-required-action-input').value;
        if (currentDetailId && detailData[currentDetailId]) {
          var d = detailData[currentDetailId];
          d.required_action = val || '';
          var display = document.getElementById('detail-required-action-display');
          var hint = document.getElementById('detail-required-action-hint');
          var section = document.getElementById('detail-required-action-section');
          if (val) {
            display.textContent = val;
            if (hint) hint.textContent = requiredActionHints[val] || '';
            if (section) section.style.display = '';
          } else {
            display.textContent = '—';
            if (hint) hint.textContent = '';
            if (section) section.style.display = 'none';
          }
        }
        document.getElementById('detail-required-action-edit').classList.add('hidden');
        document.getElementById('detail-required-action-display').style.display = '';
        document.getElementById('detail-required-action-edit-btn').style.display = '';
        showToast('Required action saved.');
      });
      document.getElementById('detail-required-action-input').addEventListener('change', function() {
        var hint = document.getElementById('detail-required-action-hint');
        if (hint) hint.textContent = requiredActionHints[this.value] || '';
      });

      document.getElementById('detail-psa-add-new-btn').addEventListener('click', function() {
        document.getElementById('detail-psa-add-toggle-wrap').classList.add('hidden');
        document.getElementById('detail-psa-add-form-wrap').classList.remove('hidden');
        document.body.removeAttribute('data-detail-editing-last');
      });
      document.getElementById('detail-psa-result-close').addEventListener('click', function() {
        document.getElementById('detail-psa-add-toggle-wrap').classList.remove('hidden');
        document.getElementById('detail-psa-add-form-wrap').classList.add('hidden');
        document.body.removeAttribute('data-detail-editing-last');
      });
      document.getElementById('detail-psa-result-save').addEventListener('click', function() {
        var val = document.getElementById('detail-psa-result-input').value.trim();
        var dateVal = document.getElementById('detail-psa-result-date').value;
        if (!currentDetailId || !detailData[currentDetailId]) return;
        var d = detailData[currentDetailId];
        if (!d.psaResults) d.psaResults = [];
        var editingLast = document.body.getAttribute('data-detail-editing-last') === currentDetailId;
        if (editingLast && d.psaResults.length > 0) {
          var byDate = d.psaResults.slice().sort(function(a, b) { return (b.date || '').localeCompare(a.date || ''); });
          var latest = byDate[0];
          var idx = d.psaResults.indexOf(latest);
          if (idx !== -1) {
            d.psaResults[idx] = { date: dateVal || latest.date, value: parseFloat(val, 10) || 0 };
          }
        } else {
          d.psaResults.push({ date: dateVal || new Date().toISOString().slice(0, 10), value: parseFloat(val, 10) || 0 });
        }
        Object.assign(d, derivePsaFromResults(d));
        document.getElementById('detail-psa-add-toggle-wrap').classList.remove('hidden');
        document.getElementById('detail-psa-add-form-wrap').classList.add('hidden');
        document.body.removeAttribute('data-detail-editing-last');
        openDetail(currentDetailId);
        if (d.status === 'awaiting') showToast('Result saved. Choose an action below.');
        else showToast('Result saved.');
      });

      function addActionCard(actionsEl, title, description, actionId, targetColumnIndex, isDischarge) {
        var card = document.createElement('button');
        card.type = 'button';
        card.className = 'action-card' + (isDischarge ? ' action-card-discharge' : '');
        card.setAttribute('data-action', actionId);
        if (targetColumnIndex != null) card.setAttribute('data-target-column', String(targetColumnIndex));
        var titleEl = document.createElement('div');
        titleEl.className = 'action-card-title';
        titleEl.textContent = title;
        card.appendChild(titleEl);
        if (description) {
          var descEl = document.createElement('p');
          descEl.className = 'action-card-desc';
          descEl.textContent = description;
          card.appendChild(descEl);
        }
        card.addEventListener('click', function(e) {
          e.preventDefault();
          if (actionId === 'discharge') { doDetailDischarge(); return; }
          if (actionId === 'remind') { showToast(title); return; }
          if (actionId === 'test-done') { doDetailMoveToStatus('awaiting', 2); return; }
          if (actionId === 'complete') { doDetailMoveToStatus('completed', 3); return; }
          if (actionId === 'review') { doDetailMoveToStatus('action', 4); return; }
          if (actionId === 'move-action-required') { doDetailMoveToStatus('action_required', 5); return; }
          if (actionId === 'move-recall') { doDetailMoveToStatus('recall', null); return; }
        });
        actionsEl.appendChild(card);
      }
      function setDetailNextSteps(d) {
        var actionsEl = document.getElementById('detail-next-steps-actions');
        var dischargeEl = document.getElementById('detail-discharge-actions');
        var dischargeSection = document.getElementById('detail-discharge-section');
        if (!actionsEl) return;
        actionsEl.innerHTML = '';
        if (dischargeEl) dischargeEl.innerHTML = '';
        if (dischargeSection) dischargeSection.style.display = 'none';
        if (d.status === 'upcoming') {
          addActionCard(actionsEl, 'Move to Awaiting Results', '', 'test-done', 2);
        } else if (d.status === 'awaiting') {
          addActionCard(actionsEl, 'Move to Completed', 'Result at or below threshold.', 'complete', 3);
          addActionCard(actionsEl, 'Move to Review Required', 'Result above threshold; needs GP review.', 'review', 4);
        } else if (d.status === 'action') {
          addActionCard(actionsEl, 'Move to Completed', 'Result acceptable (e.g. bounce).', 'complete', 3);
          addActionCard(actionsEl, 'Move to Follow-up Required', 'Record follow-up action (e.g. USC, Advice & guidance).', 'move-action-required', 5);
          addActionCard(actionsEl, 'Move to Recall', 'GP decision: patient is taken back under clinic care. They leave the board and appear in the Recall list.', 'move-recall');
        } else if (d.status === 'completed') {
          addActionCard(actionsEl, 'Move to Recall', 'Send patient back to clinic care before the 7-day auto-move. They appear in the Recall list.', 'move-recall');
        } else if (d.status === 'action_required') {
          addActionCard(actionsEl, 'Move to Recall', 'Follow-up done. Patient returns to the Recall list under clinic care.', 'move-recall');
        } else if (d.status === 'recall') {
          /* no workflow actions */
        }
        if (d.status !== 'discharged' && dischargeEl && dischargeSection) {
          dischargeSection.style.display = '';
          addActionCard(dischargeEl, 'Discharge', 'Remove from the active monitoring list. Record kept for audit.', 'discharge', null, true);
        }
      }

      document.querySelectorAll('.card[data-detail]').forEach(function(card) {
        card.addEventListener('click', function(e) {
          if (e.target.closest('button')) return;
          openDetail(card.getAttribute('data-detail'));
        });
      });
      document.querySelectorAll('.list-view tbody tr[data-detail]').forEach(function(row) {
        row.addEventListener('click', function() { openDetail(row.getAttribute('data-detail')); });
      });

      // Card 3-dot actions menu. Board columns: 1=Upcoming, 2=Awaiting Results, 3=Completed, 4=Review Required, 5=Follow-up Required. Recall/Discharged not on board.
      function getActionsForStatus(status) {
        var viewDetails = { label: 'View details', actionId: 'view-patient' };
        if (status === 'upcoming') return [
          viewDetails,
          { label: 'Move to Awaiting Results', actionId: 'test-done', targetColumnIndex: 2 },
          { label: 'Send reminder', actionId: 'remind' }
        ];
        if (status === 'awaiting') return [
          viewDetails,
          { label: 'Move to Completed', actionId: 'complete', targetColumnIndex: 3 },
          { label: 'Move to Review Required', actionId: 'review', targetColumnIndex: 4 }
        ];
        if (status === 'action') return [
          viewDetails,
          { label: 'Move to Completed', actionId: 'complete', targetColumnIndex: 3 },
          { label: 'Move to Follow-up Required', actionId: 'move-action-required', targetColumnIndex: 5 },
          { label: 'Move to Recall', actionId: 'move-recall-off-board' },
          { label: 'Discharge', actionId: 'discharge-off-board' }
        ];
        if (status === 'action_required') return [
          viewDetails,
          { label: 'Move to Recall', actionId: 'move-recall-off-board' },
          { label: 'Discharge', actionId: 'discharge-off-board' }
        ];
        if (status === 'completed') return [
          viewDetails,
          { label: 'Move to Recall', actionId: 'move-recall-off-board' }
        ];
        if (status === 'recall') return [ viewDetails, { label: 'Discharge', actionId: 'discharge-off-board' } ];
        return [viewDetails];
      }
      var cardActionsDropdown = document.getElementById('card-actions-dropdown');
      var cardActionsCard = null;
      function closeCardActionsDropdown() {
        if (cardActionsDropdown) cardActionsDropdown.classList.remove('show');
        cardActionsCard = null;
        document.removeEventListener('click', cardActionsOutsideHandler);
      }
      function cardActionsOutsideHandler(e) {
        if (cardActionsDropdown && (cardActionsDropdown.contains(e.target) || (e.target && e.target.closest && e.target.closest('.card-actions-menu-btn')))) return;
        closeCardActionsDropdown();
      }
      document.body.addEventListener('click', function(e) {
        var btn = e.target.closest('.card-actions-menu-btn');
        if (!btn) return;
        e.preventDefault();
        e.stopPropagation();
        var card = btn.closest('.card');
        if (!card || !cardActionsDropdown) return;
        var status = card.getAttribute('data-status');
          var actions = getActionsForStatus(status);
          cardActionsCard = card;
          cardActionsDropdown.innerHTML = '';
          if (actions.length === 0) {
            var empty = document.createElement('div');
            empty.className = 'dropdown-title';
            empty.textContent = 'No actions';
            cardActionsDropdown.appendChild(empty);
          } else {
            actions.forEach(function(a) {
              var b = document.createElement('button');
              b.type = 'button';
              b.textContent = a.label;
              b.setAttribute('data-action-id', a.actionId);
              if (a.targetColumnIndex != null) b.setAttribute('data-target-column', String(a.targetColumnIndex));
              b.addEventListener('click', function(ev) {
                ev.preventDefault();
                if ((a.actionId === 'view-patient' || a.actionId === 'edit-details') && cardActionsCard) {
                  openDetail(cardActionsCard.getAttribute('data-detail'));
                } else if ((a.actionId === 'move-recall-off-board' || a.actionId === 'discharge-off-board') && cardActionsCard) {
                  var id = cardActionsCard.getAttribute('data-detail');
                  if (detailData[id]) {
                    detailData[id].status = a.actionId === 'discharge-off-board' ? 'discharged' : 'recall';
                    var listRow = document.querySelector('.list-view tr[data-detail="' + id + '"]');
                    if (listRow) {
                      listRow.setAttribute('data-tab', detailData[id].status);
                      listRow.setAttribute('data-status', detailData[id].status);
                      var badge = listRow.querySelector('.col-status .status-badge');
                      if (badge) { badge.textContent = statusLabels[detailData[id].status] || detailData[id].status; badge.className = 'status-badge status-' + detailData[id].status; }
                    }
                    cardActionsCard.remove();
                    updateListTabCounts();
                  }
                  showToast(a.label);
                } else {
                  showToast(a.label);
                  var colIndex = a.targetColumnIndex;
                  if (colIndex != null && cardActionsCard) {
                    var columns = document.querySelectorAll('.board .column');
                    var targetCol = columns[colIndex - 1];
                    if (targetCol) {
                      var cardsContainer = targetCol.querySelector('.column-cards');
                      if (cardsContainer) {
                        cardsContainer.appendChild(cardActionsCard);
                        var statusByColumn = { 1: 'upcoming', 2: 'awaiting', 3: 'completed', 4: 'action', 5: 'action_required' };
                        var newStatus = statusByColumn[colIndex] || cardActionsCard.getAttribute('data-status');
                        cardActionsCard.setAttribute('data-status', newStatus);
                        var id = cardActionsCard.getAttribute('data-detail');
                        if (detailData[id]) {
                          detailData[id].status = newStatus;
                          var listRow = document.querySelector('.list-view tr[data-detail="' + id + '"]');
                          if (listRow) {
                            listRow.setAttribute('data-tab', newStatus);
                            listRow.setAttribute('data-status', newStatus);
                            var badge = listRow.querySelector('.col-status .status-badge');
                            if (badge) { badge.textContent = statusLabels[newStatus] || newStatus; badge.className = 'status-badge status-' + newStatus; }
                          }
                        }
                        updateListTabCounts();
                      }
                    }
                  }
                }
                closeCardActionsDropdown();
              });
              cardActionsDropdown.appendChild(b);
            });
          }
          var rect = btn.getBoundingClientRect();
          cardActionsDropdown.style.left = rect.left + 'px';
          cardActionsDropdown.style.top = (rect.bottom + 4) + 'px';
          cardActionsDropdown.classList.add('show');
          setTimeout(function() { document.addEventListener('click', cardActionsOutsideHandler); }, 0);
      }, true);

      // Detail modal close
      on(document.getElementById('detail-close'), 'click', function(e) { e.preventDefault(); closeDetailModal(); });
      if (viewDetail) viewDetail.addEventListener('click', function(e) { if (e.target === viewDetail) closeDetailModal(); });
    })();
  </script>
</body>
</html>
